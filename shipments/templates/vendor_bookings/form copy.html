{% extends "adminbase.html" %}
{% load static %}

{% block content %}
{% if form.errors %}
  <div class="alert alert-danger py-2">
    <div class="fw-semibold mb-1">Form invalid:</div>
    {{ form.errors }}
  </div>
{% endif %}

{% if form.non_field_errors %}
  <div class="alert alert-danger py-2">
    {{ form.non_field_errors }}
  </div>
{% endif %}
<!-- DEBUG_TEMPLATE: vendor_bookings/form.html -->

<div class="app-content-header">
  <div class="container-fluid">
    <div class="d-flex align-items-start justify-content-between gap-2 flex-wrap">
      
      {% if object and object.pk %}
      {% if object.last_synced_at %}
        <span class="badge text-bg-light border">
          Synced: {{ object.last_synced_at|date:"Y-m-d H:i" }}
        </span>
      {% else %}
        <span class="badge text-bg-warning">Not synced</span>
      {% endif %}
    {% endif %}
        
    {% if object and object.pk and object.status == 'DRAFT' %}
  <form method="post" action="{% url 'shipments:vendor_booking_sync' object.pk %}" class="d-inline">
    {% csrf_token %}
    <button class="btn btn-outline-primary btn-sm" type="submit">
      <i class="bi bi-arrow-repeat me-1"></i> Sync Now
    </button>
  </form>
{% endif %}
{% if object and object.pk %}
  {% with jc_updated=object.job_cost_last_update %}
    {% if object.last_synced_at and jc_updated and jc_updated > object.last_synced_at %}
      <span class="badge text-bg-danger"
            title="Job Cost changed after last sync. Click Sync Now.">
        Job Cost Changed
      </span>
    {% endif %}
  {% endwith %}
{% endif %}

{% if object and object.pk and object.status == 'CONFIRMED' %}
  <a class="btn btn-outline-dark btn-sm"
     href="{% url 'shipments:vendor_booking_print' object.pk %}"
     target="_blank">
    <i class="bi bi-printer me-1"></i> Print
  </a>
{% endif %}

      <!-- LEFT: TITLE -->
      <div>
        <div class="d-flex align-items-center gap-2 flex-wrap">
          <h3 class="mb-0">Vendor Booking</h3>

          {% if object and object.pk %}
            <span class="badge text-bg-primary">{{ object.status }}</span>
            {% if object.vb_number %}<span class="badge text-bg-light border">VBO: {{ object.vb_number }}</span>{% endif %}
            {% if object.letter_number %}<span class="badge text-bg-light border">PO: {{ object.letter_number }}</span>{% endif %}
          {% else %}
            <span class="badge text-bg-success">Create</span>
          {% endif %}
        </div>
        <div class="text-muted small">
          Lines are read-only and always based on Job Cost (Cost Group / Cost Type).
        </div>
      </div>

       <button type="button"
            id="vpBtnSync"
            class="btn btn-outline-primary btn-sm"
            disabled>
      <i class="bi bi-arrow-repeat me-1"></i> Sync
    </button>
      <!-- RIGHT: ACTIONS -->
      <div class="d-flex align-items-center gap-2">
        <a href="#"
        class="btn btn-outline-secondary btn-sm">
        <i class="bi bi-arrow-left me-1"></i> Back
      </a>



        <button form="vb-form" type="submit" class="btn btn-primary btn-sm">
          <i class="bi bi-save me-1"></i> Save
        </button>

        {% if object and object.pk %}
          <form method="post" action="{% url 'shipments:vendor_booking_confirm' object.pk %}" class="d-inline">
            {% csrf_token %}
            <button class="btn btn-outline-success btn-sm" {% if object.status != "DRAFT" %}disabled{% endif %}>
              <i class="bi bi-check2-circle me-1"></i> Confirm
            </button>
          </form>

          <form method="post" action="{% url 'shipments:vendor_booking_cancel' object.pk %}" class="d-inline">
            {% csrf_token %}
            <button class="btn btn-outline-danger btn-sm">
              <i class="bi bi-x-circle me-1"></i> Cancel
            </button>
          </form>
        {% endif %}
      </div>

    </div>
  </div>
</div>

<div class="app-content">
  <div class="container-fluid">

    <form id="vb-form" method="post" novalidate>
      {% csrf_token %}

      <!-- HEADER CARD (COMPACT) -->
      <div class="card shadow-sm mb-3">
        <div class="card-body py-2">
          <div class="row g-2">
            <!-- Job order (readonly display) -->
            <div class="col-lg-4">
              <label class="form-label small mb-1">Job Order</label>
              <div class="form-control form-control-sm bg-light">
                {% if job %}#{{ job.number }}{% else %}-{% endif %}
              </div>
              {# keep hidden job_order input if exists #}
              {% if form.job_order %}<div class="d-none">{{ form.job_order }}</div>{% endif %}
            </div>

            <div class="col-lg-2 col-md-4">
              <label class="form-label small mb-1">Booking Group</label>
              {{ form.booking_group }}
              {% if form.booking_group.errors %}
                <div class="text-danger small">{{ form.booking_group.errors|striptags }}</div>
              {% endif %}
            </div>

            <div class="col-lg-3 col-md-4">
              <label class="form-label small mb-1">Vendor</label>
              {{ form.vendor }}
              {% if form.vendor.errors %}
                <div class="text-danger small">{{ form.vendor.errors|striptags }}</div>
              {% endif %}
            </div>

            <div class="col-lg-3 col-md-4">
              <label class="form-label small mb-1">Reference No</label>
              {{ form.reference_no }}
              {% if form.reference_no.errors %}
                <div class="text-danger small">{{ form.reference_no.errors|striptags }}</div>
              {% endif %}
            </div>
          </div>

          <hr class="my-2">

          <!-- PAYMENT / CURRENCY GROUP -->
          <div class="row g-2 align-items-end">
            <div class="col-lg-3 col-md-4">
              <label class="form-label small mb-1">Payment Term</label>
              {{ form.payment_term }}
            </div>

            <div class="col-lg-2 col-md-3">
              <label class="form-label small mb-1">Currency</label>
              {{ form.currency }}
            </div>

            <div class="col-lg-2 col-md-3">
              <label class="form-label small mb-1">IDR Rate</label>
              {{ form.idr_rate }}
            </div>

            <div class="col-lg-2 col-md-2">
              <label class="form-label small mb-1">Discount</label>
              {{ form.discount }}
            </div>

            <div class="col-lg-3 col-md-12 text-end">
              {% if object and object.pk %}
                <span class="badge text-bg-light border">Lines: {{  vb.lines.all|length }}</span>
              {% endif %}
            </div>
          </div>
        </div>
      </div>

      <!-- TABS -->
      <div class="card shadow-sm">
        <div class="card-header py-2">
          <ul class="nav nav-tabs card-header-tabs" role="tablist">
            <li class="nav-item">
              <a class="nav-link active" data-bs-toggle="tab" href="#tab-lines" role="tab">
                Lines (Job Cost)
              </a>
            </li>
            <li class="nav-item">
              <a class="nav-link" data-bs-toggle="tab" href="#tab-header" role="tab">
                Header Detail
              </a>
            </li>
          </ul>
        </div>

        <div class="card-body p-2">
          <div class="tab-content">

            <!-- TAB 1: LINES -->
            <div class="tab-pane fade show active" id="tab-lines" role="tabpanel">
              {% include "vendor_bookings/extensions/vb_tab_line.html" %}
            </div>

            <!-- TAB 2: HEADER DETAIL (DYNAMIC) -->
            <div class="tab-pane fade" id="tab-header" role="tabpanel">
              {% include "vendor_bookings/extensions/vb_tab_header.html" %}
            </div>

          </div>
        </div>
      </div>

    </form>
  </div>
</div>
{% endblock %}


{% block extra_css %}

<style>
  .table.table-sm td, .table.table-sm th { padding-top: .35rem; padding-bottom: .35rem; }
  .form-control-sm, .form-select-sm { min-height: 31px; }
</style>

{% endblock %}

{% block extra_js %}

<script src="{% static 'js/idr_rate.js' %}"></script>

<script>
(function(){
  function val(id){ var el=document.getElementById(id); return el? (el.value||"") : ""; }

  function toggleHeaderSections(){
    var group = val("id_booking_group").toUpperCase();
    document.querySelectorAll("[data-vb-group]").forEach(function(sec){
      var need = (sec.getAttribute("data-vb-group")||"").toUpperCase();
      if (!need || need === "ALL") { sec.classList.remove("d-none"); return; }
      sec.classList.toggle("d-none", need !== group);
    });
  }

  document.addEventListener("DOMContentLoaded", function(){
    toggleHeaderSections();
    var bg = document.getElementById("id_booking_group");
    if (bg) bg.addEventListener("change", toggleHeaderSections);
  });
})();
</script>
{% endblock %}


