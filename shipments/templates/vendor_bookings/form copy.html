{% extends "adminbase.html" %}
{% load static %}

{% block content %}

<div class="app-content-header">
  <div class="container-fluid d-flex flex-wrap gap-2 justify-content-between align-items-center">
    <div>
      <h4 class="mb-0">Vendor Booking</h4>
      <div class="small text-muted">
        Job Order: <span class="fw-semibold">{{ vb.job_order }}</span>
        Â· Vendor: <span class="fw-semibold">{{ vb.vendor }}</span>
      </div>
    </div>

    <div class="d-flex flex-wrap gap-2 align-items-center">
      {% if vb.status == "CONFIRMED" %}
        <span class="badge text-bg-success">CONFIRMED</span>
      {% else %}
        <span class="badge text-bg-secondary">DRAFT</span>
      {% endif %}

      <a class="btn btn-outline-secondary btn-sm"
         href="{% url 'shipments:vendor_booking_from_jobcost' %}?job_order={{ vb.job_order_id }}">
        Back
      </a>

      <a class="btn btn-outline-primary btn-sm"
         href="{% url 'shipments:vendor_booking_print' vb.id %}"
         target="_blank">
        Print {% if vb.status == "DRAFT" %}<span class="ms-1 badge text-bg-warning">DRAFT</span>{% endif %}
      </a>

      {% if vb.status == "DRAFT" %}
        <form method="post" action="{% url 'shipments:vendor_booking_confirm' vb.id %}" class="d-inline">
          {% csrf_token %}
          <button class="btn btn-primary btn-sm" type="submit">
            Confirm
          </button>
        </form>
      {% endif %}
    </div>
  </div>
</div>

<div class="app-content">
  <div class="container-fluid">

    <form method="post" class="card">
      {% csrf_token %}
      <div class="card-body p-2">

        <div class="row g-2 mb-2">
          <div class="col-md-3">
            <label class="form-label small mb-1">Currency</label>
            {{ form.currency }}
          </div>
          <div class="col-md-3">
            <label class="form-label small mb-1">IDR Rate</label>
             {{ form.idr_rate }}
            <div class="small text-muted mt-1 js-idfmt-fixed3" data-source="{{ form.idr_rate.id_for_label }}"></div>

          </div>
          
            
        
        </div>

      

        <hr class="my-2">

        {{ formset.management_form }}

        <div class="table-responsive">
          <table class="table table-sm table-worksheet table-bordered mb-0">
            <thead class="table-light">
              <tr>
                <th style="width:220px">Cost Lines</th>
                <th style="width:110px" class="text-end">Qty</th>
                <th style="width:90px">Unit</th>
                <th style="width:140px" class="text-end">Unit Price</th>
                <th style="width:220px">Taxes</th>
                <th style="width:140px" class="text-end">Amount</th>
                
              </tr>
            </thead>
            <tbody>
              {% for f in formset.forms %}
                {% with line=f.instance %}
                <tr>
                  <td class="fw-semibold">
                    {% if line.cost_type_id %}{{ line.cost_type.name }}{% else %}-{% endif %}
                  </td>
                 
                 

                  <td class="text-end">{{ f.qty }}</td>
                    <td>{{ f.uom }}</td>
                
                  <td class="text-end">
                    {{ f.unit_price }}
                
                  </td>

                  <td class="text-end">
                    <input class="form-control form-control-sm text-end" value="{{ line.amount }}" readonly>
                  </td>

                      <td>
                      {{ f.taxes }}
                      <div class="mt-1 d-flex flex-wrap gap-1 js-tax-badges" data-source="{{ f.taxes.id_for_label }}"></div>
                    </td>

                </tr>
                {% endwith %}
              {% empty %}
                <tr><td colspan="8" class="text-muted">No lines.</td></tr>
              {% endfor %}
              <tfoot class="table-light">
  <tr>
    <!-- âœ… span 5 untuk label subtotal -->
    <th colspan="5" class="text-end">Sub Total</th>
    <th class="text-end">{{ totals.subtotal }}</th>
    
  </tr>
  <tr>
    <th colspan="5" class="text-end">Tax Amount</th>
    <th class="text-end">{{ totals.tax_total }}</th>
      </tr>
  <tr>
    <!-- âœ… PPh / WHT rate tidak ditampilkan -->
    <th colspan="5" class="text-end">PPh (WHT)</th>
    <th class="text-end">{{ totals.wht_amount }}</th>
    
  </tr>
  <tr>
    <th colspan="5" class="text-end fw-bold">Total</th>
    <th class="text-end fw-bold">{{ totals.total_amount }}</th>
    
  </tr>
</tfoot>

            </tbody>
          </table>
        </div>

      </div>
      {% if vb_group %}
  <hr class="my-2">
  <div class="p-2">
    <div class="fw-semibold mb-2">Additional Info ({{ vb_group }})</div>

    {% if letter_type == "SI" %}
      {% include "vendor_bookings/partials/form_si.html" %}
    {% elif letter_type == "SLI" %}
      {% include "vendor_bookings/partials/form_sli.html" %}
    {% elif letter_type == "SO" %}
      {% include "vendor_bookings/partials/form_so.html" %}
    {% else %}
      {% include "vendor_bookings/partials/form_wo.html" %}
    {% endif %}
  </div>
{% endif %}

      {% if vb.status == "DRAFT" %}
      <div class="card-footer d-flex justify-content-end gap-2">
        <button class="btn btn-primary btn-sm" type="submit">Save</button>
      </div>
      {% endif %}
    </form>

  </div>
</div>

{% endblock %}

{% block extra_css%}

<style>
.tax-pill{
  display:inline-block;
  padding:2px 8px;
  border-radius:999px;
  font-size:12px;
  border:1px solid rgba(0,0,0,.15);
  background:rgba(0,0,0,.03);
}
</style>
<style>
/* worksheet table */
.table-worksheet { font-size: 13px; }
.table-worksheet td, .table-worksheet th { padding: 0.15rem 0.25rem !important; vertical-align: top; }
.table-worksheet thead th { font-weight: 600; }

/* inputs look like worksheet */
.ws-input, .ws-select {
  border: 0 !important;
  background: transparent !important;
  box-shadow: none !important;
  padding: 0 !important;
  height: auto !important;
  line-height: 1.2 !important;
}
.ws-input:focus, .ws-select:focus {
  outline: none !important;
  box-shadow: none !important;
}

/* readonly amount cell */
.ws-readonly {
  border: 0 !important;
  background: transparent !important;
  padding: 0 !important;
  text-align: right;
}

/* taxes pills tighter */
.tax-pill{
  display:inline-block;
  padding:1px 6px;
  border-radius:999px;
  font-size:12px;
  border:1px solid rgba(0,0,0,.15);
  background:rgba(0,0,0,.03);
}

.table-worksheet {
  font-size: 13px;
  border-collapse: collapse;
}

.table-worksheet th,
.table-worksheet td {
  padding: 0.15rem 0.25rem !important; /* ðŸ‘ˆ rapat */
  vertical-align: top !important;
}

.table-worksheet tr {
  height: auto !important;
}

.table-worksheet tbody tr {
  line-height: 1.2 !important;
}

/* input worksheet (tanpa border & padding) */
.table-worksheet .ws-input,
.table-worksheet .ws-select {
  padding: 0 !important;
  margin: 0 !important;
  border: 0 !important;
  background: transparent !important;
  height: auto !important;
  min-height: unset !important;
  line-height: 1.2 !important;
  box-shadow: none !important;
}

/* focus tetap bersih */
.table-worksheet .ws-input:focus,
.table-worksheet .ws-select:focus {
  outline: none !important;
  box-shadow: none !important;
}



</style>
<link rel="stylesheet" href="{% static 'vendor/css/select2.min.css' %}">

{% endblock %}


{% block extra_js%}

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<script src="{% static 'js/idr_rate.js' %}">  </script>
<script src="{% static 'vendor/js/select2.full.min.js' %}"> </script>
<script src="{% static 'js/tax_select2.js' %}"> </script>


<script>
  document.addEventListener("DOMContentLoaded", function(){
    if (window.initTaxSelect2) window.initTaxSelect2(document);
  });
</script>

<script>
(function(){
  function fmtID(n){
    const x = Number(n || 0);
    if (Number.isNaN(x)) return "";
    return x.toLocaleString("id-ID", { maximumFractionDigits: 6 });
  }

  function bind(){
    document.querySelectorAll(".js-idfmt").forEach(function(el){
      const srcId = el.getAttribute("data-source");
      const inp = document.getElementById(srcId);
      if(!inp) return;

      function render(){
        el.textContent = fmtID(inp.value);
      }
      inp.addEventListener("input", render);
      render();
    });
     function bindFixed3(){
    document.querySelectorAll(".js-idfmt-fixed3").forEach(function(el){
      const srcId = el.getAttribute("data-source");
      const inp = document.getElementById(srcId);
      if(!inp) return;

      function render(){
        el.textContent = fmtIDFixed(inp.value, 3);
      }
      inp.addEventListener("input", render);
      render();
    });
  }
  }

  document.addEventListener("DOMContentLoaded", bind);
})();
</script>

<script>
(function(){
  function rebuildBadges(selectEl, holder){
    holder.innerHTML = "";
    const selected = Array.from(selectEl.selectedOptions || []);
    selected.forEach(function(opt){
      const pill = document.createElement("span");
      pill.className = "tax-pill";
      pill.textContent = (opt.textContent || "").trim();
      holder.appendChild(pill);
    });
  }

  function bindTaxBadges(scope){
    const root = scope || document;
    root.querySelectorAll(".js-tax-badges").forEach(function(holder){
      const srcId = holder.getAttribute("data-source");
      const sel = document.getElementById(srcId);
      if(!sel) return;

      sel.addEventListener("change", function(){
        rebuildBadges(sel, holder);
      });
      rebuildBadges(sel, holder);
    });
  }

  document.addEventListener("DOMContentLoaded", function(){
    bindTaxBadges(document);
  });
})();
</script>
<script>
(function(){
  // ---- helpers ----
  function onlyDigitsCommaDot(s){
    return (s || "").replace(/[^\d.,-]/g, "");
  }

  // Convert "1.234.567,890" -> "1234567.890"
  function idToPlainNumber(s){
    s = onlyDigitsCommaDot(s);
    // remove thousands dots, convert decimal comma to dot
    // "1.234.567,89" -> "1234567.89"
    s = s.replace(/\./g, "").replace(",", ".");
    return s;
  }

  // Convert plain "1234567.89" -> "1.234.567,890" (fixed 3)
  function plainToId(s, digits){
    const x = Number(s);
    if (!isFinite(x)) return "";
    return x.toLocaleString("id-ID", {
      minimumFractionDigits: digits,
      maximumFractionDigits: digits
    });
  }

  function bindOneInputFormat(){
    // unit_price: fixed 0/2/3? -> kita pakai 0 untuk price? om minta semua angka, biasanya 0 atau 2.
    // karena om minta "rate 3 koma", unit_price bisa 0/2. Aku set 0 dulu. Kalau mau 2, bilang.
    const priceDigits = 0;
    const qtyDigits = 3;

    document.querySelectorAll("input.js-idmoney").forEach(function(inp){
      inp.addEventListener("focus", function(){
        // saat fokus, normalize ke plain supaya gampang edit
        const plain = idToPlainNumber(inp.value);
        inp.value = plain;
      });
      inp.addEventListener("blur", function(){
        const plain = idToPlainNumber(inp.value);
        inp.value = plain ? plainToId(plain, priceDigits) : "";
      });
    });

    document.querySelectorAll("input.js-idqty").forEach(function(inp){
      inp.addEventListener("focus", function(){
        const plain = idToPlainNumber(inp.value);
        inp.value = plain;
      });
      inp.addEventListener("blur", function(){
        const plain = idToPlainNumber(inp.value);
        inp.value = plain ? plainToId(plain, qtyDigits) : "";
      });
    });

    // sebelum submit: pastikan semua balik ke plain number (biar Django DecimalField aman)
    const form = document.querySelector("form");
    if(form){
      form.addEventListener("submit", function(){
        document.querySelectorAll("input.js-idmoney, input.js-idqty").forEach(function(inp){
          inp.value = idToPlainNumber(inp.value);
        });
      });
    }
  }

  document.addEventListener("DOMContentLoaded", bindOneInputFormat);
})();
</script>

{% endblock %}