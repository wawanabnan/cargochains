{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="card shadow-sm border-0">
  <div class="card-header bg-white d-flex justify-content-between align-items-center flex-wrap gap-2">
    <div>
      <h5 class="mb-0">Shipment #{{ s.number|default:"(draft)" }}</h5>
      <small class="text-muted">Status: {{ s.status }}</small>
    </div>
    <div class="d-flex gap-2">
      <a href="{% url 'shipments:list' %}" class="btn btn-outline-secondary btn-sm">Back</a>
    </div>
  </div>

  <div class="card-body">
    <!-- HEADER SUMMARY -->
    <div class="row g-2 mb-3">
      <div class="col-md-3"><strong>Origin</strong><div>{{ s.origin }}{% if s.origin_text %} ({{s.origin_text}}){% endif %}</div></div>
      <div class="col-md-3"><strong>Destination</strong><div>{{ s.destination }}{% if s.destination_text %} ({{s.destination_text}}){% endif %}</div></div>
      <div class="col-md-3"><strong>ETD / ETA</strong><div>{{ s.etd }} â†’ {{ s.eta }}</div></div>
      <div class="col-md-3"><strong>Shipper / Consignee</strong><div>{{ s.shipper }} / {{ s.consignee }}</div></div>
      <div class="col-md-3"><strong>Carrier / Agency</strong><div>{{ s.carrier }} / {{ s.agency }}</div></div>
      <div class="col-md-3"><strong>B/L No</strong><div>{{ s.bill_of_lading_no|default:"-" }}</div></div>
      <div class="col-md-3"><strong>Qty / Wt / Vol</strong><div>{{ s.qty|default:"-" }} / {{ s.weight|default:"-" }} / {{ s.volume|default:"-" }}</div></div>
      <div class="col-md-12"><strong>Cargo</strong><div>{{ s.cargo_description|default:"-" }}</div></div>
    </div>

    <!-- TABS -->
    <ul class="nav nav-tabs" id="shipTabs" role="tablist">
      <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-routes" type="button">Routes</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-transport" type="button">Transportation Types</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-docs" type="button">Documents</button></li>
      <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-logs" type="button">Logs</button></li>
    </ul>

    <div class="tab-content pt-3">
      <!-- ROUTES -->
      <div class="tab-pane fade show active" id="tab-routes">
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead><tr><th>#</th><th>Origin</th><th>Destination</th><th>Transportation</th><th>Created</th></tr></thead>
            <tbody>
              {% for r in routes %}
              <tr>
                <td>{{ forloop.counter }}</td>
                <td>{{ r.origin }}</td>
                <td>{{ r.destination }}</td>
                <td>{{ r.transportation_type.name }} ({{ r.transportation_type.transportation_mode }})</td>
                <td>{{ r.created_at|date:"Y-m-d H:i" }}</td>
              </tr>
              {% empty %}<tr><td colspan="5" class="text-muted">No routes.</td></tr>{% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <!-- TRANSPORT TYPES -->
      <div class="tab-pane fade" id="tab-transport">
        <div class="table-responsive">
          <table class="table table-sm">
            <thead><tr><th>#</th><th>Name</th><th>Mode</th><th>Created</th></tr></thead>
            <tbody>
              {% for t in transport_qs %}
              <tr><td>{{ forloop.counter }}</td><td>{{ t.name }}</td><td>{{ t.transportation_mode }}</td><td>{{ t.created_at|date:"Y-m-d H:i" }}</td></tr>
              {% empty %}<tr><td colspan="4" class="text-muted">No transportation types.</td></tr>{% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <!-- DOCUMENTS -->
      <div class="tab-pane fade" id="tab-docs">
        <div class="table-responsive">
          <table class="table table-sm">
            <thead><tr><th>#</th><th>Type</th><th>Path</th><th>Note</th><th>Created</th></tr></thead>
            <tbody>
              {% for d in docs %}
              <tr>
                <td>{{ forloop.counter }}</td>
                <td>{{ d.doc_type }}</td>
                <td><code>{{ d.file_path }}</code></td>
                <td>{{ d.note|default:"-" }}</td>
                <td>{{ d.created_at|date:"Y-m-d H:i" }}</td>
              </tr>
              {% empty %}<tr><td colspan="5" class="text-muted">No documents.</td></tr>{% endfor %}
            </tbody>
          </table>
        </div>
      </div>

      <!-- LOGS -->
      <div class="tab-pane fade" id="tab-logs">
        <div class="table-responsive">
          <table class="table table-sm">
            <thead><tr><th>When</th><th>Status</th><th>User</th><th>Note</th></tr></thead>
            <tbody>
              {% for lg in logs %}
              <tr>
                <td>{{ lg.event_time|default:lg.recorded_at|date:"Y-m-d H:i" }}</td>
                <td>{{ lg.status }}</td>
                <td>{{ lg.user }}</td>
                <td>{{ lg.note|default:"-" }}</td>
              </tr>
              {% empty %}<tr><td colspan="4" class="text-muted">No logs.</td></tr>{% endfor %}
            </tbody>
          </table>
        </div>

        <!-- quick add log -->
        <form method="post" action="{% url 'shipments:add_log' s.pk %}" class="mt-3">
          {% csrf_token %}
          <div class="row g-2 align-items-end">
            <div class="col-md-3">
              <label class="form-label">Status</label>
              <select class="form-select form-select-sm" name="status" required>
              {% for st in STATUSES %}
                <option value="{{ st }}">{{ st }}</option>
              {% endfor %}
            </select>

            </div>
            <div class="col-md-3">
              <label class="form-label">Event Time</label>
              <input type="datetime-local" name="event_time" class="form-control form-control-sm">
            </div>
            <div class="col-md-4">
              <label class="form-label">Note</label>
              <input type="text" name="note" class="form-control form-control-sm" placeholder="Optional note">
            </div>
            <div class="col-md-2">
              <button class="btn btn-primary btn-sm w-100">Add Log</button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}
<script>
document.addEventListener('shown.bs.tab', e => history.replaceState(null, '', e.target.dataset.bsTarget));
const target = location.hash && document.querySelector(`button[data-bs-target="${location.hash}"]`);
if (target) new bootstrap.Tab(target).show();
</script>
