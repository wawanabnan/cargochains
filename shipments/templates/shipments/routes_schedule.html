{% extends "base.html" %}

{% block title %}Shipment Routes Schedule{% endblock %}

{% block content %}
<style>
.table td, .table th { border:0 !important; }
.form-control, .form-select { border:0 !important; box-shadow:none !important; }
.form-control:focus, .form-select:focus { box-shadow:none !important; }
</style>


<section class="content">
  <div class="container-fluid">
    <div class="card shadow-sm">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h3 class="card-title mb-0">Shipment Routes Schedule</h3>
        <a class="btn btn-sm btn-outline-secondary"
           href="{% url 'shipments:routes_schedule_export' %}?customer_id={{filters.customer_id}}&customer_q={{filters.customer_q}}&booking={{filters.booking}}&date_from={{filters.date_from}}&date_to={{filters.date_to}}">
          Export CSV
        </a>
      </div>

      <div class="card-body">
        <form method="get" class="row g-2 align-items-end">
          <div class="col-sm-3">
            <label class="form-label">Customer</label>
            <input type="hidden" name="customer_id" id="id_customer_id" value="{{ filters.customer_id }}">
            <input type="text" name="customer_q" id="id_customer_q" value="{{ filters.customer_q }}" placeholder="Type name/code..."
                   class="form-control form-control-sm">
          </div>
          <div class="col-sm-3">
            <label class="form-label">Booking No</label>
            <input type="text" name="booking" value="{{ filters.booking }}" class="form-control form-control-sm" placeholder="Booking/SO number">
          </div>
          <div class="col-sm-2">
            <label class="form-label">From (ETD ≥)</label>
            <input type="date" name="date_from" value="{{ filters.date_from }}" class="form-control form-control-sm">
          </div>
          <div class="col-sm-2">
            <label class="form-label">To (ETA ≤)</label>
            <input type="date" name="date_to" value="{{ filters.date_to }}" class="form-control form-control-sm">
          </div>
          <div class="col-sm-2">
            <button class="btn btn-success btn-sm w-100">Filter</button>
          </div>
        </form>
      </div>

      <div class="table-responsive">
        <table class="table table-sm table-borderless align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th>Booking</th>
              <th>Shipment</th>
              <th>Customer</th>
              <th>#</th>
              <th>Origin</th>
              <th>Destination</th>
              <th>ETD</th>
              <th>ETA</th>
              <th>Type</th>
              <th>Asset</th>
              <th>Status</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            {% for r in page_obj.object_list %}
            <tr>
              <td>{% firstof r.shipment.booking_ref "-" %}</td>              
              <td><a href="{{ r.shipment.get_absolute_url }}">{{ r.shipment.number }}</a></td>
              <td>{{ r.shipment.shipper.name|default:"-" }}</td>
              <td class="text-muted">{{ r.order|default:"-" }}</td>
              <td>{% firstof r.origin_text r.origin.name "-" %}</td>
              <td>{% firstof r.destination_text r.destination.name "-" %}</td>
              <td>{{ r.planned_departure|date:"Y-m-d H:i" }}</td>
              <td>{{ r.planned_arrival|date:"Y-m-d H:i" }}</td>
              <td>{% firstof r.transportation_type_text r.transportation_type.name "-" %}</td>
              <td>{% firstof r.transportation_asset_text r.transportation_asset.identifier "-" %}</td>
              <td>{{ r.status|default:"-" }}</td>
              <td>
 <!-- tombol edit dan delete -->
         <button class="btn btn-outline-secondary btn-sm js-edit-route"
        data-url="{% url 'shipments:shipment_route_edit_modal' r.shipment_id r.id %}">
  Edit
</button>


<button class="btn btn-outline-danger btn-sm js-del-route"
        data-url="{% url 'shipments:shipment_route_delete' r.shipment_id r.id %}">
  Del
</button>
              </td>
            </tr>
            {% empty %}
            <tr><td colspan="11" class="text-muted fst-italic">No routes found.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <div class="card-footer">
        <nav>
          <ul class="pagination pagination-sm mb-0">
            {% if page_obj.has_previous %}
            <li class="page-item"><a class="page-link" href="?{% if filters.customer_id %}customer_id={{filters.customer_id}}&{% endif %}{% if filters.customer_q %}customer_q={{filters.customer_q}}&{% endif %}{% if filters.booking %}booking={{filters.booking}}&{% endif %}{% if filters.date_from %}date_from={{filters.date_from}}&{% endif %}{% if filters.date_to %}date_to={{filters.date_to}}&{% endif %}page={{ page_obj.previous_page_number }}">«</a></li>
            {% else %}<li class="page-item disabled"><span class="page-link">«</span></li>{% endif %}
            <li class="page-item disabled"><span class="page-link">Page {{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span></li>
            {% if page_obj.has_next %}
            <li class="page-item"><a class="page-link" href="?{% if filters.customer_id %}customer_id={{filters.customer_id}}&{% endif %}{% if filters.customer_q %}customer_q={{filters.customer_q}}&{% endif %}{% if filters.booking %}booking={{filters.booking}}&{% endif %}{% if filters.date_from %}date_from={{filters.date_from}}&{% endif %}{% if filters.date_to %}date_to={{filters.date_to}}&{% endif %}page={{ page_obj.next_page_number }}">»</a></li>
            {% else %}<li class="page-item disabled"><span class="page-link">»</span></li>{% endif %}
          </ul>
        </nav>
      </div>
    </div>
  </div>
</section>


<button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#routeModal">
  Launch demo modal
</button>



<div class="modal fade" id="routeModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content"><!-- filled by JS --></div>
  </div>
</div>

<!-- Button trigger modal -->
<button type="button" class="btn  btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModal">
  Launch demo modal
</button>

<!-- Modal -->
<div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">Modal title</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        ...
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary">Save changes</button>
      </div>
    </div>
  </div>
</div>
<div id="page-loading" class="position-fixed top-0 start-0 w-100 h-100 d-none"
     style="background:rgba(255,255,255,.6); z-index:2000;">
  <div class="d-flex justify-content-center align-items-center h-100">
    <div class="spinner-border" role="status" aria-label="Loading"></div>
  </div>
</div>
{% endblock %}
{% block extra_css %}
<style>
  /* dropdown autocomplete & gaya borderless */
  .ac-menu{position:absolute;z-index:2000;background:#fff;width:100%;max-height:240px;overflow:auto;border:1px solid #e5e7eb;border-radius:.5rem}
  .ac-item{padding:.375rem .5rem;cursor:pointer}
  .ac-item:hover,.ac-item.is-active{background:#f3f4f6}
  .table td,.table th{border:0!important}
  .form-control,.form-select{border:0!important;box-shadow:none!important}
</style>
<style>
#route-form .form-label {
  font-weight: 500;
  font-size: 0.9rem;
  color: #0d6efd;
}

#route-form .form-control,
#route-form .form-select {
  border: 1px solid #dee2e6 !important;
  border-radius: 0.375rem;
  box-shadow: none !important;
  font-size: 0.9rem;
  padding: 0.45rem 0.65rem;
}

#route-form .form-control:focus,
#route-form .form-select:focus {
  border-color: #0d6efd !important;
  box-shadow: 0 0 0 .15rem rgba(13,110,253,.25) !important;
}

.ac-menu {
  position: absolute;
  z-index: 1050;
  background: #fff;
  width: 100%;
  max-height: 260px;
  overflow-y: auto;
  border: 1px solid #ced4da;
  border-radius: .375rem;
  box-shadow: 0 0.25rem 0.75rem rgba(0,0,0,.05);
}

.ac-item {
  padding: 0.4rem 0.65rem;
  cursor: pointer;
  transition: background-color .15s;
}
.ac-item:hover,
.ac-item.is-active {
  background-color: #f1f3f5;
}
</style>

{% endblock %}


{% block extra_js %}
<script>
(function(){
  // GET partial form (modal)
  async function getHTML(url){
    const r = await fetch(url, {headers:{'X-Requested-With':'XMLHttpRequest'}});
    if(!r.ok) throw new Error('HTTP '+r.status+' '+url);
    return r.text();
  }

  // Buka modal dan bind submit
  async function openRouteModal(url){
    const modal = document.getElementById('routeModal');
    if(!modal){ alert('#routeModal belum ada di halaman'); return; }

    try{
      // load form ke modal
      modal.querySelector('.modal-content').innerHTML = await getHTML(url);
      bootstrap.Modal.getOrCreateInstance(modal).show();

      // optional: aktifkan autocomplete/behaviour lain jika memang ada
      window.initRouteFormBehaviors && window.initRouteFormBehaviors(modal);

      // submit form (POST) → sukses: reload penuh halaman
      const form = modal.querySelector('#route-form');
      form?.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const res = await fetch(url, {method:'POST', body:new FormData(form)});
        // jika server balas JSON {ok:true,...} atau apapun yang menandakan sukses → reload saja
        try{
          const j = await res.clone().json();
          if (j && j.ok){ window.location.reload(); return; }
        }catch(_){}
        // kalau invalid → server balas HTML form ber-error, render ulang
        modal.querySelector('.modal-content').innerHTML = await res.text();
        window.initRouteFormBehaviors && window.initRouteFormBehaviors(modal);
      });

    }catch(err){
      console.error('[routes_schedule] openRouteModal error:', err);
      alert('Gagal memuat form. Cek Console/Network.');
    }
  }

  // Delegasi klik: pakai tombol yang sudah ada
  document.addEventListener('click', (e)=>{
    const btn = e.target.closest('#btn-add-route, .js-edit-route');
    if(!btn) return;
    e.preventDefault();
    const url = btn.dataset.url;
    if(!url){ alert('data-url kosong pada tombol'); return; }
    openRouteModal(url);
  });

  // helper manual dari console: _route(8, null) atau _route(8, 5)
  window._route = (sid, rid)=> openRouteModal(rid ? `/shipments/${sid}/routes/${rid}/modal/`
                                              : `/shipments/${sid}/routes/modal/`);
})();
</script>
{% endblock %}

