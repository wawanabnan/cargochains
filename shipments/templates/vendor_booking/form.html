{% extends "adminbase.html" %}
{% block content %}
<div class="app-content">
  <div class="container-fluid">

    <div class="card">
      <div class="card-header d-flex align-items-center justify-content-between">
        <div>
          <h3 class="card-title mb-0">
            {% if object %}Edit Vendor Booking{% else %}Add Vendor Booking{% endif %}
          </h3>
          {% if object %}
            <div class="text-muted small">
              {{ object.number }} Â·
              <span class="badge bg-info">{{ object.get_status_display|default:object.status }}</span>
            </div>
          {% endif %}
        </div>

        <a class="btn btn-outline-secondary btn-sm"
           href="{% if object %}{% url 'shipments:vendor_booking_detail' object.pk %}{% else %}{% url 'shipments:vendor_booking_list' %}{% endif %}">
          <i class="bi bi-arrow-left me-1"></i> Back
        </a>
      </div>

      <form method="post" novalidate>
        {% csrf_token %}
          <div class="card-body">
            {% if form.non_field_errors %}
              <div class="alert alert-danger py-2 small mb-2">
                {{ form.non_field_errors }}
              </div>
            {% endif %}


            {% include 'vendor_booking/extension/tabnav.html' %}


          <!-- ===== LINES HEADER + ACTIONS ===== -->
          <div class="d-flex align-items-center justify-content-between mt-3 mb-2">
            <div>
              <div class="fw-semibold">Lines</div>
              <div class="text-muted small">Estimated Tax = planning only</div>
            </div>

            <div class="d-flex gap-2 align-items-center">
              <div class="text-muted small me-2">
                Total: <span id="vb-total-text">0</span>
              </div>
              {% if not locked %}
              <button type="button" class="btn btn-outline-primary btn-sm" id="btn-add-line">
                <i class="bi bi-plus-lg me-1"></i> Add Line
              </button>
              {% endif %}
            </div>
          </div>

          {{ formset.management_form }}
          {% if formset.non_form_errors %}
            <div class="alert alert-danger py-2 small mb-2">{{ formset.non_form_errors }}</div>
          {% endif %}

          <div class="table-responsive">
            <table class="table table-sm align-middle mb-0" id="vb-lines-table">
              <thead class="table-light">
                <tr>
                  <th style="width:18%">Cost Type</th>
                  <th>Description</th>
                  <th style="width:8%" class="text-end">Qty</th>
                  <th style="width:10%">UOM</th>
                  <th style="width:14%" class="text-end">Unit Price</th>
                  <th style="width:14%" class="text-end">Subtotal</th>
                  <th style="width:16%">Estimated Tax</th>
                  <th style="width:10%" class="text-end">Tax %</th>
                  <th style="width:6%" class="text-center">Del</th>
                </tr>
              </thead>

              <tbody id="vb-lines-body">
                {% for f in formset %}
                  <tr class="vb-row">
                    <td>
                      {{ f.cost_type }}
                      {% if f.cost_type.errors %}<div class="text-danger small">{{ f.cost_type.errors|striptags }}</div>{% endif %}
                    </td>
                    <td>
                      {{ f.description }}
                      {% if f.description.errors %}<div class="text-danger small">{{ f.description.errors|striptags }}</div>{% endif %}
                    </td>
                    <td class="text-end">
                      {{ f.qty }}
                      {% if f.qty.errors %}<div class="text-danger small">{{ f.qty.errors|striptags }}</div>{% endif %}
                    </td>
                    <td>
                      {{ f.uom }}
                      {% if f.uom.errors %}<div class="text-danger small">{{ f.uom.errors|striptags }}</div>{% endif %}
                    </td>
                    <td class="text-end">
                      {{ f.unit_price }}
                      {% if f.unit_price.errors %}<div class="text-danger small">{{ f.unit_price.errors|striptags }}</div>{% endif %}
                    </td>
                    <td class="text-end">
                      <span class="vb-subtotal">0</span>
                    </td>
                    <td>
                      {{ f.estimated_tax }}
                      {% if f.estimated_tax.errors %}<div class="text-danger small">{{ f.estimated_tax.errors|striptags }}</div>{% endif %}
                    </td>
                    <td class="text-end">
                      {{ f.estimated_tax_rate }}
                      {% if f.estimated_tax_rate.errors %}<div class="text-danger small">{{ f.estimated_tax_rate.errors|striptags }}</div>{% endif %}
                    </td>
                    <td class="text-center">
                      {{ f.DELETE }}
                    </td>
                  </tr>

                  {% if f.non_field_errors %}
                    <tr><td colspan="9" class="text-danger small">{{ f.non_field_errors }}</td></tr>
                  {% endif %}
                {% endfor %}
              </tbody>

              <tfoot class="table-light">
                <tr>
                  <td colspan="5" class="text-end fw-semibold">Total</td>
                  <td class="text-end fw-semibold"><span id="vb-total-sub">0</span></td>
                  <td colspan="3"></td>
                </tr>
              </tfoot>
            </table>
          </div>

          <!-- ===== EMPTY FORM TEMPLATE (for Add Line) ===== -->
          <template id="vb-empty-form-tpl">
            <tr class="vb-row">
              <td>{{ formset.empty_form.cost_type }}</td>
              <td>{{ formset.empty_form.description }}</td>
              <td class="text-end">{{ formset.empty_form.qty }}</td>
              <td>{{ formset.empty_form.uom }}</td>
              <td class="text-end">{{ formset.empty_form.unit_price }}</td>
              <td class="text-end"><span class="vb-subtotal">0</span></td>
              <td>{{ formset.empty_form.estimated_tax }}</td>
              <td class="text-end">{{ formset.empty_form.estimated_tax_rate }}</td>
              <td class="text-center">{{ formset.empty_form.DELETE }}</td>
            </tr>
          </template>

         </div>

        <div class="card-footer d-flex gap-2 justify-content-end">
          <button class="btn btn-primary btn-sm">
            <i class="bi bi-save me-1"></i> Save
          </button>
        </div>
      </form>
    </div>

  </div>
</div>

<script>
(function(){
  function num(v){
    if (v === null || v === undefined) return 0;
    v = String(v).trim();
    if (!v) return 0;
    // support id-ID typed number: 1.234,56
    if (v.indexOf(",") >= 0) v = v.replace(/\./g, "").replace(",", ".");
    var n = parseFloat(v);
    return isNaN(n) ? 0 : n;
  }

  function fmt(n){
    try {
      return Number(n || 0).toLocaleString("id-ID", {minimumFractionDigits: 2, maximumFractionDigits: 2});
    } catch(e){
      return (n || 0).toFixed(2);
    }
  }

  function getPrefix(){
    // find management TOTAL_FORMS input: name="<prefix>-TOTAL_FORMS"
    var el = document.querySelector('input[name$="-TOTAL_FORMS"]');
    if (!el) return null;
    return el.name.replace(/-TOTAL_FORMS$/, "");
  }

  function recalc(){
    var rows = document.querySelectorAll("#vb-lines-table tbody tr.vb-row");
    var total = 0;

    rows.forEach(function(tr){
      var del = tr.querySelector('input[type="checkbox"][name$="-DELETE"]');
      if (del && del.checked) {
        tr.querySelector(".vb-subtotal").textContent = "0";
        return;
      }

      var qtyEl = tr.querySelector('input[name$="-qty"]');
      var priceEl = tr.querySelector('input[name$="-unit_price"]');

      var qty = qtyEl ? num(qtyEl.value) : 0;
      var price = priceEl ? num(priceEl.value) : 0;
      var sub = qty * price;

      tr.querySelector(".vb-subtotal").textContent = fmt(sub);
      total += sub;
    });

    var totalEl = document.getElementById("vb-total-sub");
    if (totalEl) totalEl.textContent = fmt(total);

    var totalText = document.getElementById("vb-total-text");
    if (totalText) totalText.textContent = fmt(total);
  }

  function replacePrefix(html, idx){
    // Django formset empty_form uses __prefix__
    return html.replaceAll("__prefix__", String(idx));
  }

  function addLine(){
    var prefix = getPrefix();
    if (!prefix) return;

    var totalEl = document.querySelector('input[name="'+prefix+'-TOTAL_FORMS"]');
    var idx = parseInt(totalEl.value || "0", 10);

    var tpl = document.getElementById("vb-empty-form-tpl");
    if (!tpl) return;

    var html = replacePrefix(tpl.innerHTML, idx);
    var tmp = document.createElement("tbody");
    tmp.innerHTML = html.trim();
    var newRow = tmp.querySelector("tr");
    if (!newRow) return;

    // clear values just in case
    newRow.querySelectorAll("input, select, textarea").forEach(function(el){
      if (el.type === "checkbox") el.checked = false;
      else el.value = "";
    });

    document.getElementById("vb-lines-body").appendChild(newRow);

    totalEl.value = String(idx + 1);
    recalc();
  }

  document.addEventListener("input", function(e){
    var t = e.target;
    if (!t) return;
    if (t.name && (t.name.endsWith("-qty") || t.name.endsWith("-unit_price"))) recalc();
  });

  document.addEventListener("change", function(e){
    var t = e.target;
    if (!t) return;
    if (t.name && t.name.endsWith("-DELETE")) recalc();
  });

  document.addEventListener("DOMContentLoaded", function(){
    var btn = document.getElementById("btn-add-line");
    if (btn) btn.addEventListener("click", addLine);
    recalc();
  });
})();
</script>
{% endblock %}
