{% load indo_format %}
<table style="width:100%; margin-top: 6mm;">
  <tr>
    <td style="width:60%;"></td>
    <td style="width:40%; text-align:right;">
      <div style="font-size:16px; font-weight:700; letter-spacing:.5px;">SERVICE ORDER</div>
      <div style="margin-top:2mm;">
        <strong><span style="font-size: 14px;">{{ vb.vb_number|default:"-" }}</span></strong>
      </div>
    </td>
  </tr>
</table>
<table style="width:100%; margin-top: 4mm;">
  <tr>
    {# LEFT: To Vendor Contact + Address #}
    <td class="wrap" style="width:60%; vertical-align:top;">
      <div style="font-weight:700; margin-bottom:1mm;">To Vendor Contact</div>

      <div class="mb=2">
        <strong>{{ vb.vendor.name|default:vb.vendor|default:"-" }}</strong>
      </div>

      {# Address lines only if exist #}
      {% if vb.vendor.address1 %}<div>{{ vb.vendor.address1 }}</div>{% endif %}
      {% if vb.vendor.address2 %}<div>{{ vb.vendor.address2 }}</div>{% endif %}

      {# village - district #}
      {% if vb.vendor.village or vb.vendor.district %}
        <div>
          {{ vb.vendor.village|default:"" }}{% if vb.vendor.village and vb.vendor.district %} - {% endif %}{{ vb.vendor.district|default:"" }}
        </div>
      {% endif %}

      {% if vb.vendor.regency %}<div>{{ vb.vendor.regency }}</div>{% endif %}
      {% if vb.vendor.province %}<div>{{ vb.vendor.province }}</div>{% endif %}
    </td>

    {# RIGHT: Date + Payment Term #}
    <td class="wrap" style="width:40%; vertical-align:top;">
      <table style="width:100%;">
        <tr>
          <td style="width:40%;"><strong>Date</strong></td>
          <td style="text-align:right;">{{ vb.booking_date|date:"d-m-Y" }}</td>
        </tr>
        <tr>
          <td><strong>Payment Term</strong></td>
          <td style="text-align:right;">{{ vb.payment_term|default:"-" }}</td>
        </tr>
      </table>
    </td>
  </tr>
</table>

<table class="table table-bordered" style="font-size: 10.5px;">
  <thead>
    <tr>
      <th style="width: 5%;">No</th>
      <th>Description</th>
      <th class="text-end" style="width: 8%;">Qty</th>
      <th style="width: 10%;">Unit</th>
      <th class="text-end" style="width: 14%;">Price</th>
      <th style="width: 14%;">Taxes</th>
      <th class="text-end" style="width: 15%;">Amount</th>
    </tr>
  </thead>

  <tbody>
    {% for ln in lines %}
      <tr>
        <td class="nowrap">{{ forloop.counter }}</td>
        <td class="wrap">{{ ln.description|default:"-" }}</td>
        <td class="text-end nowrap">{{ ln.qty }}</td>
        <td class="nowrap">{{ ln.uom.name|default:"-" }}</td>
        <td class="text-end nowrap">{{ ln.unit_price|indo_number }}</td>

        <td class="wrap">
          {% if ln.taxes.all %}
            {% for t in ln.taxes.all %}
              {{ t.group|default:"" }}{% if t.rate %} {{ t.rate }}%{% endif %}{% if not forloop.last %}, {% endif %}
            {% endfor %}
          {% else %}
            -
          {% endif %}
        </td>

        <td class="text-end nowrap">{{ ln.amount|indo_number }}</td>
      </tr>
    {% empty %}
      <tr>
        <td colspan="7" class="text-muted">No lines.</td>
      </tr>
    {% endfor %}
  </tbody>

  <tfoot>
    <tr>
      <th colspan="6" class="text-end">Sub Total</th>
      <th class="text-end nowrap">{{ subtotal|indo_number }}</th>
    </tr>

    {% if tax_ppn > 0 %}
      <tr>
        <th colspan="6" class="text-end">Tax Amount</th>
        <th class="text-end nowrap">{{ tax_ppn|indo_number }}</th>
      </tr>
    {% endif %}

    {% if tax_pph > 0 %}
      <tr>
        <th colspan="6" class="text-end">PPH Amount</th>
        <th class="text-end nowrap">{{ tax_pph|indo_number }}</th>
      </tr>
    {% endif %}

    {% if vb.discount_amount and vb.discount_amount > 0 %}
      <tr>
        <th colspan="6" class="text-end">Discount</th>
        <th class="text-end nowrap">{{ vb.discount_amount|indo_number }}</th>
      </tr>
    {% endif %}

    <tr>
      <th colspan="6" class="text-end">Grand Total</th>
      <th class="text-end nowrap"><strong>{{ total|indo_number }}</strong></th>
    </tr>
  </tfoot>
</table>

{# ✅ Vendor Note #}
{% if vb.vendor_note %}
  <div style="margin-top: 6mm;">
    <strong>Vendor Note:</strong>
    <div class="wrap">{{ vb.vendor_note|safe }}</div>
  </div>
{% endif %}

{# ✅ Term & Conditions #}
{% if vb.term_conditions %}
  <div style="margin-top: 5mm;">
    <strong>Terms &amp; Conditions:</strong>
    <div class="wrap">{{ vb.term_conditions|safe }}</div>
  </div>
{% endif %}

{# ✅ Signature (same vars as quotation: signature_name/title/image) #}
{% if signature_name or signature_image %}
  <div style="margin-top: 10mm; page-break-inside: avoid;">
    <table style="width:100%;">
      <tr>
        <td style="width:55%;"></td>
        <td style="width:45%; text-align:center;">
          <div>Approved By</div>

          <div style="height: 22mm; margin-top: 2mm;">
            {% if signature_image %}
              <img src="{{ signature_image.url }}" style="height:60px; object-fit:contain;">
            {% endif %}
          </div>

          {% if signature_name %}
            <div style="font-weight:700;">{{ signature_name }}</div>
          {% endif %}
          {% if signature_title %}
            <div style="font-size:10px;">{{ signature_title }}</div>
          {% endif %}
        </td>
      </tr>
    </table>
  </div>
{% endif %}
