{% load indo_format %}

<div style="margin-top: 6mm;">
  <table>
    <tr>
      <td class="wrap">
        <div><strong>Service Order #</strong>: {{ vb.vb_number|default:"-" }}</div>
        <div><strong>Date</strong>: {{ vb.booking_date|date:"d-m-Y" }}</div>
        <div><strong>Job Order</strong>: {{ vb.job_order }}</div>
      </td>
      <td class="wrap" style="width: 45%;">
        <div><strong>Vendor</strong>: {{ vb.vendor }}</div>
        <div><strong>Payment Terms</strong>: {{ vb.payment_term|default:"-" }}</div>
        <div><strong>Status</strong>: {{ vb.status }}</div>
      </td>
    </tr>
  </table>
</div>

<hr style="margin: 8mm 0 4mm;">

<table class="table table-bordered" style="font-size: 10.5px;">
  <thead>
    <tr>
      <th style="width: 5%;">No</th>
      <th>Description</th>
      <th class="text-end" style="width: 8%;">Qty</th>
      <th style="width: 10%;">Unit</th>
      <th class="text-end" style="width: 14%;">Price</th>
      <th style="width: 14%;">Taxes</th>
      <th class="text-end" style="width: 15%;">Amount</th>
    </tr>
  </thead>

  <tbody>
    {% for ln in lines %}
      <tr>
        <td class="nowrap">{{ forloop.counter }}</td>
        <td class="wrap">{{ ln.description|default:"-" }}</td>
        <td class="text-end nowrap">{{ ln.qty }}</td>
        <td class="nowrap">{{ ln.uom.name|default:"-" }}</td>
        <td class="text-end nowrap">{{ ln.unit_price|indo_number }}</td>

        {# Taxes: tampil rate per tax di line #}
        <td class="wrap">
          {% if ln.taxes.all %}
            {% for t in ln.taxes.all %}
              {{ t.group|default:"" }}{% if t.rate %} {{ t.rate }}%{% endif %}{% if not forloop.last %}, {% endif %}
            {% endfor %}
          {% else %}
            -
          {% endif %}
        </td>

        <td class="text-end nowrap">{{ ln.amount|indo_number }}</td>
      </tr>
    {% empty %}
      <tr>
        <td colspan="7" class="text-muted">No lines.</td>
      </tr>
    {% endfor %}
  </tbody>

  <tfoot>
    <tr>
      <th colspan="6" class="text-end">Sub Total</th>
      <th class="text-end nowrap">{{ subtotal|indo_number }}</th>
    </tr>

    {% if tax_ppn > 0 %}
      <tr>
        <th colspan="6" class="text-end">
          Tax Amount
        </th>
        <th class="text-end nowrap">{{ tax_ppn|indo_number }}</th>
      </tr>
    {% endif %}

    {% if tax_pph > 0 %}
      <tr>
        <th colspan="6" class="text-end">
          PPH Amount
        </th>
        <th class="text-end nowrap">{{ tax_pph|indo_number }}</th>
      </tr>
    {% endif %}

    {% if vb.discount_amount and vb.discount_amount > 0 %}
      <tr>
        <th colspan="6" class="text-end">Discount</th>
        <th class="text-end nowrap">{{ vb.discount_amount|indo_number }}</th>
      </tr>
    {% endif %}

    <tr>
      <th colspan="6" class="text-end">Grand Total</th>
      <th class="text-end nowrap"><strong>{{ total|indo_number }}</strong></th>
    </tr>
  </tfoot>
</table>

{# ✅ Vendor Note #}
{% if vb.vendor_note %}
  <div style="margin-top: 6mm;">
    <strong>Vendor Note:</strong>
    <div class="wrap">{{ vb.vendor_note|safe }}</div>
  </div>
{% endif %}

{# ✅ Term & Conditions #}
{% if vb.term_conditions %}
  <div style="margin-top: 5mm;">
    <strong>Terms &amp; Conditions:</strong>
    <div class="wrap">{{ vb.term_conditions|safe }}</div>
  </div>
{% endif %}

{# ✅ Signature (from context: so_signer) #}
{% if so_signer %}
  <div style="margin-top: 10mm;">
    <table style="width: 100%;">
      <tr>
        <td style="width: 55%;"></td>
        <td style="width: 45%; text-align: center;">
          <div>Approved By</div>
          <div style="height: 80px;"></div>
          <strong>
            {{ so_signer.get_full_name|default:so_signer.username }}
          </strong>
        </td>
      </tr>
    </table>
  </div>
{% endif %}
