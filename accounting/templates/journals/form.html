{% extends "adminbase.html" %}
{% block content %}

<div class="container-fluid py-3">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h4 class="mb-0">
      {% if mode == "edit" %}Edit Journal{% else %}Add Journal{% endif %}
    </h4>
    <div class="d-flex gap-2">
      <a class="btn btn-sm btn-outline-secondary" href="{% url 'accounting:journal_list' %}">Back</a>
      {% if mode == "edit" %}
        <a class="btn btn-sm btn-outline-primary" href="{% url 'accounting:journal_detail' journal.pk %}">Detail</a>
      {% endif %}
    </div>
  </div>

  {% if messages %}
    {% for m in messages %}
      <div class="alert alert-{{ m.tags }} py-2">{{ m }}</div>
    {% endfor %}
  {% endif %}

  <form method="post">
    {% csrf_token %}

    <div class="card mb-3">
      <div class="card-body">
        <div class="row g-2">
          <div class="col-lg-3">
            <label class="form-label small">Number</label>
            <div class="text-muted small">Number will be generated automatically</div>

          </div>
          <div class="col-lg-3">
            <label class="form-label small">Date</label>
            {{ form.date }}
            {% if form.date.errors %}<div class="text-danger small">{{ form.date.errors|striptags }}</div>{% endif %}
          </div>
          <div class="col-lg-3">
            <label class="form-label small">Ref</label>
            {{ form.ref }}
          </div>
          <div class="col-lg-12">
            <label class="form-label small">Description</label>
            {{ form.description }}
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-header py-2 d-flex justify-content-between align-items-center">
        <div class="fw-semibold">Lines</div>
        <button type="button" class="btn btn-sm btn-outline-primary" id="btnAddLine">+ Add line</button>
      </div>

      <div class="card-body p-0">
        {{ formset.management_form }}

        <div class="table-responsive">
          <table class="table table-sm mb-0 align-middle" id="linesTable">
            <thead>
              <tr>
                <th style="width: 32%">Account</th>
                <th>Label</th>
                <th class="text-end" style="width: 14%">Debit</th>
                <th class="text-end" style="width: 14%">Credit</th>
                <th style="width: 70px" class="text-center">Del</th>
              </tr>
            </thead>
            <tbody id="linesBody">
              {% for f in formset.forms %}
                <tr class="line-row">
                  <td>
                    {{ f.account_text }}
                    {{ f.account_id }}
                     {{ f.id }}
                     {{ f.journal }}
                    {% if f.errors.account_text or f.errors.account_id %}
                      <div class="text-danger small">
                        {{ f.errors.account_text|striptags }} {{ f.errors.account_id|striptags }}
                      </div>
                    {% endif %}
                  </td>

                  <td>{{ f.label }}</td>
                  <td>{{ f.debit }}</td>
                  <td>{{ f.credit }}</td>
                  <td class="text-center">
                    {% if f.instance.pk %}
                      {{ f.DELETE }}
                    {% else %}
                      {{ f.DELETE }}
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <template id="emptyFormTemplate">
          <tr class="line-row">
            <td>__ACCOUNT__</td>
            <td>__LABEL__</td>
            <td>__DEBIT__</td>
            <td>__CREDIT__</td>
            <td class="text-center">__DELETE__</td>
          </tr>
        </template>

      </div>

      <div class="card-footer d-flex justify-content-end gap-2">
        <button class="btn btn-sm btn-primary">Save</button>
      </div>
    </div>
  </form>
</div>

{% endblock %}

{% block extra_css %}

<style>
/* === jQuery UI Autocomplete fix for AdminLTE === */
.ui-autocomplete {
  position: absolute;
  z-index: 1055;          /* di atas modal/card */
  background: #ffffff;   /* background putih */
  border: 1px solid #dee2e6;
  border-radius: 0.25rem;
  max-height: 240px;
  overflow-y: auto;
  overflow-x: hidden;
  padding: 0;
}

.ui-menu-item {
  padding: 6px 10px;
  cursor: pointer;
}

.ui-menu-item-wrapper.ui-state-active {
  background: #0d6efd;   /* biru bootstrap */
  color: #ffffff;
}
</style>
{% endblock %}


{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function(){
  const totalForms = document.querySelector('#id_lines-TOTAL_FORMS');
  const tbody = document.getElementById("linesBody");

  function getRow(el){
    return el.closest("tr.line-row");
  }

  function parseAccountCode(selectEl){
    if (!selectEl) return "";
    // Prefer option text: "1101 - Cash"
    const opt = selectEl.options[selectEl.selectedIndex];
    const txt = (opt ? opt.text : "").trim();
    const code = txt.split(" ")[0].replace("-", "").trim(); // ambil "1101"
    return code;
  }

  function toNum(v){
    const s = (v || "").toString().replaceAll(",", "").trim();
    const n = parseFloat(s);
    return isNaN(n) ? 0 : n;
  }

  function suggestLabel(code, debit, credit){
    // rules sederhana & demo-friendly
    // cash/bank (11xx)
    if (code.startsWith("110") || code.startsWith("111")) {
      if (debit > 0 && credit <= 0) return "Cash received from customer";
      if (credit > 0 && debit <= 0) return "Cash paid / cash out";
      return "Cash movement";
    }

    // AR (12xx)
    if (code.startsWith("120")) {
      if (debit > 0 && credit <= 0) return "Invoice issued (AR)";
      if (credit > 0 && debit <= 0) return "Customer payment applied (AR)";
      return "Accounts receivable";
    }

    // AP (21xx)
    if (code.startsWith("210")) {
      if (credit > 0 && debit <= 0) return "Vendor bill recorded (AP)";
      if (debit > 0 && credit <= 0) return "Payment to vendor (AP)";
      return "Accounts payable";
    }

    // Revenue (41xx)
    if (code.startsWith("41")) {
      return "Freight service revenue";
    }

    // COGS / Direct Cost (51xx)
    if (code.startsWith("51")) {
      return "Freight / carrier cost";
    }

    // Tax
    if (code.startsWith("23")) return "VAT out / tax payable";
    if (code.startsWith("15")) return "VAT in / prepaid tax";


    // Deposit / Prepaid (13xx)
    if (code.startsWith("13")) {
        if (debit > 0 && credit <= 0) return "Advance payment to vendor";
        if (credit > 0 && debit <= 0) return "Advance applied to vendor bill";
        return "Vendor deposit / prepaid";
    }


    return "General journal line";
  }

  function autoFillLabel(row){
    const sel = row.querySelector('select[name$="-account"]');
    const lbl = row.querySelector('input[name$="-label"]');
    const debitEl = row.querySelector('input[name$="-debit"]');
    const creditEl = row.querySelector('input[name$="-credit"]');

    if (!sel || !lbl) return;

    // hanya isi kalau label masih kosong
    if ((lbl.value || "").trim() !== "") return;

    const code = parseAccountCode(sel);
    const debit = toNum(debitEl ? debitEl.value : 0);
    const credit = toNum(creditEl ? creditEl.value : 0);

    if (!code) return;
    lbl.value = suggestLabel(code, debit, credit);
  }

  // Event delegation: berlaku untuk row existing & row baru
  tbody.addEventListener("change", function(e){
    if (e.target.matches('select[name$="-account"]')) {
      autoFillLabel(getRow(e.target));
    }
  });

  tbody.addEventListener("blur", function(e){
    if (e.target.matches('input[name$="-debit"], input[name$="-credit"]')) {
      autoFillLabel(getRow(e.target));
    }
  }, true);

  // tombol add line (punya om sebelumnya)
  document.getElementById("btnAddLine").addEventListener("click", function(){
    const idx = parseInt(totalForms.value, 10);

    const row = document.createElement("tr");
    row.className = "line-row";
    row.innerHTML = `
      <td>
        <select name="lines-${idx}-account" id="id_lines-${idx}-account" class="form-select form-select-sm">
          ${document.querySelector('#id_lines-0-account') ? document.querySelector('#id_lines-0-account').innerHTML : ""}
        </select>
      </td>
      <td><input type="text" name="lines-${idx}-label" id="id_lines-${idx}-label" class="form-control form-control-sm"></td>
      <td><input type="number" step="0.01" name="lines-${idx}-debit" id="id_lines-${idx}-debit" class="form-control form-control-sm text-end"></td>
      <td><input type="number" step="0.01" name="lines-${idx}-credit" id="id_lines-${idx}-credit" class="form-control form-control-sm text-end"></td>
      <td class="text-center">
        <input type="checkbox" name="lines-${idx}-DELETE" id="id_lines-${idx}-DELETE">
      </td>
      <input type="hidden" name="lines-${idx}-id" id="id_lines-${idx}-id">
      <input type="hidden" name="lines-${idx}-journal" id="id_lines-${idx}-journal">
    `;
    tbody.appendChild(row);
    totalForms.value = idx + 1;
  });
});
</script>
<script>
$(function () {
  function initAccountAutocomplete($row) {
    const $txt = $row.find("input.js-acct-text");
    const $hid = $row.find('input[type="hidden"][name$="-account_id"]');

    if (!$txt.length) return;
    if ($txt.data("ui-autocomplete")) return; // prevent double init

    $txt.autocomplete({
      minLength: 1,
      delay: 150,
      source: function (request, response) {
        $.getJSON("{% url 'accounting:account_autocomplete' %}", { q: request.term }, response);
      },
      select: function (event, ui) {
        $txt.val(ui.item.label);
        $hid.val(ui.item.id);
        return false;
      },
      change: function () {
        // kalau user ketik manual tanpa pilih list → kosongkan hidden biar validasi nangkap
        if (!$txt.val().trim()) $hid.val("");
      }
    });

    // kalau user edit manual text → reset hidden (harus pilih lagi)
    $txt.on("input", function(){
      $hid.val("");
    });
  }

  // init semua row existing
  $("#linesBody tr.line-row").each(function(){
    initAccountAutocomplete($(this));
  });

  // hook add line: setelah row ditambah, init autocomplete
  $("#btnAddLine").on("click", function () {
    // ... ini bagian add line om tetap ...
    // setelah om append row baru, panggil:
    const $last = $("#linesBody tr.line-row").last();
    initAccountAutocomplete($last);
  });
});
</script>

{% endblock %}
