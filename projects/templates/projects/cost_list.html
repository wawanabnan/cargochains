{% extends "adminbase.html" %}

{% block content %}

<div class="app-content-header">
  <div class="container-fluid">
    <div class="row">
      <div class="col-sm-6">
        <h3 class="mb-0">Project Costs</h3>
      </div>
      <div class="col-sm-6">
        <ol class="breadcrumb float-sm-end">
          <li class="breadcrumb-item"><a href="#">Home</a></li>
          <li class="breadcrumb-item active" aria-current="page">New</li>
        </ol>
      </div>
    </div>
  </div>
</div>


<div class="app-content">
  <div class="container-fluid">
    {% include "projects/extensions/toolbar.html" %}
  </div>
  <div class="container-fluid">
    {% include "projects/extensions/cost-table.html" %}
  </div>
</div>

{% with p=page_obj %}
  {% if p and p.paginator.num_pages > 1 %}
    {% include "partials/pagination.html" %}
  {% endif %}
{% endwith %}

{% include "projects/extensions/panel-filter.html" %}


{# Modal Add Project Cost #}
<div class="modal fade" id="costAddModal" tabindex="-1" aria-labelledby="costAddModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <form id="costAddForm" method="post" enctype="multipart/form-data" action="{% url 'projects:cost_add' %}">
        {% csrf_token %}
        <div class="modal-header">
          <h6 class="modal-title" id="costAddModalLabel">Add Project Cost</h6>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body">
          <div id="costAddErrors" class="alert alert-danger py-2 px-3 d-none small"></div>

          <div class="row g-2">
            <div class="col-md-6">
              <label class="form-label small">Project</label>
              <select name="project" class="form-select form-select-sm" required>
                {% for p in projects %}
                  <option value="{{ p.id }}">{{ p.number }} — {{ p.name }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label small">Category</label>
              <select name="category" class="form-select form-select-sm" required>
                {% for cat in categories %}
                  <option value="{{ cat.id }}">{{ cat.name }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="col-md-8">
              <label class="form-label small">Cost Description</label>
              <input type="text" name="title" class="form-control form-control-sm" required>
            </div>
            <div class="col-md-4">
              <label class="form-label small">Cost Date</label>
              <input type="date" name="cost_date" class="form-control form-control-sm">
            </div>

            <div class="col-md-4">
              <label class="form-label small">Amount</label>
              <input type="number" step="0.01" name="amount" class="form-control form-control-sm" required>
            </div>
            <div class="col-md-2">
              <label class="form-label small">CCY</label>
              <input type="text" name="currency_code" class="form-control form-control-sm" value="IDR" maxlength="3">
            </div>
            <div class="col-md-6">
              <label class="form-label small">Reference</label>
              <input type="text" name="ref" class="form-control form-control-sm" placeholder="Invoice/PO/Ref">
            </div>

            <div class="col-12">
              <label class="form-label small">Notes</label>
              <textarea name="notes" rows="3" class="form-control form-control-sm"></textarea>
            </div>

            <div class="col-12">
              <label class="form-label small">Attachment</label>
              <input type="file" name="attachment" class="form-control form-control-sm">
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-link btn-sm" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary btn-sm">
            <i class="fa fa-save me-1"></i> Save
          </button>
        </div>
      </form>
    </div>
  </div>
</div>














{% endblock %}

{% block extra_js %}
<script>
(function(){
  // ---------- Row click ----------
  document.querySelectorAll('#pcost-list tr.clickable-row').forEach(tr=>{
    tr.addEventListener('click', (e)=>{
      if (e.target.closest('input, a, button, label')) return; // ignore controls
      const url = tr.getAttribute('data-href');
      if (url) window.location = url;
    });
  });

  // ---------- Amount format ----------
  document.querySelectorAll('#pcost-list tr').forEach(tr=>{
    const cell = tr.querySelector('.amount-idr');
    if (!cell) return;
    const raw = tr.getAttribute('data-amount');
    const num = Number((raw || '0').toString().replace(',', '.')) || 0;
    try {
      const nf = new Intl.NumberFormat('id-ID', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      cell.textContent = nf.format(num);
    } catch(e){ cell.textContent = num.toFixed(2); }
  });

  // ---------- Selection / Toolbar toggle ----------
  const checkAll   = document.getElementById('check-all');
  const checks     = Array.from(document.querySelectorAll('.row-check'));
  const bulkForm   = document.getElementById('bulk-form');
  const searchBox  = document.getElementById('search-box');
  const selCountEl = document.getElementById('sel-count');
  const btnDelete  = document.getElementById('btn-bulk-delete');
  const btnPrint   = document.getElementById('btn-bulk-print');
  const btnCancel  = document.getElementById('btn-cancel-select');
  const bulkAction = document.getElementById('bulk-action');

  function updateToolbar(){
    const selected = checks.filter(c=>c.checked);
    const n = selected.length;
    selCountEl.textContent = n;
    const showAction = n > 0;
    bulkForm.classList.toggle('d-none', !showAction);
    searchBox.classList.toggle('d-none', showAction);
    btnDelete.disabled = n === 0;
    btnPrint.disabled  = n === 0;
    if (checkAll) {
      checkAll.indeterminate = (n > 0 && n < checks.length);
      checkAll.checked = (n > 0 && n === checks.length);
    }
  }

  checks.forEach(c=>{
    c.addEventListener('click', e => e.stopPropagation());
    c.addEventListener('change', updateToolbar);
  });

  if (checkAll){
    checkAll.addEventListener('change', ()=>{
      checks.forEach(c => c.checked = checkAll.checked);
      updateToolbar();
    });
  }

  btnCancel?.addEventListener('click', ()=>{
    checks.forEach(c => c.checked = false);
    updateToolbar();
  });

  // ---------- Bulk actions ----------
  btnDelete?.addEventListener('click', ()=>{
    const n = checks.filter(c=>c.checked).length;
    if (!n) return;
    if (!confirm(`Delete ${n} selected cost(s)?`)) return;
    bulkAction.value = 'delete';
    bulkForm.submit();
  });

  btnPrint?.addEventListener('click', ()=>{
    const n = checks.filter(c=>c.checked).length;
    if (!n) return;
    bulkAction.value = 'print';
    bulkForm.submit();
  });

  updateToolbar();
})();
</script>

<script>
(function(){
  const form   = document.getElementById('costAddForm');
  const errors = document.getElementById('costAddErrors');
  const modalEl = document.getElementById('costAddModal');
  const bsModal = modalEl ? bootstrap.Modal.getOrCreateInstance(modalEl) : null;

  if (form){
    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      errors?.classList.add('d-none');
      errors && (errors.innerHTML = "");

      const url = form.getAttribute('action');
      const fd  = new FormData(form);

      // fetch AJAX
      const res = await fetch(url, {
        method: 'POST',
        headers: { 'X-Requested-With': 'XMLHttpRequest' },
        body: fd,
      });

      if (res.ok){
        // success → close & reload
        bsModal && bsModal.hide();
        // optional: reset form supaya modal bersih
        form.reset();
        // reload halaman supaya row baru muncul
        window.location.reload();
        return;
      }

      // error → tampilkan daftar error
      try {
        const data = await res.json();
        if (data && data.errors){
          const msgs = [];
          for (const [field, arr] of Object.entries(data.errors)){
            arr.forEach(msg => msgs.push(`<div>• <strong>${field}</strong>: ${msg}</div>`));
          }
          errors.innerHTML = msgs.join("");
          errors.classList.remove('d-none');
          return;
        }
      } catch(e){}
      errors.innerHTML = "Failed to save. Please check your input.";
      errors.classList.remove('d-none');
    });

    // optional: reset error saat modal dibuka
    modalEl?.addEventListener('show.bs.modal', ()=>{
      errors?.classList.add('d-none');
      if (errors) errors.innerHTML = "";
    });
  }
})();
</script>

{% endblock %}
