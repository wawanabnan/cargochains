{# templates/job/quotation_detail.html #}
{% extends "adminbase.html" %}
{% load humanize %}
{% load indo_format %}

{% block content %}

<div class="app-content-header">
  <div class="container-fluid">
    <div class="d-flex align-items-center justify-content-between">
      <div>
        <h4 class="mb-1">Quotation Detail</h4>
        <div class="text-muted">
          <span class="me-2"><strong>{{ quotation.number }}</strong></span>

          {% if quotation.effective_status == "EXPIRED" %}
            <span class="badge bg-danger">EXPIRED</span>
          {% elif quotation.status == "DRAFT" %}
            <span class="badge bg-secondary">DRAFT</span>
          {% elif quotation.status == "SENT" %}
            <span class="badge bg-primary">SENT</span>
          {% elif quotation.status == "ORDERED" %}
            <span class="badge bg-success">ORDERED</span>
          {% elif quotation.status == "CANCELED" %}
            <span class="badge bg-dark">CANCELED</span>
          {% else %}
            <span class="badge bg-secondary">{{ quotation.status }}</span>
          {% endif %}
        </div>
      </div>

      <div class="d-flex gap-1">
        <a class="btn btn-sm btn-outline-primary" href="{% url 'job:quotation_list' %}">
          Back to List
        </a>

          

          {% if job.status != 'COMPLETED' %}
              <a href="{% url 'job:quotation_update' object.pk %}"
                class="btn btn-sm btn-outline-secondary btn-sm">
                <i class="bi bi-pencil"></i> Edit
              </a>
          {% endif %}


        <a href="{% url 'job:quotation_print' object.pk %}" 
            class="btn btn-sm btn-outline-secondary" target="_blank"> <i class="bi bi-printer"></i> Preview</a>
            <!--
        <a href="{% url 'job:quotation_pdf' object.pk %}" 
        class="btn btn-sm btn-outline-danger" target="_blank"> <i class="bi bi-file-pdf"></i> PDF</a>-->
 
        {# Tombol CONVERT: default contoh = hanya SENT & belum expired #}
        {% if quotation.status == "SENT" and quotation.effective_status != "EXPIRED" %}
          <form method="post" action="{% url 'job:quotation_convert' quotation.id %}" class="d-inline">
            {% csrf_token %}
            <button type="submit" class="btn btn-sm btn-success">
              Convert to Order
            </button>
          </form>
        {% endif %}
           {# Tombol SEND: hanya DRAFT & belum expired #}
        {% if quotation.status == "DRAFT" and quotation.effective_status != "EXPIRED" %}
          <form method="post" action="{% url 'job:quotation_send' quotation.id %}" class="d-inline">
            {% csrf_token %}
            <button type="submit" class="btn btn-sm btn-primary">
              Submit
            </button>
          </form>
        {% endif %}

        {# Link ke JobOrder kalau sudah ada #}
        {% if quotation.job_order and quotation.job_order.status == 'DRAFT' %}
        <a class="btn btn-sm btn-outline-success"
          href="{% url 'job:job_order_detail' quotation.job_order.id %}">
          View Job Order
        </a>
      {% endif %}
      </div>
    </div>
  </div>
</div>



<div class="app-content">
  <div class="container-fluid">

    <div class="card mb-2">
          <div class="card-header">
            <strong>Quotation Info</strong>
          </div>
          <div class="card-body">
            <div class="row">
              <div class="col-md-8" style="border-right: 1px solid #ccc;">
                {% include "quotations/extensions/_form_left.html" %}
              </div>
              <div class="col-md-4">
                 {% include "quotations/extensions/_form_right.html" %}
              </div>

            </div>
            
        </div>
    </div>

    <div class="card border-0">
      <div class="table-responsive">
          {% include "quotations/extensions/_detail_table.html" %}
      </div>
    </div>
     <div class="mt-3">
          {% include "quotations/extensions/route_and_cargo.html" %}
     </div>
  </div>
</div>
<div class="modal fade" id="sendEmailModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">

      <form method="post" action="{% url 'job:quotation_send_email' quotation.id %}">
        {% csrf_token %}

        <div class="modal-header">
          <h5 class="modal-title">
            Send Email â€“ Quotation {{ quotation.number }}
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">

          <div class="mb-3">
            <label class="form-label">To</label>
            <input type="text"
                   name="to"
                   class="form-control"
                   value="{{ quotation.customer.email|default:'' }}"
                   placeholder="email@client.com">
            <div class="form-text">Pisahkan dengan koma jika lebih dari satu.</div>
          </div>

          <div class="mb-3">
            <label class="form-label">CC</label>
            <input type="text"
                   name="cc"
                   class="form-control"
                   placeholder="cc@company.com">
          </div>

          <div class="mb-3">
            <label class="form-label">Subject</label>
            <input type="text"
                   name="subject"
                   class="form-control"
                   value="Quotation {{ quotation.number }}">
          </div>

          <div class="mb-3">
            <label class="form-label">Message</label>
            <textarea name="message"
                      rows="6"
                      class="form-control">Yth. Bapak/Ibu,

Terlampir kami kirimkan quotation {{ quotation.number }}.

Terima kasih.</textarea>
          </div>

          <div class="form-check">
            <input class="form-check-input"
                   type="checkbox"
                   name="attach_pdf"
                   value="1"
                   checked>
            <label class="form-check-label">
              Attach PDF Quotation
            </label>
          </div>

        </div>

        <div class="modal-footer">
          <button type="button"
                  class="btn btn-sm btn-secondary"
                  data-bs-dismiss="modal">
            Cancel
          </button>
          <button type="submit" class="btn btn-primary btn-sm">
            Send Email
          </button>
        </div>

      </form>

    </div>
  </div>
</div>

{% endblock %}
