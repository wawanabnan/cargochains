
<!-- CLEAN edit_form.html (EST/ACT ONLY) -->
<script>
// Assumes fmtID/parseID helpers already exist on the page.
(function () {
  const tbody = document.getElementById("jobcost-body");
  const addBtn = document.getElementById("btn-jobcost-add");
  const tpl = document.getElementById("jobcost-empty-row");
  const prefix = "{{ cost_formset.prefix|default:'' }}";
  const totalForms = prefix ? document.querySelector(`input[name="${prefix}-TOTAL_FORMS"]`) : null;
  if (!tbody || !addBtn || !tpl || !prefix || !totalForms) return;

  function bindMoney(el) {
    if (!el) return;
    const format = () => { el.value = fmtID(parseID(el.value)); };
    el.addEventListener("blur", format);
    el.addEventListener("change", format);
    format();
  }

  function applyMode(row) {
    const ct = row.querySelector(`select[name^="${prefix}-"][name$="-cost_type"]`);
    const vw = row.querySelector(".js-vendor-wrap");
    const nw = row.querySelector(".js-internal-note-wrap");
    if (!vw || !nw) return;
    if (!ct || !ct.value) {
      vw.classList.add("d-none");
      nw.classList.remove("d-none");
      return;
    }
    const opt = ct.options[ct.selectedIndex];
    const requiresVendor = opt && opt.dataset && opt.dataset.requiresVendor === "1";
    if (requiresVendor) {
      vw.classList.remove("d-none");
      nw.classList.add("d-none");
    } else {
      vw.classList.add("d-none");
      const vendorSel = vw.querySelector("select");
      if (vendorSel) vendorSel.value = "";
      nw.classList.remove("d-none");
    }
  }

  function attachRow(row) {
    const est = row.querySelector(`input[name^="${prefix}-"][name$="-est_amount"]`);
    const act = row.querySelector(`input[name^="${prefix}-"][name$="-actual_amount"]`);
    if (!est && !act) return;
    bindMoney(est); bindMoney(act);
    const del = row.querySelector(`input[name^="${prefix}-"][name$="-DELETE"]`);
    const btn = row.querySelector(".remove-row");
    if (btn && del) btn.addEventListener("click", (e) => { e.preventDefault(); del.checked = true; row.classList.add("d-none"); });
    applyMode(row);
  }

  tbody.querySelectorAll("tr").forEach(attachRow);
  document.addEventListener("change", (e) => {
    const el = e.target;
    if (el && el.matches(`select[name^="${prefix}-"][name$="-cost_type"]`)) {
      const row = el.closest("tr"); if (row) applyMode(row);
    }
  });

  addBtn.addEventListener("click", (e) => {
    e.preventDefault();
    const idx = parseInt(totalForms.value || "0", 10);
    const html = tpl.innerHTML.replace(/__prefix__/g, idx).trim();
    const tmp = document.createElement("tbody"); tmp.innerHTML = html;
    const row = tmp.querySelector("tr"); if (!row) return;
    tbody.appendChild(row); totalForms.value = idx + 1;
    const est = row.querySelector(`input[name="${prefix}-${idx}-est_amount"]`);
    const act = row.querySelector(`input[name="${prefix}-${idx}-actual_amount"]`);
    if (est && !est.value) est.value = "0,00";
    if (act && !act.value) act.value = "0,00";
    attachRow(row);
  });
})();
</script>
