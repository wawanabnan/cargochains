{% extends "adminbase.html" %}
{% load humanize %}
{% load indo_format %}

{% block content %}

  <!-- HEADER -->
  <div class="app-content-header">
    <div class="container-fluid d-flex justify-content-between align-items-center">
      <h4 class="mb-0">Job Orders</h4>
      
    </div>
  </div>

<div  class="app-content">

    <div class="container-fluid">
    
              {% include 'job_order/extension/toolbar.html' %}
    </div>
        
    <div class="container-fluid mt-3">
      <div class="card">
          
          <div class="card-body p-0 border-0">
             {% include 'job_order/extension/table_list.html' %}

          </div>
      </div>
       
    </div>
</div>
 
<style>
  .row-clickable {
    cursor: pointer;
  }
  .table tr td {
    padding:8px 5px;
  }
</style>
<script>
document.addEventListener("DOMContentLoaded", function () {

  // ===== Row click =====
  document.querySelectorAll(".row-clickable").forEach(function (row) {
    row.addEventListener("click", function (e) {
      if (
        (e.target.tagName === "INPUT" && e.target.type === "checkbox") ||
        e.target.closest("button") ||
        e.target.closest("a")
      ) return;

      const url = row.dataset.url;
      if (url) window.location.href = url;
    });
  });

  // ===== Bulk elements =====
  const chkAll    = document.getElementById("chk-all");
  const bulkBox   = document.getElementById("bulk-actions");
  const selCount  = document.getElementById("sel-count");
  const searchBox = document.getElementById("search-box");   // ✅ tambah ini

  const btnPending = document.getElementById("btn-bulk-pending");
  const btnCancel  = document.getElementById("btn-bulk-cancel");

  function getSelectedIds() {
    return Array.from(document.querySelectorAll(".row-check:checked"))
      .map(c => c.dataset.id)
      .filter(Boolean);
  }

  function refreshBulkUI() {
    const count = getSelectedIds().length;

    if (selCount) selCount.textContent = count;

    // ✅ Switch search <-> bulk
    if (searchBox) {
      searchBox.classList.toggle("d-none", count > 0);
    }
    if (bulkBox) {
      bulkBox.classList.toggle("d-none", count === 0);
      bulkBox.classList.toggle("d-flex", count > 0); // optional: kalau mau inline flex
    }
  }

  // row checkbox change
  document.querySelectorAll(".row-check").forEach(function (chk) {
    chk.addEventListener("change", function () {
      if (!chk.checked && chkAll) chkAll.checked = false;
      refreshBulkUI();
    });
  });

  // check all
  if (chkAll) {
    chkAll.addEventListener("change", function () {
      document.querySelectorAll(".row-check").forEach(function (chk) {
        if (!chk.disabled) chk.checked = chkAll.checked;
      });
      refreshBulkUI();
    });
  }

  // ===== Submit bulk via normal POST form =====
  function submitBulk(action) {
    const ids = getSelectedIds();
    if (!ids.length) return alert("No selected");

    if (action === "cancel" && !confirm("Cancel selected job orders?")) return;

    let form = document.getElementById("bulk-form");
    if (!form) {
      form = document.createElement("form");
      form.id = "bulk-form";
      form.method = "POST";
      form.action = "{% url 'sales:joborder_bulk_status' %}";
      form.className = "d-none";
      form.innerHTML = `{% csrf_token %}
        <input type="hidden" name="action" id="bulk-action">
        <div id="bulk-ids"></div>`;
      document.body.appendChild(form);
    }

    form.querySelector("#bulk-action").value = action;
    const holder = form.querySelector("#bulk-ids");
    holder.innerHTML = "";

    ids.forEach(function (id) {
      const i = document.createElement("input");
      i.type = "hidden";
      i.name = "ids[]";
      i.value = id;
      holder.appendChild(i);
    });

    form.submit();
  }

  if (btnPending) btnPending.addEventListener("click", function () {
    submitBulk("pending");
  });
  if (btnCancel) btnCancel.addEventListener("click", function () {
    submitBulk("cancel");
  });

  // init
  refreshBulkUI();
});
</script>


{% endblock %}
