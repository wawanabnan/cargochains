{% extends "adminbase.html" %}
{% load static %}
{% load indo_format %}

{% block content %}
<div class="app-content-header">
  <div class="container-fluid">
    <div class="d-flex flex-wrap align-items-center justify-content-between gap-2">
      <div>
        <div class="d-flex align-items-center gap-2">
          <h3 class="mb-0">Job Order</h3>
          {% if job %}
            <span class="badge text-bg-primary">Update</span>
            <span class="text-muted small">#{{ job.number }}</span>
          {% else %}
            <span class="badge text-bg-success">Create</span>
          {% endif %}
        </div>
        <div class="text-muted small">Header information for job execution and billing</div>
      </div>

      <div class="d-flex align-items-center gap-2">
        <a href="{% url 'job:job_order_list' %}" class="btn btn-outline-secondary btn-sm">
          <i class="fa fa-arrow-left me-1"></i> Back
        </a>
        <button form="joborder-form" type="submit" class="btn btn-primary btn-sm">
          <i class="fa fa-save me-1"></i> Save
        </button>
      </div>
    </div>
  </div>
</div>

<div class="app-content">
  <div class="container-fluid">

<form method="post" enctype="multipart/form-data" novalidate>
  {% csrf_token %}

  {# --- HEADER / MAIN FIELDS (ringkas) --- #}
  
 <div class="card mb-2">
  <div class="card-body py-2">
    <div class="row g-2">

      {# COL 1 #}
      <div class="col-lg-3 col-md-6">
        <label class="form-label small text-muted mb-1">Job Date</label>
        {{ form.job_date }}

        <label class="form-label small text-muted mb-1 mt-2">Job Number</label>
        {# kalau add new belum ada number, tampilkan placeholder #}
        <div class="form-control form-control-sm bg-light">
          {{ job.job_number|default:"(Auto)" }}
        </div>
      </div>

      {# COL 2 #}
      <div class="col-lg-3 col-md-6">
        <label class="form-label small text-muted mb-1">Customer</label>
        {{ form.customer }}

        <label class="form-label small text-muted mb-1 mt-2">Sales PIC</label>
        {{ form.sales_user }}
      </div>

      {# COL 3 #}
      <div class="col-lg-3 col-md-6">
        <label class="form-label small text-muted mb-1">Mode</label>
        {{ form.mode }}

        <label class="form-label small text-muted mb-1 mt-2">Ref</label>
        {{ form.ref_no }}
      </div>

      {# COL 4 (money panel / currency) #}
      <div class="col-lg-3 col-md-6">
        <div class="border rounded-3 p-2 bg-body-tertiary">

          <div class="d-flex align-items-center justify-content-between mb-1">
            <div class="small text-muted">Currency</div>
            <div class="fw-semibold">
              {# untuk add new, tampilkan field currency (bukan job.currency) #}
              {{ form.currency }}
            </div>
          </div>

          <div class="d-flex align-items-center justify-content-between">
            <div class="small text-muted">Total</div>
            <div class="text-end">
              {{ job.total_amount|default:0|indo_number }}
            </div>
          </div>

          <div class="d-flex align-items-center justify-content-between">
            <div class="small text-muted">Tax</div>
            <div class="text-end">
              {{ job.tax_amount|default:0|indo_number }}
            </div>
          </div>

          <hr class="my-2">

          <div class="d-flex align-items-center justify-content-between">
            <div class="small text-muted">Grand Total</div>
            <div class="text-end fw-semibold fs-6">
              {{ job.grand_total|default:0|indo_number }}
            </div>
          </div>

        </div>
      </div>

    </div>

    {# ROW 2 (route) - optional, tetap ringkas #}
    <div class="row g-2 mt-1">
      <div class="col-lg-3 col-md-6">
        <label class="form-label small text-muted mb-1">Route From</label>
        {{ form.route_from }}
      </div>
      <div class="col-lg-3 col-md-6">
        <label class="form-label small text-muted mb-1">Route To</label>
        {{ form.route_to }}
      </div>

      <div class="col-lg-6 d-flex align-items-end justify-content-end gap-2">
        <button type="submit" class="btn btn-primary btn-sm">
          <i class="bi bi-check2-circle me-1"></i> Save
        </button>
        <a href="{% url 'job:job_order_list' %}" class="btn btn-outline-secondary btn-sm">
          Cancel
        </a>
      </div>
    </div>

  </div>
</div>


  {# --- TABS --- #}
  <div class="card">
    <div class="card-body p-0">

      <ul class="nav nav-tabs px-2 pt-2" id="jobTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active"
                  id="tab-costlines"
                  data-bs-toggle="tab"
                  data-bs-target="#pane-costlines"
                  type="button"
                  role="tab"
                  aria-controls="pane-costlines"
                  aria-selected="true">
            <i class="bi bi-receipt-cutoff me-1"></i> Cost Lines
          </button>
        </li>

        <li class="nav-item" role="presentation">
          <button class="nav-link"
                  id="tab-attachments"
                  data-bs-toggle="tab"
                  data-bs-target="#pane-attachments"
                  type="button"
                  role="tab"
                  aria-controls="pane-attachments"
                  aria-selected="false">
            <i class="bi bi-paperclip me-1"></i> Attachments
          </button>
        </li>

        <li class="nav-item" role="presentation">
          <button class="nav-link"
                  id="tab-notes"
                  data-bs-toggle="tab"
                  data-bs-target="#pane-notes"
                  type="button"
                  role="tab"
                  aria-controls="pane-notes"
                  aria-selected="false">
            <i class="bi bi-journal-text me-1"></i> Notes
          </button>
        </li>
      </ul>

      <div class="tab-content p-2" id="jobTabsContent">

        {# TAB 1: COST LINES #}
        <div class="tab-pane fade show active"
             id="pane-costlines"
             role="tabpanel"
             aria-labelledby="tab-costlines"
             tabindex="0">

          {# ⚠️ penting: include formset management form #}
          {{ cost_formset.management_form }}

          {# include partial cost lines table/formset #}
          {# include "job_order/partials/cost_lines_formset.html" with cost_formset=cost_formset job=job #}
        </div>

        {# TAB 2: ATTACHMENTS #}
        <div class="tab-pane fade"
             id="pane-attachments"
             role="tabpanel"
             aria-labelledby="tab-attachments"
             tabindex="0">

          {# kalau pakai attachment formset #}
          {% if attachment_formset %}
            {{ attachment_formset.management_form }}
            {% include "job_order/partials/attachments_formset.html" with attachment_formset=attachment_formset job=job %}
          {% else %}
            <div class="p-2 text-muted small">No attachment module linked.</div>
          {% endif %}
        </div>

        {# TAB 3: NOTES #}
        <div class="tab-pane fade"
             id="pane-notes"
             role="tabpanel"
             aria-labelledby="tab-notes"
             tabindex="0">

          <div class="p-2">
            <label class="form-label small text-muted mb-1">Internal Notes</label>
            {{ form.notes }}
            {% if form.notes.errors %}
              <div class="text-danger small mt-1">{{ form.notes.errors|striptags }}</div>
            {% endif %}
          </div>
        </div>

      </div>
    </div>
  </div>
</form>


  </div>
</div>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/airbnb.css">
<style>
  /* Container feel */
  
  /* Card polish */
  .cc-card { border-radius: 14px; border: 1px solid rgba(0,0,0,.06); }
  .cc-card-header { background: transparent; border-bottom: 1px solid rgba(0,0,0,.06); }

  /* Grid modern (2 columns inside, tapi keseluruhan tetap single-column) */
  .cc-grid {
    display: grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: 14px 14px;
  }
  .cc-span-2 { grid-column: span 2; }

  /* Field style */
  .cc-field .form-label { font-size: .78rem; font-weight: 600; color: rgba(0,0,0,.72); margin-bottom: 6px; }
  .cc-field .form-control,
  .cc-field .form-select { border-radius: 10px; }
  .cc-field .input-group .form-control { border-top-left-radius: 10px; border-bottom-left-radius: 10px; }
  .cc-field .input-group-text { border-top-right-radius: 10px; border-bottom-right-radius: 10px; }

  /* Error */
  .cc-err ul, .cc-err { margin: 6px 0 0; }
  .cc-err { font-size: .78rem; color: #dc3545; }
  .cc-err ul { padding-left: 18px; }

  /* Switch boxes */
  .cc-switches { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 12px; }
  .cc-switch { border: 1px solid rgba(0,0,0,.06); border-radius: 14px; padding: 12px; background: rgba(0,0,0,.015); }

  /* Mobile */
  @media (max-width: 991px) {
    .cc-grid { grid-template-columns: 1fr; }
    .cc-span-2 { grid-column: span 1; }
    .cc-switches { grid-template-columns: 1fr; }
  }


  /* ===============================
   FORM STYLING ONLY (SAFE)
   =============================== */

.cc-card {
  border-radius: 12px;
  border: 1px solid rgba(0,0,0,.06);
}

.cc-card-header {
  background: transparent;
  border-bottom: 1px solid rgba(0,0,0,.06);
  padding: .6rem .9rem;
}

.cc-card .card-body {
  padding: .9rem;
}

/* 2 kolom, rapat */
.cc-grid {
  display: grid;
  grid-template-columns: repeat(2, minmax(0, 1fr));
  gap: 10px 12px;
}

.cc-span-2 {
  grid-column: span 2;
}

/* Field */
.cc-field .form-label {
  font-size: .78rem;
  font-weight: 600;
  margin-bottom: 4px;
  color: rgba(0,0,0,.75);
}

.cc-field .form-control,
.cc-field .form-select {
  min-height: 34px;
  font-size: .875rem;
  border-radius: 8px;
}

.cc-field textarea.form-control {
  min-height: 88px;
}

/* Error */
.cc-err {
  margin-top: 3px;
  font-size: .75rem;
  color: #dc3545;
}

/* Switch group tetap kecil */
.cc-switches {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
}

.cc-switch {
  border: 1px solid rgba(0,0,0,.06);
  border-radius: 10px;
  padding: 8px;
  background: rgba(0,0,0,.015);
}

/* Mobile */
@media (max-width: 991px) {
  .cc-grid { grid-template-columns: 1fr; }
  .cc-span-2 { grid-column: span 1; }
  .cc-switches { grid-template-columns: 1fr; }
}

</style>
{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

{# JS om tetap dipakai (copy dari versi sebelumnya) #}
<script>
(function(){
  function parseID(v) {
    if (!v) return 0;
    let s = String(v).trim();
    if (s.indexOf(",") >= 0) {
      s = s.replace(/\./g, "").replace(",", ".");
      const n = parseFloat(s);
      return isNaN(n) ? 0 : n;
    }
    const n = parseFloat(s);
    return isNaN(n) ? 0 : n;
  }

  function fmtID(n){
    return Number(n || 0).toLocaleString("id-ID", {
      minimumFractionDigits: 2,
      maximumFractionDigits: 2
    });
  }

  function recalc(){
    const totalEl = document.getElementById("id_total_amount");
    const taxEl   = document.getElementById("id_tax_amount");
    const grandEl = document.getElementById("id_grand_total");
    const isTaxEl = document.getElementById("id_is_tax");
    const pphEl   = document.getElementById("id_pph_amount");
    const isPphEl = document.getElementById("id_is_pph");
    if (!totalEl || !taxEl || !grandEl) return;

    let total = parseID(totalEl.value);
    let tax   = (isTaxEl && isTaxEl.checked) ? total * 0.011 : 0;
    let pph   = (isPphEl && isPphEl.checked) ? total * 0.02 : 0;
    let grand = total + tax - pph;

    totalEl.value = fmtID(total);
    taxEl.value   = fmtID(tax);
    if (pphEl) pphEl.value = fmtID(pph);
    grandEl.value = fmtID(grand);
  }

  document.addEventListener("DOMContentLoaded", function(){
    const totalEl = document.getElementById("id_total_amount");
    const taxEl   = document.getElementById("id_tax_amount");
    const grandEl = document.getElementById("id_grand_total");
    const isTaxEl = document.getElementById("id_is_tax");
    const pphEl   = document.getElementById("id_pph_amount");
    const isPphEl = document.getElementById("id_is_pph");
    const form    = document.querySelector("form");

    const currencyEl = document.getElementById("id_currency");
    const kursRow    = document.getElementById("row-kurs");
    const kursInput  = document.getElementById("id_kurs_idr");

    function toggleKurs() {
      if (!currencyEl || !kursRow || !kursInput) return;
      const selected = currencyEl.options[currencyEl.selectedIndex].text.trim();
      if (selected !== "IDR") kursRow.style.display = "";
      else { kursRow.style.display = "none"; kursInput.value = "1,00"; }
    }

    if (currencyEl) {
      toggleKurs();
      currencyEl.addEventListener("change", toggleKurs);
    }

    if (taxEl) taxEl.readOnly = true;
    if (pphEl) pphEl.readOnly = true;

    if (totalEl) {
      totalEl.addEventListener("blur", recalc);
      totalEl.addEventListener("change", recalc);
    }
    if (isTaxEl) isTaxEl.addEventListener("change", recalc);
    if (isPphEl) isPphEl.addEventListener("change", recalc);

    recalc();

    if (form) {
      form.addEventListener("submit", function(){
        if (totalEl) totalEl.value = parseID(totalEl.value);
        if (taxEl) taxEl.value   = parseID(taxEl.value);
        if (grandEl) grandEl.value = parseID(grandEl.value);
        if (pphEl) pphEl.value = parseID(pphEl.value);
        if (kursInput) kursInput.value = parseID(kursInput.value);
      });
    }

    if (typeof flatpickr !== "undefined") {
      document.querySelectorAll(".js-jobdate").forEach(function (el) {
        const fp = flatpickr(el, { dateFormat: "d-m-Y", allowInput: true, clickOpens: true });
        el.addEventListener("focus", function () { fp.open(); });
      });
    }
  });
})();
</script>
{% endblock %}
