{% extends "adminbase.html" %}
{% load static %}

{% block content %}

<div class="app-content-header">
  <div class="container-fluid">
    <div class="row">
      <div class="col-sm-6">
        <h3 class="mb-0">Job Orders</h3>
      </div>
      <div class="col-sm-6">
        <ol class="breadcrumb float-sm-end">
          <li class="breadcrumb-item active" aria-current="page">
            <a href="{% url 'sales:job_order_list' %}" class="btn btn-outline-secondary btn-sm">
              <i class="fa fa-list me-1"></i> Back to List
            </a>

          </li>
        </ol>
      </div>
    </div>
  </div>
</div>

<div class="app-content">
  <div class="container-fluid ">
    <div class="card">
      <div class="card-body">

        {% if form.non_field_errors %}
          <div class="alert alert-danger">{{ form.non_field_errors }}</div>
        {% endif %}

        {% if form.errors or form.non_field_errors %}
  <div class="alert alert-danger">
    <ul class="mb-0">
      {% for field, errors in form.errors.items %}
        {% for error in errors %}
          <li><strong>{{ field }}:</strong> {{ error }}</li>
        {% endfor %}
      {% endfor %}
      {% for error in form.non_field_errors %}
        <li>{{ error }}</li>
      {% endfor %}
    </ul>
  </div>
{% endif %}
        <form method="post" novalidate>
          {% csrf_token %}

          {% if job %}
            <input type="hidden" name="job_id" value="{{ job.pk }}">
          {% endif %}

          <!-- ======================= JOB INFO ======================= -->
        <div class="container-fluid py-3">
          <div class="row">
              <div class="col px-4">
                {% include 'job_orders/extension/col_1.html' %}

              </div>
              
              <div class="col px-4">
                {% include 'job_orders/extension/col_2.html' %}
              </div>

          </div>
          

        </div>
        
        

          <hr>
          <div class="mt-1"></div>
          <!-- SUBMIT -->
          <div class="mt-4 d-flex justify-content-end gap-2">

            <a href="{% url 'sales:job_order_list' %}"
              class="btn btn-outline-secondary">
              <i class="fa fa-times me-1"></i> Cancel
            </a>

            <button type="submit" class="btn btn-primary">
              <i class="fa fa-save me-1"></i>
              {% if job %}Update{% else %}Create{% endif %}
            </button>

          </div>


        </form>
      </div>
      
    </div>

  </div>
</div>
{% endblock %}
{% block extra_css %}
<link rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/airbnb.css">

{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>



<script>
(function(){

  function parseID(v) {
    if (!v) return 0;
    let s = String(v).trim();

    // Kalau ada koma → style Indonesia: 20.000.000,00
    if (s.indexOf(",") >= 0) {
      s = s.replace(/\./g, "").replace(",", ".");
      const n = parseFloat(s);
      return isNaN(n) ? 0 : n;
    }

    // Kalau TIDAK ada koma → anggap "." itu desimal biasa
    const n = parseFloat(s);
    return isNaN(n) ? 0 : n;
  }

  function fmtID(n){
    return Number(n || 0).toLocaleString("id-ID", {
      minimumFractionDigits: 2,
      maximumFractionDigits: 2
    });
  }

  function recalc(){
    const totalEl = document.getElementById("id_total_amount");
    const taxEl   = document.getElementById("id_tax_amount");
    const grandEl = document.getElementById("id_grand_total");
    const isTaxEl = document.getElementById("id_is_tax");

    const pphEl   = document.getElementById("id_pph_amount");
    const isPphEl = document.getElementById("id_is_pph");

    if (!totalEl || !taxEl || !grandEl) return;

    let total = parseID(totalEl.value);
    let tax   = (isTaxEl && isTaxEl.checked) ? total * 0.011 : 0;
    let pph   = (isPphEl && isPphEl.checked) ? total * 0.02 : 0;  // 2% PPH

    let grand = total + tax - pph;

    totalEl.value = fmtID(total);
    taxEl.value   = fmtID(tax);
    if (pphEl) {
      pphEl.value = fmtID(pph);
    }
    grandEl.value = fmtID(grand);
  }

  document.addEventListener("DOMContentLoaded", function(){

    const totalEl = document.getElementById("id_total_amount");
    const taxEl   = document.getElementById("id_tax_amount");
    const grandEl = document.getElementById("id_grand_total");
    const isTaxEl = document.getElementById("id_is_tax");
    const pphEl   = document.getElementById("id_pph_amount");
    const isPphEl = document.getElementById("id_is_pph");
    const form    = document.querySelector("form");

    const currencyEl = document.getElementById("id_currency");
    const kursRow    = document.getElementById("row-kurs");
    const kursInput  = document.getElementById("id_kurs_idr");

    if(!form || !totalEl) return;

    // --- TAMPIL / SEMBUNYIKAN KURS ---
    function toggleKurs() {
      if (!currencyEl || !kursRow || !kursInput) return;

      const selected = currencyEl.options[currencyEl.selectedIndex].text.trim();
      if (selected !== "IDR") {
        kursRow.style.display = "";
      } else {
        kursRow.style.display = "none";
        kursInput.value = "1,00";
      }
    }

    if (currencyEl) {
      toggleKurs();
      currencyEl.addEventListener("change", toggleKurs);
    }

    // lock kolom tax & pph (readonly)
    if (taxEl) taxEl.readOnly = true;
    if (pphEl) pphEl.readOnly = true;

    // --- auto-select saat focus ---
    [totalEl, grandEl].forEach(function(el){
      if (!el) return;
      el.addEventListener("focus", ()=> setTimeout(()=>el.select(),0));
    });

    // kalau mau, PPh juga auto-select
    if (pphEl) {
      pphEl.addEventListener("focus", ()=> setTimeout(()=>pphEl.select(),0));
    }

    // --- perhitungan ---
    totalEl.addEventListener("blur", recalc);
    totalEl.addEventListener("change", recalc);
    if (isTaxEl) isTaxEl.addEventListener("change", recalc);
    if (isPphEl) isPphEl.addEventListener("change", recalc);

    // --- format pertama kali ---
    recalc();

    // --- sebelum submit → convert ke number plain (Django Decimal aman) ---
    form.addEventListener("submit", function(){
      totalEl.value = parseID(totalEl.value);
      taxEl.value   = parseID(taxEl.value);
      grandEl.value = parseID(grandEl.value);
      if (pphEl) {
        pphEl.value = parseID(pphEl.value);
      }
      if (kursInput) {
        kursInput.value = parseID(kursInput.value);
      }
    });

      if (typeof flatpickr === "undefined") {
        console.warn("Flatpickr belum ter-load");
        return;
      }

      const inputs = document.querySelectorAll(".js-jobdate");
      if (!inputs.length) return;

      inputs.forEach(function (el) {
        const fp = flatpickr(el, {
          dateFormat: "d-m-Y",      // tampilan ke user
          allowInput: true,
          clickOpens: true,
          altInput: false,          // biar tetap pakai form-control yang ada
          defaultDate: el.value || null,
          locale: {
            firstDayOfWeek: 1
          }
        });

      // auto show saat got focus
      el.addEventListener("focus", function () {
        fp.open();
      });
    });


  });

})();
</script>

{% endblock %}
