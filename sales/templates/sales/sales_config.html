{% extends "adminbase.html" %}

{% block content %}
<div class="app-content">
  <div class="container-fluid">
    <div class="card shadow-sm">
      <div class="card-header d-flex align-items-center justify-content-between">
        <div>
          <div class="fw-semibold">Configuration</div>
          <div class="text-secondary small">Default configuration untuk Quotation / Job Order / Service Order</div>
        </div>
      </div>

      <form method="post" novalidate id="sales-settings-form">
        {% csrf_token %}
        {{ form.media }}
        <div class="card-body">
          {% if form.non_field_errors %}
            <div class="alert alert-danger py-2">{{ form.non_field_errors }}</div>
          {% endif %}

          {# ===================== GENERAL (OUTSIDE TAB) ===================== #}
          <div class="row">
              <div class="col-md-5">
                 <div class="row mb-2">
                    <div class="col-md-12">
                      <label class="form-label small mb-1">Default Currency</label>
                      {{ form.default_currency }}
                      {% if form.default_currency.errors %}<div class="text-danger small mt-1">{{ form.default_currency.errors }}</div>{% endif %}
                    </div>
                 </div>

                <div class="row mb-2">
                    <div class="col-md-12">
                      <label class="form-label small mb-1">Quotation Valid Days</label>
                      {{ form.quotation_valid_days }}
                      <div class="text-secondary small mt-1">0 = tidak pakai masa berlaku.</div>  
                    {% if form.quotation_valid_days.errors %}<div class="text-danger small mt-1">{{ form.quotation_valid_days.errors }}</div>{% endif %}
                      </div>
                  </div>

                <div class="row mb-2">
                  <div class="col-md-12">  
                    <label class="form-label small mb-1">Sales Fee (%)</label>
                    {{ form.sales_fee_percent }}
                    {% if form.sales_fee_percent.errors %}<div class="text-danger small mt-1">{{ form.sales_fee_percent.errors }}</div>{% endif %}
                    </div>
                  </div>
              </div>
              <div class="col-md-1"></div>
              <div class="col-md-5">
                  <label class="form-label small ">Default Term of Payment</label>
                    {{ form.default_payment_term  }}
                   <label class="form-label small mb-1">Bank Transfer Info</label>
                    {{ form.bank_transfer_info  }} 

              </div>

          </div>
         

          <hr class="my-4">

          {# ===================== TABS ===================== #}
          <ul class="nav nav-tabs" id="cfgTabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="tab-qj" data-bs-toggle="tab" data-bs-target="#pane-qj"
                      type="button" role="tab" aria-controls="pane-qj" aria-selected="true">
                Quote &amp; Job
              </button>
            </li>

            <li class="nav-item" role="presentation">
              <button class="nav-link" id="tab-so" data-bs-toggle="tab" data-bs-target="#pane-so"
                      type="button" role="tab" aria-controls="pane-so" aria-selected="false">
                Service Order
              </button>
            </li>
            
          </ul>

          <div class="tab-content border border-top-0 rounded-bottom p-3" id="cfgTabsContent">

            {# ===================== TAB 1: QUOTE & JOB ===================== #}
            <div class="tab-pane fade show active" id="pane-qj" role="tabpanel" aria-labelledby="tab-qj" tabindex="0">

              <div class="border rounded p-3">
                <div class="fw-semibold small mb-1">Signature Settings</div>
                <div class="text-secondary small mb-3">
                  Pilih sumber tanda tangan untuk dokumen Quotation dan Job Order.
                </div>

                <div class="row g-3">
                  <div class="col-lg-6">
                    <div class="fw-semibold small mb-2">Quotation Signature</div>

                    <label class="form-label small mb-1">Source</label>
                    {{ form.quotation_signature_source }}
                    {% if form.quotation_signature_source.errors %}<div class="text-danger small mt-1">{{ form.quotation_signature_source.errors }}</div>{% endif %}

                    <label class="form-label small mb-1 mt-2">Specific User</label>
                    {{ form.quotation_signature_user }}
                    <div class="text-secondary small mt-1">Dipakai hanya jika source = Specific User.</div>
                    {% if form.quotation_signature_user.errors %}<div class="text-danger small mt-1">{{ form.quotation_signature_user.errors }}</div>{% endif %}
                  </div>

                  <div class="col-lg-6">
                    <div class="fw-semibold small mb-2">Job Order Signature</div>

                    <label class="form-label small mb-1">Source</label>
                    {{ form.joborder_signature_source }}
                    {% if form.joborder_signature_source.errors %}<div class="text-danger small mt-1">{{ form.joborder_signature_source.errors }}</div>{% endif %}

                    <label class="form-label small mb-1 mt-2">Specific User</label>
                    {{ form.joborder_signature_user }}
                    <div class="text-secondary small mt-1">Dipakai hanya jika source = Specific User.</div>
                    {% if form.joborder_signature_user.errors %}<div class="text-danger small mt-1">{{ form.joborder_signature_user.errors }}</div>{% endif %}
                  </div>
                </div>
              </div>

              <div class="row g-3 mt-3">
                <div class="col-lg-6">
                  <label class="form-label small mb-1">Customer Note (Default)</label>
                  {{ form.customer_note }}
                  {% if form.customer_note.errors %}<div class="text-danger small mt-1">{{ form.customer_note.errors }}</div>{% endif %}
                </div>

                <div class="col-lg-6">
                  <label class="form-label small mb-1">Term &amp; Conditions (Default)</label>
                  {{ form.term_conditions }}
                  {% if form.term_conditions.errors %}<div class="text-danger small mt-1">{{ form.term_conditions.errors }}</div>{% endif %}
                </div>
              </div>
            </div>

          
            {# ===================== TAB 2: SERVICE ORDER ===================== #}
          <div class="tab-pane fade" id="pane-so" role="tabpanel" aria-labelledby="tab-so" tabindex="0">
            <div class="row g-3">

              <div class="col-lg-6 mt-2">
                <div class="fw-semibold small mb-2">Service Order Signature</div>

                <label class="form-label small mb-1">Source</label>
                {{ form.service_order_signature_source }}
                {% if form.service_order_signature_source.errors %}<div class="text-danger small mt-1">{{ form.service_order_signature_source.errors }}</div>{% endif %}
                </div>
                <div class="col-lg-6 mt-2">
                <label class="form-label small mb-1 mt-2">Specific User</label>
                {{ form.service_order_signature_user }}
                <div class="text-secondary small mt-1">Dipakai hanya jika source = Specific User.</div>
                {% if form.service_order_signature_user.errors %}<div class="text-danger small mt-1">{{ form.service_order_signature_user.errors }}</div>{% endif %}
              </div>
            </div>
            <div class="row g-3">

              <div class="col-lg-6">
                <label class="form-label small mb-1">Vendor Note (Default)</label>
                {{ form.vendor_note }}
                {% if form.vendor_note.errors %}<div class="text-danger small mt-1">{{ form.vendor_note.errors }}</div>{% endif %}
              </div>

              <div class="col-lg-6">
                <label class="form-label small mb-1">Term &amp; Conditions (Service Order)</label>
                {{ form.service_order_term_conditions }}
                {% if form.service_order_term_conditions.errors %}<div class="text-danger small mt-1">{{ form.service_order_term_conditions.errors }}</div>{% endif %}
              </div>

            

            </div>
          </div>
          
          

          </div> {# /tab-content #}

        </div> {# /card-body #}

        <div class="card-footer d-flex justify-content-end gap-2">
          <button type="button" class="btn btn-primary btn-sm" id="btn-save-ajax">
            <i class="bi bi-save me-1"></i> Save
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
  {{ block.super }}

  <script src="https://cdn.tiny.cloud/1/klpop8ud5zsip7zloht3kglaf0it7sau7hlm7yfscb3cjxsq/tinymce/6/tinymce.min.js"
          referrerpolicy="origin"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {
  // TinyMCE: keep SAME config as before, only extend selector
  tinymce.init({
    //selector: "#id_customer_note, #id_term_conditions, #id_vendor_note, #id_service_order_term_conditions",
    height: 380,
    menubar: false,
    plugins: "lists link table code autoresize",
    toolbar: "undo redo | bold italic underline | bullist numlist | link table | removeformat | code",
    branding: false,
    setup: function (editor) {
      editor.on("change keyup", function () { editor.save(); });
    }
  });

  function syncSignatureUI() {
    const qSrc = document.getElementById("id_quotation_signature_source");
    const qUser = document.getElementById("id_quotation_signature_user");
    const jSrc = document.getElementById("id_joborder_signature_source");
    const jUser = document.getElementById("id_joborder_signature_user");

    function toggle(srcEl, userEl) {
      if (!srcEl || !userEl) return;
      const v = (srcEl.value || "").toUpperCase();
      userEl.disabled = (v !== "SPECIFIC_USER");
    }

    toggle(qSrc, qUser);
    toggle(jSrc, jUser);
  }

  syncSignatureUI();
  document.getElementById("id_quotation_signature_source")?.addEventListener("change", syncSignatureUI);
  document.getElementById("id_joborder_signature_source")?.addEventListener("change", syncSignatureUI);

  // keep active tab after reload/save using hash (optional but nice)
  if (window.location.hash) {
    const tgt = window.location.hash;
    const btn = document.querySelector(`button[data-bs-target="${tgt}"]`);
    if (btn && window.bootstrap) {
      new bootstrap.Tab(btn).show();
    }
  }
  document.querySelectorAll('button[data-bs-toggle="tab"]').forEach((btn) => {
    btn.addEventListener("shown.bs.tab", (e) => {
      window.location.hash = e.target.getAttribute("data-bs-target");
    });
  });

  const form = document.getElementById("sales-settings-form");
  const btn = document.getElementById("btn-save-ajax");
  if (!form || !btn) return;

  async function ajaxSave() {
    if (window.tinymce) tinymce.triggerSave();

    btn.disabled = true;
    try {
      const resp = await fetch(window.location.href, {
        method: "POST",
        headers: { "X-Requested-With": "XMLHttpRequest" },
        body: new FormData(form),
      });

      const data = await resp.json().catch(() => ({}));
      if (!resp.ok || !data.ok) {
        alert((data && data.message) ? data.message : "Save failed");
        console.log("errors:", data.errors || data);
        return;
      }
      alert("Setting has been saved");
    } catch (err) {
      alert("Save failed (server/network)");
      console.log(err);
    } finally {
      btn.disabled = false;
    }
  }

  btn.addEventListener("click", function (e) {
    e.preventDefault();
    ajaxSave();
  });

  form.addEventListener("submit", function (e) {
    e.preventDefault();
    ajaxSave();
  });
});
</script>
{% endblock %}
