{% extends "adminbase.html" %}
{% load indo_format %}

{% block content %}


  <!-- HEADER -->
  <div class="app-content-header">
    <div class="container-fluid d-flex justify-content-between align-items-center">
      <h3 class="mb-0">Freight Quotations</h3>
      <a href="{% url 'sales:fq_add' %}" class="btn btn-primary btn-sm">
        <i class="fa fa-plus me-1"></i> New
      </a>
    </div>
  </div>

  <!-- MAIN CONTENT -->
  <section class="content">
    <div class="container-fluid">

      <!-- ============================= -->
      <!--     SEARCH BAR + TOOLBAR      -->
      <!-- ============================= -->
      <div class="card border-0 mb-3">
        <div class="card-body">

          <div id="quotations-toolbar"
               class="d-flex justify-content-between align-items-center gap-2 mb-2">

            <!-- LEFT: NEW BUTTON -->
            <div class="d-flex align-items-center gap-2">
              <a href="{% url 'sales:fq_add' %}" class="btn btn-primary btn-sm">
                <i class="fa fa-plus me-1"></i> New
              </a>
            </div>

            <!-- CENTER: SEARCH BOX or BULK ACTIONS -->
            <div class="flex-grow-1 d-flex justify-content-center">

              <!-- SEARCH (default) -->
              <div id="search-box" class="flex-grow-1 d-flex justify-content-center">
                <form method="get"
                      class="input-group input-group-sm rounded-pill overflow-hidden shadow-sm border"
                      style="max-width:500px;">
                  <input type="search" name="q" value="{{ q }}"
                         class="form-control ps-3 border-0 bg-body"
                         placeholder="Search quotations..." autocomplete="off">

                  <button class="btn btn-outline-secondary border-0 bg-body" type="submit">
                    <i class="fa fa-search"></i>
                  </button>

                  <!-- pertahankan parameter lain -->
                  <input type="hidden" name="sort" value="{{ sort }}">
                  <input type="hidden" name="dir"  value="{{ dir }}">
                  <input type="hidden" name="sp"   value="{{ sp }}">
                </form>
              </div>

              <!-- BULK ACTIONS (hidden default) -->
              <div id="bulk-actions" class="d-none align-items-center gap-2">
                <span class="badge text-bg-secondary me-2 btn-sm-match">
                  <span id="sel-count">0</span> selected
                </span>
                <button type="button" class="btn btn-danger btn-sm me-2" id="btn-bulk-delete">
                  <i class="fa fa-trash me-1"></i> Delete
                </button>
                <!-- tombol lain menyusul -->
              </div>

            </div>

            <!-- RIGHT: FILTER BUTTON -->
            <div>
              <button class="btn btn-outline-secondary btn-sm"
                      data-bs-toggle="offcanvas"
                      data-bs-target="#filterSheet">
                <i class="fa fa-filter me-1"></i> Filter
              </button>
            </div>
          </div>

        </div>
      </div>

      <!-- ============================= -->
      <!--         TABLE LIST            -->
      <!-- ============================= -->
      <div class="card">
        <div class="card-body p-0">

          <div class="table-responsive">
            <table class="table table-hover mb-0">
              <thead class="table-light">
                <tr>
                  <th style="width: 4%">
                    <input type="checkbox" id="chk-all">
                  </th>
                  <th style="width: 10%">Number</th>
                  <th style="width: 10%">Valid Until</th>
                  <th style="width: 10%">Shp. Plan</th>
                  <th>Customer</th>
                  <th style="width: 7%;">Services</th>
                  {% if perms.sales.view_all_sales %}
                  <th style="width: 5%">Sales</th>
                  {% endif %}
                  <th class="text-center" style="width: 10%">Currency</th>
                  <th class="text-end" style="width: 10%">Total</th>
                  <th class="text-center" style="width: 10%">Status</th>
                </tr>
              </thead>

              <tbody>
                {% if quotations %}
                  {% for fq in quotations %}
                    <tr class="row-clickable"
                        data-url="{% url 'sales:fq_detail' fq.pk %}"
                        data-status="{{ fq.status|default:'draft'|lower }}">

                      <td onclick="event.stopPropagation();">
                        <input type="checkbox" class="chk-row" value="{{ fq.pk }}">
                      </td>
                      <td>{{ fq.number }}</td>
                      <td>{{ fq.valid_until|date:"d-m-y" }}</td>
                      <td>{{ fq.shipment_plan_date|date:"d-m-Y" }}</td>
                      <td>{{ fq.customer.company_name|default:fq.customer.name }}</td>
                      <td>{{ fq.sales_service.code }}</td>

                      {% if perms.sales.view_all_sales %}
                      <td>{{ fq.sales_user.username }}</td>
                      {% endif %}
                      <td class="text-center">{{ fq.currency }}</td>

                      <td class="text-end">
                        {{ fq.total_amount|indo_number }} 
                      </td>

                      <td class="text-center">
                        {% with s=fq.status|default:"draft"|lower %}
                          {% if s == "accepted" %}
                            <span class="badge bg-success">Accepted</span>
                          {% elif s == "cancelled" %}
                            <span class="badge bg-danger">Cancelled</span>
                          {% elif s == "expired" %}
                            <span class="badge bg-warning text-dark">Expired</span>
                          {% elif s == "draft" %}
                            <span class="badge bg-secondary">Draft</span>
                          {% elif s == "sent" %}
                            <span class="badge bg-danger">Sent</span>
                          {% elif s == "ordered" %}
                            <span class="badge bg-info">Ordered</span>
                          {% else %}
                            <span class="badge bg-warning">{{ s|title }}</span>
                          {% endif %}
                        {% endwith %}
                      </td>

                    </tr>
                  {% endfor %}
                {% else %}
                  <tr>
                    <td colspan="10" class="text-center py-4">
                      No Freight Quotations found.
                    </td>
                  </tr>
                {% endif %}
              </tbody>
            </table>
          </div>

        </div>

        <!-- PAGINATION -->
        {% if is_paginated %}
        <div class="card-footer">
          <nav aria-label="Quotation pages">
            <ul class="pagination mb-0 justify-content-end">

              <!-- Previous -->
              {% if page_obj.has_previous %}
                <li class="page-item">
                  <a class="page-link"
                     href="?page={{ page_obj.previous_page_number }}">
                    Previous
                  </a>
                </li>
              {% else %}
                <li class="page-item disabled">
                  <span class="page-link">Previous</span>
                </li>
              {% endif %}

              <!-- Page numbers -->
              {% for num in page_obj.paginator.page_range %}
                {% if num == page_obj.number %}
                  <li class="page-item active">
                    <span class="page-link">{{ num }}</span>
                  </li>
                {% elif num > page_obj.number|add:"-3" and num < page_obj.number|add:"3" %}
                  <li class="page-item">
                    <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                  </li>
                {% endif %}
              {% endfor %}

              <!-- Next -->
              {% if page_obj.has_next %}
                <li class="page-item">
                  <a class="page-link" href="?page={{ page_obj.next_page_number }}">
                    Next
                  </a>
                </li>
              {% else %}
                <li class="page-item disabled">
                  <span class="page-link">Next</span>
                </li>
              {% endif %}

            </ul>
          </nav>
        </div>
        {% endif %}

      </div>

      <!-- ============================= -->
      <!--       FILTER OFFCANVAS        -->
      <!-- ============================= -->
      <div class="offcanvas offcanvas-end" tabindex="-1" id="filterSheet">
        <div class="offcanvas-header">
          <h5 class="offcanvas-title">Filters</h5>
          <button type="button" class="btn-close"
                  data-bs-dismiss="offcanvas"
                  aria-label="Close"></button>
        </div>

        <form class="offcanvas-body" method="get">

          <div class="mb-3">
            <label class="form-label small">Status</label>
            <select name="status" class="form-select form-select-sm" multiple>
              {% for value, label in status_choices %}
                <option value="{{ value }}" {% if value in flt_statuses %}selected{% endif %}>
                  {{ label }}
                </option>
              {% endfor %}
            </select>
            <div class="form-text">Gunakan Ctrl/Cmd untuk pilih lebih dari satu.</div>
          </div>

          <div class="mb-3">
            <label class="form-label small">Currency</label>
            <select name="currency" class="form-select form-select-sm" multiple>
              {% for c in currencies %}
                <option value="{{ c.pk }}" {% if c.pk in flt_currencies %}selected{% endif %}>
                  {{ c.code }}
                </option>
              {% endfor %}
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label small">Service</label>
            <select name="service" class="form-select form-select-sm" multiple>
              {% for s in services %}
                <option value="{{ s.pk }}" {% if s.pk in flt_services %}selected{% endif %}>
                  {{ s.name }}
                </option>
              {% endfor %}
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label small">Sales Agent</label>
            <select name="agent" class="form-select form-select-sm" multiple>
              {% for a in agents %}
                <option value="{{ a.pk }}" {% if a.pk in flt_agents %}selected{% endif %}>
                  {{ a.name }}
                </option>
              {% endfor %}
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label small">Payment Term</label>
            <select name="payment_term" class="form-select form-select-sm" multiple>
              {% for p in paymentterms %}
                <option value="{{ p.pk }}" {% if p.pk in flt_paymentterms %}selected{% endif %}>
                  {{ p.name }}
                </option>
              {% endfor %}
            </select>
          </div>

          <!-- pertahankan parameter lain -->
          <input type="hidden" name="q"    value="{{ q }}">
          <input type="hidden" name="sort" value="{{ sort }}">
          <input type="hidden" name="dir"  value="{{ dir }}">
          <input type="hidden" name="sp"   value="{{ sp }}">

          <div class="d-flex justify-content-end gap-2 mt-3">
            <button class="btn btn-primary btn-sm" type="submit">
              <i class="fa fa-check me-1"></i> Apply
            </button>
            <button type="button" class="btn btn-outline-secondary btn-sm"
                    id="btn-reset-filters">
              <i class="fa fa-undo me-1"></i> Reset
            </button>
          </div>

        </form>
      </div>

      <!-- BULK FORM -->
      <form id="bulk-form"
            method="post"
            action="{% url 'sales:fq_bulk_delete' %}"
            class="d-none">
        {% csrf_token %}
        <input type="hidden" name="ids" id="bulk-ids">
      </form>

    </div>
  </section>


<style>
  .row-clickable {
    cursor: pointer;
  }
</style>

<script>
document.addEventListener("DOMContentLoaded", function () {

  console.log("Freight quotation list JS loaded");

  // ===========================
  // 1) ROW CLICK â†’ OPEN DETAIL
  // ===========================
  var rows = document.querySelectorAll(".row-clickable");

  rows.forEach(function (row) {
    row.addEventListener("click", function (e) {
      // kalau klik checkbox, jangan buka detail
      if (e.target.tagName === "INPUT" && e.target.type === "checkbox") {
        return;
      }

      var url = row.dataset.url;
      if (url) {
        window.location.href = url;
      }
    });
  });

  // ===========================
  // 2) BULK SELECTION UI
  // ===========================
  var chkAll       = document.getElementById("chk-all");
  var chkRows      = document.querySelectorAll(".chk-row");
  var selCountSpan = document.getElementById("sel-count");
  var searchBox    = document.getElementById("search-box");
  var bulkActions  = document.getElementById("bulk-actions");

  function updateBulkUI() {
    var checkedCount = document.querySelectorAll(".chk-row:checked").length;

    if (selCountSpan) {
      selCountSpan.textContent = checkedCount;
    }

    if (!searchBox || !bulkActions) {
      return;
    }

    if (checkedCount > 0) {
      // sembunyikan search, tampilkan bulk
      searchBox.classList.add("d-none");
      bulkActions.classList.remove("d-none");
      bulkActions.classList.add("d-flex");
    } else {
      // tampilkan search, sembunyikan bulk
      searchBox.classList.remove("d-none");
      bulkActions.classList.add("d-none");
      bulkActions.classList.remove("d-flex");
    }
  }

  // "Select all"
  if (chkAll) {
    chkAll.addEventListener("change", function () {
      chkRows.forEach(function (c) {
        c.checked = chkAll.checked;
      });
      updateBulkUI();
    });
  }

  // Individu checkbox
  chkRows.forEach(function (chk) {
    chk.addEventListener("change", function () {
      if (!chk.checked && chkAll) {
        chkAll.checked = false;
      }
      updateBulkUI();
    });
  });

  // ===========================
  // 3) BULK DELETE
  //    - hanya DRAFT / CANCELLED / EXPIRED
  // ===========================
  var btnBulkDelete = document.getElementById("btn-bulk-delete");
  var bulkForm      = document.getElementById("bulk-form");
  var bulkIdsInput  = document.getElementById("bulk-ids");

  if (btnBulkDelete && bulkForm && bulkIdsInput) {
    btnBulkDelete.addEventListener("click", function () {
      var checked = document.querySelectorAll(".chk-row:checked");
      if (!checked.length) {
        return;
      }

      var deletableIds = [];
      var blockedIds   = [];

      checked.forEach(function (chk) {
        var tr = chk.closest("tr");
        if (!tr) return;

        var status = (tr.dataset.status || "").toLowerCase();
        var id     = chk.value;

        // allowed delete: draft, cancelled, expired
        if (status === "draft" || status === "cancelled" || status === "expired") {
          deletableIds.push(id);
        } else {
          blockedIds.push(id);
        }
      });

      if (!deletableIds.length) {
        alert("Tidak bisa menghapus quotation kecuali status Draft / Cancelled / Expired.");
        return;
      }

      var msg = "Hapus " + deletableIds.length + " quotation (Draft/Cancelled/Expired)?";
      if (blockedIds.length) {
        msg += "\n\n" + blockedIds.length +
               " quotation dengan status lain tidak akan dihapus.";
      }

      if (!confirm(msg)) {
        return;
      }

      bulkIdsInput.value = deletableIds.join(",");
      bulkForm.submit();
    });
  }

  // ===========================
  // 4) RESET FILTER
  // ===========================
  var btnResetFilters = document.getElementById("btn-reset-filters");
  if (btnResetFilters) {
    btnResetFilters.addEventListener("click", function () {
      window.location.href = "{% url 'sales:fq_list' %}";
    });
  }

});
</script>

{% endblock %}
