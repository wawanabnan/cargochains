{% extends "adminbase.html" %}

{% block content %}

  <!-- HEADER -->
  <div class="app-content-header">
    <div class="container-fluid d-flex justify-content-between align-items-center">
      <h3 class="mb-0">Freight Orders</h3>
      {# Tidak ada tombol New, order dibuat dari quotation #}
    </div>
  </div>

  <!-- MAIN CONTENT -->
  <section class="content">
    <div class="container-fluid">

      <!-- ============================= -->
      <!--     SEARCH BAR + TOOLBAR      -->
      <!-- ============================= -->
      <div class="card border-0 mb-3">
        <div class="card-body">

          <div id="orders-toolbar"
               class="d-flex justify-content-between align-items-center gap-2 mb-2">

            <!-- LEFT: (kosong / future bulk) -->
            <div class="d-flex align-items-center gap-2">
              {# Disini nanti bisa ditambah bulk action kalau perlu #}
            </div>

            <!-- CENTER: SEARCH BOX -->
            <div class="flex-grow-1 d-flex justify-content-center">

              <div id="search-box" class="flex-grow-1 d-flex justify-content-center">
                <form method="get"
                      class="input-group input-group-sm rounded-pill overflow-hidden shadow-sm border"
                      style="max-width:500px;">
                  <input type="search" name="q" value="{{ q }}"
                         class="form-control ps-3 border-0 bg-body"
                         placeholder="Search orders..." autocomplete="off">

                  <button class="btn btn-outline-secondary border-0 bg-body" type="submit">
                    <i class="fa fa-search"></i>
                  </button>

                  <!-- pertahankan parameter lain (kalau nanti ada sorting) -->
                  <input type="hidden" name="sort" value="{{ sort }}">
                  <input type="hidden" name="dir"  value="{{ dir }}">
                  <input type="hidden" name="sp"   value="{{ sp }}">
                </form>
              </div>

            </div>

            <!-- RIGHT: FILTER BUTTON -->
            <div>
              <button class="btn btn-outline-secondary btn-sm"
                      data-bs-toggle="offcanvas"
                      data-bs-target="#filterSheet">
                <i class="fa fa-filter me-1"></i> Filter
              </button>
            </div>
          </div>

        </div>
      </div>

      <!-- ============================= -->
      <!--         TABLE LIST            -->
      <!-- ============================= -->
      <div class="card">
        <div class="card-body p-0">

          <div class="table-responsive">
            <table class="table table-hover mb-0">
              <thead class="table-light">
                <tr>
                  <th style="width: 4%">
                    <input type="checkbox" id="chk-all">
                  </th>
                  <th style="width: 10%">Number</th>
                  <th style="width: 10%">Order Date</th>
                  <th>Customer</th>
                  <th style="width: 20%">Route</th>
                  <th style="width: 10%;">Service</th>
                  <th class="text-end" style="width: 10%">Total</th>
                  <th class="text-center" style="width: 10%">Status</th>
                </tr>
              </thead>

              <tbody>
                {% if orders %}
                  {% for o in orders %}
                    <tr class="row-clickable"
                        data-url="{% url 'sales:fo_detail' o.pk %}"
                        data-status="{{ o.status|default:'draft'|lower }}">

                      <!-- checkbox (jangan trigger row click) -->
                      <td onclick="event.stopPropagation();">
                        <input type="checkbox" class="chk-row" value="{{ o.pk }}">
                      </td>

                      <td>{{ o.number }}</td>
                      <td>{{ o.order_date|date:"Y-m-d" }}</td>
                      <td>{{ o.customer.company_name|default:o.customer.name }}</td>
                      <td>{{ o.origin.name }} → {{ o.destination.name }}</td>
                      <td>{{ o.sales_service.code }}</td>

                      <td class="text-end">
                        {{ o.total_amount|floatformat:2 }}
                      </td>

                      <td class="text-center">
                        {% with s=o.status|default:"draft"|lower %}
                          {% if s == "draft" %}
                            <span class="badge bg-secondary">Draft</span>
                          {% elif s == "sent" %}
                            <span class="badge bg-primary">Sent</span>
                          {% elif s == "on_progress" %}
                            <span class="badge bg-warning text-dark">On Progress</span>
                          {% elif s == "completed" %}
                            <span class="badge bg-success">Completed</span>
                          {% elif s == "cancelled" %}
                            <span class="badge bg-danger">Cancelled</span>
                          {% elif s == "holded" %}
                            <span class="badge bg-info">Holded</span>
                          {% else %}
                            <span class="badge bg-light text-dark">{{ s|title }}</span>
                          {% endif %}
                        {% endwith %}
                      </td>

                    </tr>
                  {% endfor %}
                {% else %}
                  <tr>
                    <td colspan="8" class="text-center py-4">
                      No Freight Orders found.
                    </td>
                  </tr>
                {% endif %}
              </tbody>
            </table>
          </div>

        </div>

        <!-- PAGINATION (mirip quotation_list) -->
        {% if is_paginated %}
        <div class="card-footer">
          <nav aria-label="Order pages">
            <ul class="pagination mb-0 justify-content-end">

              <!-- Previous -->
              {% if page_obj.has_previous %}
                <li class="page-item">
                  <a class="page-link"
                     href="?page={{ page_obj.previous_page_number }}">
                    Previous
                  </a>
                </li>
              {% else %}
                <li class="page-item disabled">
                  <span class="page-link">Previous</span>
                </li>
              {% endif %}

              <!-- Page numbers -->
              {% for num in page_obj.paginator.page_range %}
                {% if num == page_obj.number %}
                  <li class="page-item active">
                    <span class="page-link">{{ num }}</span>
                  </li>
                {% elif num > page_obj.number|add:"-3" and num < page_obj.number|add:"3" %}
                  <li class="page-item">
                    <a class="page-link" href="?page={{ num }}">{{ num }}</a>
                  </li>
                {% endif %}
              {% endfor %}

              <!-- Next -->
              {% if page_obj.has_next %}
                <li class="page-item">
                  <a class="page-link" href="?page={{ page_obj.next_page_number }}">
                    Next
                  </a>
                </li>
              {% else %}
                <li class="page-item disabled">
                  <span class="page-link">Next</span>
                </li>
              {% endif %}

            </ul>
          </nav>
        </div>
        {% endif %}

      </div>

      <!-- ============================= -->
      <!--       FILTER OFFCANVAS        -->
      <!-- ============================= -->
      <div class="offcanvas offcanvas-end" tabindex="-1" id="filterSheet">
        <div class="offcanvas-header">
          <h5 class="offcanvas-title">Filters</h5>
          <button type="button" class="btn-close"
                  data-bs-dismiss="offcanvas"
                  aria-label="Close"></button>
        </div>

        <form class="offcanvas-body" method="get">

          <div class="mb-3">
            <label class="form-label small">Status</label>
            <select name="status" class="form-select form-select-sm" multiple>
              {% for value, label in status_choices %}
                <option value="{{ value }}" {% if value in flt_statuses %}selected{% endif %}>
                  {{ label }}
                </option>
              {% endfor %}
            </select>
            <div class="form-text">Gunakan Ctrl/Cmd untuk pilih lebih dari satu.</div>
          </div>

          <div class="mb-3">
            <label class="form-label small">Service</label>
            <select name="service" class="form-select form-select-sm" multiple>
              {% for s in services %}
                <option value="{{ s.pk }}" {% if s.pk in flt_services %}selected{% endif %}>
                  {{ s.name }}
                </option>
              {% endfor %}
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label small">Payment Term</label>
            <select name="payment_term" class="form-select form-select-sm" multiple>
              {% for p in paymentterms %}
                <option value="{{ p.pk }}" {% if p.pk in flt_paymentterms %}selected{% endif %}>
                  {{ p.name }}
                </option>
              {% endfor %}
            </select>
          </div>

          <!-- pertahankan parameter lain -->
          <input type="hidden" name="q"    value="{{ q }}">
          <input type="hidden" name="sort" value="{{ sort }}">
          <input type="hidden" name="dir"  value="{{ dir }}">
          <input type="hidden" name="sp"   value="{{ sp }}">

          <div class="d-flex justify-content-end gap-2 mt-3">
            <button class="btn btn-primary btn-sm" type="submit">
              <i class="fa fa-check me-1"></i> Apply
            </button>
            <button type="button" class="btn btn-outline-secondary btn-sm"
                    id="btn-reset-filters">
              <i class="fa fa-undo me-1"></i> Reset
            </button>
          </div>

        </form>
      </div>

    </div>
  </section>

<style>
  .row-clickable {
    cursor: pointer;
  }
</style>

<script>
document.addEventListener("DOMContentLoaded", function () {

  // ===========================
  // 1) ROW CLICK → OPEN DETAIL
  // ===========================
  var rows = document.querySelectorAll(".row-clickable");

  rows.forEach(function (row) {
    row.addEventListener("click", function (e) {
      // kalau klik checkbox, jangan buka detail
      if (e.target.tagName === "INPUT" && e.target.type === "checkbox") {
        return;
      }

      var url = row.dataset.url;
      if (url) {
        window.location.href = url;
      }
    });
  });

  // ===========================
  // 2) SELECT ALL CHECKBOX
  // ===========================
  var chkAll  = document.getElementById("chk-all");
  var chkRows = document.querySelectorAll(".chk-row");

  if (chkAll) {
    chkAll.addEventListener("change", function () {
      chkRows.forEach(function (c) {
        c.checked = chkAll.checked;
      });
    });
  }

  // ===========================
  // 3) RESET FILTER
  // ===========================
  var btnResetFilters = document.getElementById("btn-reset-filters");
  if (btnResetFilters) {
    btnResetFilters.addEventListener("click", function () {
      window.location.href = "{% url 'sales:fo_list' %}";
    });
  }

});
</script>

{% endblock %}
