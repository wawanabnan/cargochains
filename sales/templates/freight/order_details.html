{% extends "adminbase.html" %}
{% load quo_extras %}
{% block title %}Quotation {{ quotation.number }}{% endblock %}


{% block content %}

<div class="app-content-header">
  <div class="container-fluid">
    <div class="row">
      <div class="col-sm-6">
        <h3 class="mb-0">Freight Orders</h3># {{ order.number }}

      </div>
      <div class="col-sm-6">
        <ol class="breadcrumb float-sm-end">
          <li class="breadcrumb-item">
            <a href="{% url 'account:dashboard'%}" class="badge text-bg-secondary">Home</a>
          </li>
          <li class="breadcrumb-item active" aria-current="page"> 
            <a href="{% url 'sales:quotation_add'%}"  class="badge text-bg-primary">New</a>
            
          </li>
        </ol>
      </div>
    </div>
  </div>
</div>  

<div class="app-content"> 
  <div class="container-fluid pt-2" >
  <div class="row">
     <div class="col-md-6 text-left">
        
            <a href="{% url 'sales:order_print' order.id %}" 
              class="btn btn-primary btn-sm" target="_blank" rel="noopener">Preview</a>
           
              <a href="{% url 'sales:order_pdf' order.id %}" 
                class="btn btn-secondary btn-sm" target="_blank" rel="noopener"> PDF</a>
        
        
          {% if order.status == "CONFIRMED" %}
            <!-- Tombol utama -->
              <button type="button" class="btn btn-sm btn-secondary" data-bs-toggle="modal" data-bs-target="#confirmGenerateModal">
                <i class="fas fa-truck"></i> Generate Shipment
              </button>

          {% endif %}


     </div>
     <div class="col-md-6 text-end">
        {% if order|can_transition_to:"CONFIRMED" %}
         
          <form method="post" action="{% url 'sales:order_change_status' order.id %}" class="d-inline">
            {% csrf_token %}
            <input type="hidden" name="status" value="CONFIRMED">
            <button class="btn btn-info btn-sm">Confirm</button>
          </form>
        {% endif %}

        {% if order|can_transition_to:"ON_PROGRESS" %}
          <form method="post" action="{% url 'sales:order_change_status' order.id %}" class="d-inline">
            {% csrf_token %}
            <input type="hidden" name="status" value="ON_PROGRESS">
            <button class="btn btn-succes btn-sm">Start Progress</button>
          </form>
        {% endif %}

        {% if order|can_transition_to:"ON_HOLD" %}
          <form method="post" action="{% url 'sales:order_change_status' order.id %}" class="d-inline">
            {% csrf_token %}
            <input type="hidden" name="status" value="ON_HOLD">
            <button class="btn btn-outline-secondary btn-sm">Hold</button>
          </form>
        {% endif %}

        {% if order|can_transition_to:"COMPLETED" %}
          <form method="post" action="{% url 'sales:order_change_status' order.id %}" class="d-inline">
            {% csrf_token %}
            <input type="hidden" name="status" value="COMPLETED">
            <button class="btn btn-outline-success btn-sm">Complete</button>
          </form>
        {% endif %}

        {% if order|can_transition_to:"CANCELLED" %}
          <form method="post" action="{% url 'sales:order_change_status' order.id %}" class="d-inline" onsubmit="return confirm('Cancel this Sales Order?')">
            {% csrf_token %}
            <input type="hidden" name="status" value="CANCELLED">
            <button class="btn btn-danger btn-sm">Cancel</button>
          </form>
        {% endif %}

     </div>
  </div>     
  </div>  

  {% if messages %}
  <div class="mt-2">
    <div class="container-fluid pt-2" >
      {% for m in messages %}
        <div class="alert alert-{{ m.tags }} alert-warning alert-dismissible fade show" role="alert">
          <strong>  {{ m }}</strong>
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  <div class="container-fluid  p-2">
    <div class="card">
      
      <div class="card-body">
       <div class="row">
      <div class="col-md-6">
        <dl class="row mb-0">
          <dt class="col-md-3">Customer</dt><dd class="col-md-9">{{ order.customer.name }}</dd>
          <dt class="col-md-3"></dt><dd class="col-md-9">{{ order.customer.address }}</dd>
          <dt class="col-md-3">Sales </dt><dd class="col-md-9">{{ order.sales_user.username }}</dd>
          <dt class="col-md-3">Services</dt><dd class="col-md-9">{{ order.sales_service.only_name }}</dd>
          <dt class="col-md-3"></dt><dd class="col-md-9"></dd>
        </dl>             
      </div>
      <div class="col-md-6">
          <dl class="row mb-0">
            <dt class="col-md-3">Date</dt><dd class="col-md-9">{{ order.date|date:"d-m-Y"|default:"—" }}</dd>
            <dt class="col-md-3">Payment Term</dt><dd class="col-md-9">{{ order.payment_term|default:"—" }}</dd>
            <dt class="col-md-3">Currency</dt><dd class="col-md-9">{{ order.currency }}</dd>
            <dt class="col-md-3">Status</dt>
              <dd class="col-md-9">
                {% with s=order.status|default:"draft"|lower %}
                  {% if s == "accepted" %}
                    <span class="badge bg-success">Accepted</span>
                  {% elif s == "sent" %}
                    <span class="badge bg-info">Sent</span>
                  {% elif s == "cancelled" %}
                    <span class="badge bg-danger">Cancelled</span>
                  {% elif s == "expired" %}
                    <span class="badge bg-warning">Expired</span>
                  {% else %}
                    <span class="badge bg-secondary">{{ s|title }}</span>
                  {% endif %}
                {% endwith %}
              </dd>
          </dl>       
      </div>
    </div>
         <div class="row">
            <ul class="nav nav-tabs" id="myTab" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link active" id="home-tab" data-bs-toggle="tab" data-bs-target="#home" type="button" role="tab" aria-controls="home" aria-selected="true">Order Lines</button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="note-tab" data-bs-toggle="tab" data-bs-target="#note" type="button" role="tab" aria-controls="profile" aria-selected="false">Note</button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="attachment-tab" data-bs-toggle="tab" data-bs-target="#attachment" type="button" role="tab" aria-controls="contact" aria-selected="false">Attachment</button>
              </li>
            </ul>
            <div class="tab-content" id="myTabContent">
              <div class="tab-pane fade show active" id="home" role="tabpanel" aria-labelledby="home-tab">
                <div class="table-responsive">
                    <table class="table"   id="lines-table">
                      <thead class="table-light2">
                        <tr>
                          <th>Origin</th>
                          <th>Destination</th>
                          <th>Description</th>
                          <th class="text-end">Qty</th>
                          <th>UoM</th>
                          <th class="text-end">Price</th>
                          <th class="text-end">Amount</th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for ln in lines %}
                        <tr>
                          <td>{{ ln.origin.name }}</td>
                          <td>{{ ln.destination.name }}</td>
                          <td>{{ ln.description }}</td>
                          <td class="text-end">{{ ln.qty }}</td>
                          <td>{{ ln.uom }}</td>
                          <td class="text-end">{{ ln.price }}</td>
                          <td class="text-end">{{ ln.amount }}</td>
                        </tr>
                        {% endfor %}
                        <tr><td colspan="6" class="text-end text-muted">Sub Total</td><td class="text-end num">{{ order.total }}</td></tr>
                        <tr><td colspan="6" class="text-end text-muted">VAT</td><td class="text-end num">{{ order.vat }}</td></tr>
                        <tr><td colspan="6" class="text-end text-muted">Grand Total</td><td class="text-end num">{{ order.grand_total }}</td></tr>
           
                      </tbody>
                    </table>
                  </div>  
              </div>  
              <div class="tab-pane fade show active" id="note" role="tabpanel" aria-labelledby="tab-attach=tab">
                   {{ quotation.note }}
              </div>    
               <div class="tab-pane fade show active" id="attachment" role="tabpanel" aria-labelledby="tab-attach=tab">
                  
              </div>    
            </div>    
         </div>
      </div>
    </div>  
  </div>

</div>


<!-- Modal Konfirmasi -->
<div class="modal fade" id="confirmGenerateModal" tabindex="-1" aria-labelledby="confirmGenerateLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="confirmGenerateLabel">
          <i class="fas fa-question-circle"></i> Konfirmasi Generate Shipment
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <p class="mb-2">
          Apakah Anda yakin ingin membuat <strong>Shipment</strong> dari Sales Order ini?
        </p>
        <p class="text-muted small mb-0">
          Jika dilanjutkan, sistem akan membuat Shipment baru berdasarkan data Sales Order.
        </p>
      </div>

      <div class="modal-footer bg-body-tertiary">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="fas fa-times"></i> Batal
        </button>
        <form method="post" action="{% url 'sales:order_generate_shipment' order.id %}" style="display:inline;">
                {% csrf_token %}
                <button type="submit"
                        class="btn btn-dark btn-sm">
                  <i class="fas fa-file-contract"></i> Generate Shipment
                </button>
        </form>

      </div>
    </div>
  </div>
</div>

<!-- SMART NUMBER FORMATTER -->
<script>
document.addEventListener("DOMContentLoaded", function() {
  const fmt = new Intl.NumberFormat("id-ID", { minimumFractionDigits: 2, maximumFractionDigits: 2 });

  // "25.000.000,00" | "25000000.00" | "25,000,000.00" -> 25000000
  function parseSmart(s) {
    s = (s ?? "").toString().trim();
    if (!s) return NaN;
    const hasComma = s.includes(",");
    const hasDot   = s.includes(".");
    if (hasComma && hasDot) {
      // biasanya '.' ribuan, ',' desimal (format ID)
      s = s.replace(/\./g, "").replace(",", ".");
    } else if (hasComma) {
      // koma desimal, tidak ada titik desimal -> buang '.' ribuan
      s = s.replace(/\./g, "").replace(",", ".");
    } else {
      // tidak ada koma -> anggap '.' desimal; buang koma ribuan
      s = s.replace(/,/g, "");
    }
    const v = parseFloat(s);
    return Number.isFinite(v) ? v : NaN;
  }

  function fmtCells(selector) {
    document.querySelectorAll(selector).forEach(el => {
      const raw = (el.textContent || el.getAttribute("data-amount") || "");
      const val = parseSmart(raw);
      if (Number.isFinite(val)) el.textContent = fmt.format(val);
    });
  }

  // format tabel & grand total
  fmtCells("#lines-table td.num");
  fmtCells("#grand-total");
});
</script>

{% endblock %}
