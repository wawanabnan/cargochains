{% extends "base.html" %}
{% load quo_extras %}
{% block title %}Quotation {{ quotation.number }}{% endblock %}

{% block content %}

<div class="container-fluid pt-2" style="border-bottom:1px solid #ccc;" >
  <div class="row">
     <div class="col-md-6 text-left">
        <a href="{% url 'sales:quotation_edit' quotation.id %}" class="btn btn-white btn-sm">New</a>

     <!--end of button group--> 
    </div>
    <div class="col-md-6 text-end">
       <p>Tools</p>

     <!--end of button group--> 
    </div>
    

  </div>

</div>

<div class="container-fluid pt-2" >
  <div class="row">
     <div class="col-md-6 text-left">
          
          <a href="{% url 'sales:quotation_edit' quotation.id %}" class="btn btn-primary btn-sm">Edit</a>
          <a href="{% url 'sales:quotation_print' quotation.id %}" class="btn  btn-secondary btn-sm" target="_blank">Preview</a>
          <a href="{% url 'sales:quotation_pdf' quotation.id %}" 
              class="btn btn-secondary btn-sm" target="_blank" rel="noopener"> PDF</a>
      

     <!--end of button group--> 
    </div>
    <div class="col-md-6 text-end">
      {% if quotation.status == "ACCEPTED" %}
               <form method="post" action="{% url 'sales:quotation_generate_so' quotation.id %}" style="display:inline;">
                {% csrf_token %}
                <button type="submit"
                        class="btn btn-outline-dark btn-sm"
                        onclick="return confirm('Generate SO dari quotation ini?');">
                  <i class="fas fa-file-contract"></i> Generate SO
                </button>
              </form>

              {% endif %}
              {# DRAFT -> SENT #}
              {% if quotation|can_transition_to:"SENT" %}
                  <form action="{% url 'sales:quotation_change_status' quotation.id %}" method="post" class="d-inline">
                    {% csrf_token %}
                    <input type="hidden" name="status" value="SENT">
                    <button type="submit" class="btn btn-info btn-sm"
                            onclick="return confirm('Mark as SENT?');">
                      <i class="fas fa-paper-plane"></i> Mark as Sent
                    </button>
                  </form>
               {% endif %}

               {# SENT -> ACCEPTED #}
               {% if quotation|can_transition_to:"ACCEPTED" %}
                  <form action="{% url 'sales:quotation_change_status' quotation.id %}" method="post" class="d-inline">
                    {% csrf_token %}
                    <input type="hidden" name="status" value="ACCEPTED">
                    <button type="submit" class="btn btn-success btn-sm"
                            onclick="return confirm('Set as ACCEPTED?');">
                      <i class="fas fa-check"></i> Accept
                    </button>
                  </form>
               {% endif %}

               {# SENT -> CANCELLED #}
               {% if quotation|can_transition_to:"CANCELLED" %}
                  <form action="{% url 'sales:quotation_change_status' quotation.id %}" method="post" class="d-inline">
                    {% csrf_token %}
                    <input type="hidden" name="status" value="CANCELLED">
                    <button type="submit" class="btn btn-danger btn-sm"
                            onclick="return confirm('Cancel this quotation?');">
                      <i class="fas fa-times"></i> Cancel
                    </button>
                  </form>
               {% endif %}
  
     <!--end of button group--> 
    </div>
    

  </div>

</div>

<div class="container-fluid  pt-2">
  <div class="card">
    <div class="card-body">
     <div class="row">
       <h4>{{ quotation.number }}</h4>
       <br>
       <br>
       <br>
      </div>
   
    <div class="row">
      <div class="col-md-6">
        <dl class="row mb-0">
          <dt class="col-md-3">Customer</dt><dd class="col-md-9">{{ quotation.customer }}</dd>
          <dt class="col-md-3"></dt><dd class="col-md-9">{{ quotation.customer.address }}</dd>
          <dt class="col-md-3">Sales AGency</dt><dd class="col-md-9">{{ quotation.sales_agency }}</dd>
          <dt class="col-md-3">Services</dt><dd class="col-md-9">{{ quotation.sales_service.only_name }}</dd>
          <dt class="col-md-3"></dt><dd class="col-md-9"></dd>
        </dl>             
      </div>
      <div class="col-md-6">
          <dl class="row mb-0">
            <dt class="col-md-3">Valid Until</dt><dd class="col-md-9">{{ quotation.valid_until|date:"d-m-Y"|default:"—" }}</dd>
            <dt class="col-md-3">Payment Term</dt><dd class="col-md-9">{{ quotation.payment_term|default:"—" }}</dd>
            <dt class="col-md-3">Currency</dt><dd class="col-md-9">{{ quotation.currency }}</dd>
            <dt class="col-md-3">Total</dt>
            <dd class="col-md-9">
              <span id="grand-total" data-amount="{{ quotation.total_amount }}">{{ quotation.total }}</span>
            </dd>
            <dt class="col-md-3">Status</dt>
              <dd class="col-md-9">
                {% with s=quotation.status|default:"draft"|lower %}
                  {% if s == "accepted" %}
                    <span class="badge bg-success">Accepted</span>
                  {% elif s == "sent" %}
                    <span class="badge bg-info">Sent</span>
                  {% elif s == "cancelled" %}
                    <span class="badge bg-danger">Cancelled</span>
                  {% elif s == "expired" %}
                    <span class="badge bg-warning">Expired</span>
                  {% else %}
                    <span class="badge bg-secondary">{{ s|title }}</span>
                  {% endif %}
                {% endwith %}
              </dd>
          </dl>       
      </div>
    </div>

     <div class="row">
      <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="home-tab" data-bs-toggle="tab" data-bs-target="#home" type="button" role="tab" aria-controls="home" aria-selected="true">Qoutation Lines</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="profile-tab" data-bs-toggle="tab" data-bs-target="#profile" type="button" role="tab" aria-controls="profile" aria-selected="false">Attachment</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="contact-tab" data-bs-toggle="tab" data-bs-target="#contact" type="button" role="tab" aria-controls="contact" aria-selected="false">Log</button>
        </li>
      </ul>

      <div class="tab-content mt-3" id="myTabContent">
        <div class="tab-pane fade show active" id="home" role="tabpanel" aria-labelledby="home-tab">
          <div class="table-responsive">
            <table class="table " id="lines-table">
              <thead class="table">
                <tr>
                  <th style="width:180px;">Origin</th>
                  <th style="width:160px;">Destination</th>
                  <th>Cargo Description</th>
                  <th style="width:100px;">UoM</th>
                  <th style="width:100px;" class="text-end">Qty</th>
                  <th style="width:140px;" class="text-end">Price</th>
                  <th style="width:160px;" class="text-end">Amount</th>
                </tr>
              </thead>
              <tbody>
                {% if lines %}
                  {% for l in lines %}
                  <tr>
                    <td class="text-left">{{ l.origin.name }}</td>
                    <td>{{ l.destination.name }}</td>
                    <td>{{ l.description }}</td>
                    <td>{{ l.uom }}</td>
                    <td class="text-end num">{{ l.qty }}</td>
                    <td class="text-end num">{{ l.price }}</td>
                    <td class="text-end num">{{ l.amount }}</td>
                  </tr>
                  {% endfor %}
                  <tr><td colspan="6" class="text-end text-muted">Sub Total</td><td class="text-end num">{{ quotation.total }}</td></tr>
                  <tr><td colspan="6" class="text-end text-muted">VAT</td><td class="text-end num">{{ quotation.vat }}</td></tr>
                  <tr><td colspan="6" class="text-end text-muted">Grand Total</td><td class="text-end num">{{ quotation.grand_total }}</td></tr>
                {% else %}
                  <tr><td colspan="7" class="text-center text-muted py-3">No lines</td></tr>
                {% endif %}
                
              </tbody>
            </table>
         
      </div>
        </div>
        <div class="tab-pane fade" id="profile" role="tabpanel" aria-labelledby="profile-tab">
          
        </div>
        <div class="tab-pane fade" id="contact" role="tabpanel" aria-labelledby="contact-tab">
          
          
       </div>
  </div>


    </div>
  </div>
  <!--end of card--->
</div>
</div>
<!-- PRINT-FRIENDLY -->
<style>
@media print {
  body { -webkit-print-color-adjust: exact; print-color-adjust: exact; background:#fff; }
  /* sembunyikan layout/AdminLTE sidebar/header/footer */
  .app-header, .app-sidebar, .app-footer,
  .main-header, .main-footer, .navbar, .sidebar { display:none !important; }
  .app-main, .content-wrapper, .container-fluid { margin:0 !important; padding:0 !important; }
  .card { border:none; box-shadow:none; }
  .card-header { border-bottom:1px solid #000 !important; }
  .table thead th { border-top:1px solid #000 !important; border-bottom:1px solid #000 !important; }
  .table tbody td { border-bottom:1px solid #ccc !important; }
  .no-break { page-break-inside: avoid; }
  @page { size: A4 portrait; margin: 10mm; }
}
</style>

<!-- SMART NUMBER FORMATTER -->
<script>
document.addEventListener("DOMContentLoaded", function() {
  const fmt = new Intl.NumberFormat("id-ID", { minimumFractionDigits: 2, maximumFractionDigits: 2 });

  // "25.000.000,00" | "25000000.00" | "25,000,000.00" -> 25000000
  function parseSmart(s) {
    s = (s ?? "").toString().trim();
    if (!s) return NaN;
    const hasComma = s.includes(",");
    const hasDot   = s.includes(".");
    if (hasComma && hasDot) {
      // biasanya '.' ribuan, ',' desimal (format ID)
      s = s.replace(/\./g, "").replace(",", ".");
    } else if (hasComma) {
      // koma desimal, tidak ada titik desimal -> buang '.' ribuan
      s = s.replace(/\./g, "").replace(",", ".");
    } else {
      // tidak ada koma -> anggap '.' desimal; buang koma ribuan
      s = s.replace(/,/g, "");
    }
    const v = parseFloat(s);
    return Number.isFinite(v) ? v : NaN;
  }

  function fmtCells(selector) {
    document.querySelectorAll(selector).forEach(el => {
      const raw = (el.textContent || el.getAttribute("data-amount") || "");
      const val = parseSmart(raw);
      if (Number.isFinite(val)) el.textContent = fmt.format(val);
    });
  }

  // format tabel & grand total
  fmtCells("#lines-table td.num");
  fmtCells("#grand-total");
});
</script>

{% endblock %}