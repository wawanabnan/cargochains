{% extends "base.html" %}
{% load static %}
{% block title %}New Freight Quotation — Step 2 (Cards){% endblock %}


{% block content %}
<div class="container-fluid">
  <!-- ===== HEADER INFO (versi yang kamu suka) ===== -->
  <div class="row">
    <div class="col-12">
      <div class="card card-primary card-outline mb-3">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h3 class="card-title m-0"><i class="fas fa-info-circle"></i> Quotation Header</h3>
          <span class="text-muted">ID: {{ quotation.id }}</span>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-3">
              <div class="small text-muted">Number</div>
              <div class="fw-semibold">{{ quotation.number }}</div>
            </div>
            <div class="col-md-3">
              <div class="small text-muted">Date</div>
              <div class="fw-semibold">{{ quotation.date }}</div>
            </div>
            <div class="col-md-6">
              <div class="small text-muted">Customer</div>
              <div class="fw-semibold">{{ quotation.customer }}</div>
            </div>

            <div class="col-md-3">
              <div class="small text-muted">Sales Service</div>
              <div class="fw-semibold">{{ quotation.sales_service }}</div>
            </div>
            <div class="col-md-3">
              <div class="small text-muted">Sales Agency</div>
              <div class="fw-semibold">{{ quotation.sales_agency|default:"—" }}</div>
            </div>
            <div class="col-md-3">
              <div class="small text-muted">Currency</div>
              <div class="fw-semibold">{{ quotation.currency }}</div>
            </div>
            <div class="col-md-3">
              <div class="small text-muted">Payment Term</div>
              <div class="fw-semibold">{{ quotation.payment_term|default:"—" }}</div>
            </div>

            <div class="col-md-3">
              <div class="small text-muted">Valid Until</div>
              <div class="fw-semibold">{{ quotation.valid_until|default:"—" }}</div>
            </div>
            <div class="col-md-9 d-flex align-items-end justify-content-end">
              <div class="text-end">
                <div class="small text-muted">Grand Total (header)</div>
                <div class="display-6 fw-bold" id="header-grand-total"
                     data-amount="{{ quotation.grand_total|default:'0.00' }}">0,00</div>
              </div>
            </div>
          </div>
        <!--
          {% if quotation.note_1 %}
          <hr class="my-3">
          <div>
            <div class="small text-muted mb-1">Note</div>
            <div class="border rounded p-2">{{ quotation.note_1|safe }}</div>
          </div>
          {% endif %}-->

        </div>
      </div>
    </div>
  </div>

  <!-- ===== LINES (CARD STYLE) ===== -->
  <div class="row">
    <div class="col-12">
      <div class="card card-success card-outline">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h3 class="card-title m-0"><i class="fas fa-list"></i> Quotation Lines</h3>
          <div class="text-end">
           <!-- <div class="small text-muted">Grand Total (live)</div>
            <div class="h4 fw-bold" id="live-grand-total">0,00</div>-->
          </div>
        </div>

        <div class="card-body">
          <form method="post" id="lines-form">
            {% csrf_token %}

            <div id="lines-container" class="d-flex flex-column gap-3">
              {% if lines and lines|length > 0 %}
                {% for ln in lines %}
                  <!-- satu card line (EXISTING) -->
                  <div class="card shadow-sm line">
                    <div class="card-body">
                      <div class="row g-3">
                        <div class="col-md-3">
                          <label class="form-label">Origin 2</label>
                            <input type="text" id="origin_search" class="form-control" placeholder="Ketik lokasi…">
                            <input type="hidden" name="origin[]" id="origin_id" value="{{ ln.origin_id|default:'' }}">

                          </div>

                        <div class="col-md-3">
                          <label class="form-label">Destination 2</label>
                          <input type="text" id="destination_search" class="form-control" placeholder="Ketik lokasi…">
                          <input type="hidden" name="destination[]" id="destination_id" value="{{ ln.origin_id|default:'' }}">

                          <select 
                          name="destination[]" 
                          class="select2-ajax" 
                          data-url="/ajax/locations/" 
                          data-placeholder="Search destination…">
                          {% if ln.destination %}
                            <option value="{{ ln.destination.id }}" selected>
                              {{ ln.destination.code }} — {{ ln.destination.name }}
                            </option>
                          {% endif %}
                        </select>

                        </div>

                        <div class="col-md-6">
                          <label class="form-label">Cargo Description</label>
                          <textarea name="description[]" rows="3" class="form-control">{{ ln.description }}</textarea>
                        </div>

                        <div class="col-md-2">
                          <label class="form-label">UoM</label>
                          <select name="uom[]" class="form-select">
                            <option value="">—</option>
                            {% for u in uoms %}
                              <option value="{{ u.id }}" {% if ln.uom_id == u.id %}selected{% endif %}>{{ u.name }}</option>
                            {% endfor %}
                          </select>
                        </div>

                        <div class="col-md-2">
                          <label class="form-label">Qty</label>
                          <input name="qty[]" type="text" class="form-control money" value="{{ ln.qty }}">
                        </div>

                        <div class="col-md-3">
                          <label class="form-label">Price</label>
                          <input name="price[]" type="text" class="form-control money" value="{{ ln.price }}">
                        </div>

                        <div class="col-md-3">
                          <label class="form-label">Amount</label>
                          <input name="amount_display[]" type="text" class="form-control money" value="" readonly>
                        </div>

                        <div class="col-md-2 d-flex align-items-end justify-content-end">
                          <button type="button" class="btn btn-sm btn-outline-danger btn-remove">
                            <i class="fas fa-trash"></i> Remove
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                {% endfor %}
              {% else %}
                <!-- baris kosong pertama (EMPTY) -->
                <div class="card shadow-sm line">
                  <div class="card-body">
                    <div class="row g-6">
                      <div class="col-md-6">
                           <label class="form-label">Origin</label>
                          <input type="text" id="origin_search" class="form-control  js-origin-input" placeholder="Ketik lokasi…">
                          <input type="hidden" name="origin[]" class="js-origin-id" id="origin_id" value="{{ ln.origin_id|default:'' }}">

                      </select>

                      </div>

                      <div class="col-md-6">
                        <label class="form-label">Destination</label>
                        <input type="text" id="destination_search" class="form-control  js-dest-input" placeholder="Ketik lokasi…">
                        <input type="hidden" name="destination[]" class="js--id" id="destination_id" value="{{ ln.destination_id|default:'' }}">


                      </div>

                      <div class="col-md-12">
                        <label class="form-label">Description</label>
                        <textarea name="description[]" rows="3" class="form-control"></textarea>
                      </div>

                      <div class="col-md-2">
                        <label class="form-label">UoM</label>
                        <select name="uom[]" class="form-select">
                          <option value="">—</option>
                          {% for u in uoms %}
                            <option value="{{ u.id }}">{{ u.name }}</option>
                          {% endfor %}
                        </select>
                      </div>

                      <div class="col-md-2">
                        <label class="form-label">Qty</label>
                        <input name="qty[]" type="text" class="form-control money" value="">
                      </div>

                      <div class="col-md-3">
                        <label class="form-label">Price</label>
                        <input name="price[]" type="text" class="form-control money" value="">
                      </div>

                      <div class="col-md-3">
                        <label class="form-label">Amount</label>
                        <input name="amount_display[]" type="text" class="form-control money" value="" readonly>
                      </div>

                      <div class="col-md-2 d-flex align-items-end justify-content-end">
                        <button type="button" class="btn btn-sm btn-outline-danger btn-remove">
                          <i class="fas fa-trash"></i> Remove
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              {% endif %}
            </div>

            <div class="d-flex gap-2 mt-3">
              <button type="button" class="btn btn-outline-primary" id="add-line">
                <i class="fas fa-plus"></i> Add line
              </button>
              <a href="{% url 'sales:quotation_add' %}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Back
              </a>
              <button type="submit" class="btn btn-success">
                <i class="fas fa-check"></i> Finish
              </button>
            </div>
          </form>
        </div>

        <div class="card-footer text-muted">
          Minimal 1 line terisi. Amount dihitung otomatis (format Indonesia).
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
{% block extra_css %}
 <link rel="stylesheet" href="https://code.jquery.com/ui/1.14.1/themes/base/jquery-ui.css">
<style>
/* gaya badge di dropdown autocomplete */
.ui-autocomplete .badge {
  font-size: 0.85rem;       /* ukuran huruf sedikit lebih besar */
  font-weight: 500;
  background-color: #0d6efd; /* warna biru bootstrap */
  color: #fff;
  padding: 2px 8px;
  border-radius: 0.5rem;
}

/* gaya item dropdown */
.ui-autocomplete li div {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 4px 8px;
}

/* supaya dropdown-nya lebih jelas */
.ui-autocomplete {
  max-height: 250px;
  overflow-y: auto;
  overflow-x: hidden;
  z-index: 1051 !important; /* biar di atas modal/adminlte */
  font-size: 0.9rem;
}
.is-invalid {
  border-color: #dc3545 !important;
  background-color: #ffe8e8 !important;
}
.is-invalid:focus {
  box-shadow: 0 0 0 0.2rem rgba(220,53,69,.25);
}

</style>

{% endblock %}

{% block extra_js %}
<script>
(function(){
  // ===== Helpers format lokal (id-ID) =====
  const nf = new Intl.NumberFormat('id-ID', {minimumFractionDigits: 2, maximumFractionDigits: 2});
  function parseId(s){ if(s==null) return 0; s=String(s).trim(); if(!s) return 0; s=s.replace(/\./g,'').replace(',','.'); const n=Number(s); return isFinite(n)?n:0; }
  function fmtId(n){ const num=(typeof n==='number')?n:parseId(n); return nf.format(num); }

  // Header grand total (jika ada)
  (function(){
    const el = document.getElementById('header-grand-total');
    if (!el) return;
    el.textContent = fmtId(el.getAttribute('data-amount') || '0');
  })();

  const container = document.getElementById('lines-container');

  function sumLive(){
    let total=0;
    container.querySelectorAll('.line').forEach(line=>{
      const amt = line.querySelector('input[name="amount_display[]"]');
      total += parseId(amt?.value || '0');
    });
    const live = document.getElementById('live-grand-total');
    if (live) live.textContent = fmtId(total);
  }

  function hookCalc(line){
    const qty   = line.querySelector('input[name="qty[]"]');
    const price = line.querySelector('input[name="price[]"]');
    const amt   = line.querySelector('input[name="amount_display[]"]');

    // auto-select on focus
    [qty, price, amt].forEach(inp=>{
      if (!inp) return;
      inp.addEventListener('focus', ()=> setTimeout(()=> inp.select(),0));
    });

    function recalc(){
      const q = parseId(qty?.value||'0');
      const p = parseId(price?.value||'0');
      if (amt) amt.value = fmtId(q*p);
      sumLive();
    }
    qty && qty.addEventListener('input', recalc);
    price && price.addEventListener('input', recalc);

    // beautify on blur
    qty && qty.addEventListener('blur', e=> e.target.value = fmtId(e.target.value));
    price && price.addEventListener('blur', e=> e.target.value = fmtId(e.target.value));

    // init values
    recalc();
    if(qty && qty.value)     qty.value   = fmtId(qty.value);
    if(price && price.value) price.value = fmtId(price.value);
    if(amt && !amt.value)    amt.value   = fmtId(0);
  }

  // expose biar bisa dipanggil script lain
  window.hookCalc = hookCalc;
  window.sumLive  = sumLive;

  // init semua baris yang sudah ada
  container.querySelectorAll('.line').forEach(hookCalc);
  sumLive();

  // === REMOVE via event delegation ===
  container.addEventListener('click', function(e){
    const btn = e.target.closest('.btn-remove');
    if (!btn) return;

    const line = btn.closest('.line');
    if (!line) return;

    const lines = container.querySelectorAll('.line');
    if (lines.length > 1) {
      // jika pakai jQuery UI di input, destroy dulu (aman kalau tidak ada)
      if (window.jQuery) {
        const $row = window.jQuery(line);
        $row.find('.js-origin-input, .js-dest-input').each(function(){
          try { window.jQuery(this).autocomplete('destroy'); } catch(e){}
        });
      }
      line.remove();
      sumLive();
    } else {
      // minimal 1 baris: reset saja
      line.querySelectorAll('input, textarea, select').forEach(el=>{
        if (el.tagName === 'SELECT') el.selectedIndex = 0;
        else el.value = '';
        el.classList.remove('ui-autocomplete-input');
        el.removeAttribute('aria-controls');
        el.removeAttribute('aria-expanded');
        el.removeAttribute('role');
      });
      sumLive();
    }
  });
})();
</script>
<!-- jQuery & jQuery UI (urutan wajib: jQuery dulu, baru UI) -->
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://code.jquery.com/ui/1.14.1/jquery-ui.min.js"></script>
<link rel="stylesheet" href="https://code.jquery.com/ui/1.14.1/themes/base/jquery-ui.css">

<script>
$(function () {
  function wire($input, $hidden) {
    try { $input.autocomplete("destroy"); } catch(e) {}

    $input.autocomplete({
      minLength: 1,
      delay: 200,
      source: function(req, resp){
        $.getJSON("/ajax/locations/autocomplete/", { term: req.term }, resp);
      },
      select: function(e, ui){
        var withKind = ui.item.label + (ui.item.kind ? (" [" + ui.item.kind + "]") : "");
        $input.val(withKind);
        $hidden.val(ui.item.id);
        return false;
      },
      change: function(e, ui){
        if (!ui.item) $hidden.val("");
      }
    });

    // dropdown: Name + badge kind
    var inst = $input.autocomplete("instance");
    if (inst) {
      inst._renderItem = function(ul, item) {
        var badge = item.kind ? '<span class="badge rounded-pill" style="margin-left:8px;">'+ item.kind +'</span>' : '';
        return $("<li>").append('<div style="display:flex;align-items:center;justify-content:space-between;padding:4px 8px;">'
          + '<span>'+ item.label +'</span>' + badge + '</div>').appendTo(ul);
      };
    }
  }

  function hookAuto(line){
    const $row = $(line);
    wire($row.find(".js-origin-input"), $row.find(".js-origin-id"));
    wire($row.find(".js-dest-input"),   $row.find(".js-dest-id"));
  }

  // expose biar bisa dipanggil dari script lain
  window.hookAuto = hookAuto;

  // init baris yang sudah ada
  document.querySelectorAll(".line").forEach(hookAuto);

  // === ADD LINE ===
  const container = document.getElementById('lines-container');
  const addBtn = document.getElementById('add-line');
  if (addBtn) {
    addBtn.addEventListener('click', ()=>{
      const first = container.querySelector('.line');
      const clone = first.cloneNode(true);

      // reset nilai & bersihkan jejak jQuery UI yang mungkin ikut ter-copy
      clone.querySelectorAll('input, textarea, select').forEach(el=>{
        if (el.tagName === 'SELECT') el.selectedIndex = 0;
        else el.value = '';
        el.removeAttribute('id');
        el.classList.remove('ui-autocomplete-input');
        el.removeAttribute('aria-controls');
        el.removeAttribute('aria-expanded');
        el.removeAttribute('role');
      });

      container.appendChild(clone);
      // panggil KEDUANYA untuk baris baru
      if (window.hookCalc) window.hookCalc(clone);
      hookAuto(clone);
    });
  }
});
</script>
<script>
(function(){
  const form = document.getElementById('lines-form');
  form.addEventListener('submit', (e)=>{
    const lines = Array.from(container.querySelectorAll('.line'));

    const errors = [];
    const seen = new Set();
    const toRemove = [];

    // Bersihkan baris kosong, cek validasi, tandai duplikat
    lines.forEach((line, idx)=>{
      const v = readLine(line);

      // buang baris kosong
      if (isEmptyLine(v)) {
        toRemove.push(line);
        return;
      }

      // VALIDASI WAJIB
      if (!v.originId) errors.push(`Line ${idx+1}: Origin wajib dipilih dari daftar.`);
      if (!v.destId)   errors.push(`Line ${idx+1}: Destination wajib dipilih dari daftar.`);
      if (!v.uomId)    errors.push(`Line ${idx+1}: UoM wajib diisi.`);
      if (!(v.qty > 0))   errors.push(`Line ${idx+1}: Qty harus > 0.`);
      if (!(v.price >= 0)) errors.push(`Line ${idx+1}: Price tidak boleh negatif.`);

      // DEDUPE (baris sama persis)
      const key = makeKey(v);
      if (seen.has(key)) {
        toRemove.push(line);
      } else {
        seen.add(key);
      }
    });

  });
})();
</script>


{% endblock %}
