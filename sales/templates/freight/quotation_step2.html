{% extends "base.html" %}
{% load static %}

{% block title %}New Freight Quotation — Step 2{% endblock %}

{% block content %}
<div class="row">
  <div class="col-lg-12">
    <div class="card card-success card-outline">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h3 class="card-title m-0"><i class="fas fa-list"></i> Step 2 — Quotation Lines</h3>
        <span class="text-muted">Quotation #{{ quotation.id }}</span>
      </div>
      <div class="card-body">
        <form method="post" id="lines-form">
          {% csrf_token %}
          {{ formset.management_form }}

          <div id="forms" class="d-flex flex-column gap-3">
            {% for form in formset.forms %}
              <div class="card shadow-sm line" data-index="{{ forloop.counter0 }}">
                <div class="card-body">
                  <div class="row g-3">
                    {% for field in form.visible_fields %}
                      <div class="col-md-4">
                        <label class="form-label">{{ field.label }}</label>
                        {{ field|add_class:"form-control" }}
                        {% for err in field.errors %}<div class="text-danger small">{{ err }}</div>{% endfor %}
                      </div>
                    {% endfor %}
                  </div>
                </div>

                {% if formset.can_delete %}
                  <input type="hidden" class="del-flag" name="{{ form.prefix }}-DELETE" id="{{ form.prefix }}-DELETE" value="">
                  <div class="card-footer d-flex justify-content-end">
                    <button type="button" class="btn btn-sm btn-outline-danger btn-delete">
                      <i class="fas fa-trash"></i> Delete line
                    </button>
                  </div>
                {% endif %}
              </div>
            {% endfor %}
          </div>

          <!-- Template baris baru -->
          <template id="empty-form-template">
            <div class="card shadow-sm line" data-index="__prefix__">
              <div class="card-body">
                <div class="row g-3">
                  {{ formset.empty_form.as_p|safe }}
                </div>
              </div>
              {% if formset.can_delete %}
                <input type="hidden" class="del-flag" name="__prefix__-DELETE" id="__prefix__-DELETE" value="">
                <div class="card-footer d-flex justify-content-end">
                  <button type="button" class="btn btn-sm btn-outline-danger btn-delete">
                    <i class="fas fa-trash"></i> Delete line
                  </button>
                </div>
              {% endif %}
            </div>
          </template>

          <div class="d-flex gap-2 mt-3">
            <button type="button" class="btn btn-outline-primary" id="add-line">
              <i class="fas fa-plus"></i> Add line
            </button>
            <a href="{% url 'sales:freight_quotation_add' %}" class="btn btn-secondary">
              <i class="fas fa-arrow-left"></i> Back
            </a>
            <button type="submit" class="btn btn-success">
              <i class="fas fa-check"></i> Finish
            </button>
          </div>
        </form>
      </div>
      <div class="card-footer text-muted">Minimal 1 line terisi. Amount dihitung otomatis.</div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
  (function(){
    const prefix = '{{ formset.prefix }}';
    const totalEl = document.getElementById('id_' + prefix + '-TOTAL_FORMS');
    const container = document.getElementById('forms');
    const tmpl = document.getElementById('empty-form-template').content;

    function renumber(el, idx) {
      el.querySelectorAll('input, select, textarea, label').forEach(node => {
        ['name','id','for','value'].forEach(attr => {
          const v = node.getAttribute(attr);
          if (!v) return;
          node.setAttribute(attr, v.replace(/__prefix__/g, idx));
        });
      });
      el.setAttribute('data-index', idx);
    }

    function hookLine(lineEl) {
      const qtyInput   = lineEl.querySelector(`input[name^="${prefix}-"][name$="-qty"]`);
      const priceInput = lineEl.querySelector(`input[name^="${prefix}-"][name$="-price"]`);
      const amtInput   = lineEl.querySelector(`input[name^="${prefix}-"][name$="-amount"]`);
      const delFlag    = lineEl.querySelector('.del-flag');
      const delBtn     = lineEl.querySelector('.btn-delete');

      function recalc() {
        const q = parseFloat(qtyInput?.value || '0');
        const p = parseFloat(priceInput?.value || '0');
        const amount = isFinite(q) && isFinite(p) ? (q * p) : 0;
        if (amtInput) amtInput.value = amount.toFixed(2);
      }
      qtyInput && qtyInput.addEventListener('input', recalc);
      priceInput && priceInput.addEventListener('input', recalc);
      recalc(); // initial

      if (delBtn && delFlag) {
        delBtn.addEventListener('click', () => {
          delFlag.value = 'on';        // tandai delete untuk formset
          lineEl.style.display = 'none';
        });
      }
    }

    // hook existing
    container.querySelectorAll('.line').forEach(hookLine);

    // add new
    document.getElementById('add-line').addEventListener('click', () => {
      const idx = parseInt(totalEl.value, 10);
      const clone = document.importNode(tmpl, true);
      renumber(clone, idx);
      container.appendChild(clone);
      totalEl.value = idx + 1;
      const newLine = container.querySelector(`.line[data-index="${idx}"]`);
      hookLine(newLine);
    });
  })();
</script>
{% endblock %}
