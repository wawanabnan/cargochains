{% extends "base.html" %}
{% load static %}
{% block title %}Freight Quotations{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="card card-primary card-outline">
    <div class="card-header d-flex flex-wrap gap-2 align-items-center">
      <h3 class="card-title m-0"><i class="fas fa-file-invoice-dollar"></i> Freight Quotations</h3>

      <form class="ms-auto d-flex gap-2" method="get">
        <input type="text" class="form-control" name="q" placeholder="Search number / customer…" value="{{ q|default:'' }}">
        <button class="btn btn-outline-primary"><i class="fas fa-search"></i> Search</button>
        <a class="btn btn-primary" href="{% url 'sales:freight_quotation_add' %}">
          <i class="fas fa-plus"></i> New
        </a>
      </form>
    </div>

    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0" id="odoo-like-table">
          <thead class="table-light">
            <tr>
              <th style="width:42px;">
                <input type="checkbox" id="check-all" class="form-check-input">
              </th>
              <th style="width: 140px;">Number</th>
              <th style="width: 110px;">Date</th>
              <th>Customer</th>
              <th style="width: 140px;">Currency</th>
              <th class="text-end" style="width: 180px;">Total Amount</th>
              <th style="width: 140px;">Valid Until</th>
            </tr>
          </thead>
          <tbody id="fq-list">
            {% if quotations %}
              {% for r in quotations %}
              <tr class="clickable-row" data-href="{% url 'sales:freight_quotation_add_lines' r.id %}" data-total="{{ r.total_amount|default:'0.00' }}">
                <td>
                  <input type="checkbox" class="form-check-input row-check" value="{{ r.id }}" aria-label="Select {{ r.number }}">
                </td>
                <td>
                  <span class="fw-semibold">{{ r.number }}</span>
                </td>
                <td>{{ r.date|date:"Y-m-d" }}</td>
                <td>{{ r.customer }}</td>
                <td>{{ r.currency }}</td>
                <td class="text-end fw-semibold total-id">0,00</td>
                <td>{{ r.valid_until|date:"Y-m-d"|default:"—" }}</td>
              </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td colspan="7" class="text-center text-muted py-4">No data.</td>
              </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>

    <div class="card-footer d-flex justify-content-between align-items-center">
      <div>
        <small class="text-muted">Showing max 200 latest records.</small>
        {% if q %}<small class="ms-2"><span class="badge bg-info">Filter:</span> <code>{{ q }}</code></small>{% endif %}
      </div>
      <div id="selection-info" class="text-muted d-none">
        <small><span id="selected-count">0</span> selected</small>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
  /* Odoo-ish feel */
  #odoo-like-table tbody tr.clickable-row { cursor: pointer; }
  #odoo-like-table tbody tr.clickable-row:hover { background: rgba(0,0,0,.03); }
  /* keep checkbox column tight */
  #odoo-like-table td:first-child, #odoo-like-table th:first-child { text-align: center; }
</style>
{% endblock %}

{% block extra_js %}
<script>
  (function(){
    // Format kolom Total Amount pakai locale Indonesia
    const nf = new Intl.NumberFormat('id-ID', {minimumFractionDigits:2, maximumFractionDigits:2});
    document.querySelectorAll('#fq-list tr').forEach(tr=>{
      const raw = tr.getAttribute('data-total');
      const cell = tr.querySelector('.total-id');
      if (!cell) return;
      const num = Number((raw||'0').toString().replace(',', '.')) || 0;
      cell.textContent = nf.format(num);
    });

    // Row click -> open detail (kecuali klik checkbox)
    document.querySelectorAll('#fq-list tr.clickable-row').forEach(tr=>{
      tr.addEventListener('click', (e)=>{
        const t = e.target;
        if (t.closest('input[type="checkbox"]')) return; // jangan navigate kalau klik checkbox
        const url = tr.getAttribute('data-href');
        if (url) window.location = url;
      });
    });

    // Checkbox behavior ala Odoo (select all + counter)
    const selInfo = document.getElementById('selection-info');
    const selCount = document.getElementById('selected-count');
    const checks = Array.from(document.querySelectorAll('.row-check'));
    const checkAll = document.getElementById('check-all');

    function refreshSelected(){
      const n = checks.filter(c=>c.checked).length;
      selCount.textContent = n;
      selInfo.classList.toggle('d-none', n === 0);
      if (checks.length) {
        const all = n === checks.length, some = n > 0 && n < checks.length;
        checkAll.checked = all;
        checkAll.indeterminate = some;
      }
    }

    checks.forEach(c=>{
      c.addEventListener('click', (e)=> e.stopPropagation()); // klik checkbox tidak open row
      c.addEventListener('change', refreshSelected);
    });
    if (checkAll){
      checkAll.addEventListener('change', ()=>{
        checks.forEach(c=> c.checked = checkAll.checked);
        refreshSelected();
      });
    }
    refreshSelected();
  })();
</script>
{% endblock %}
