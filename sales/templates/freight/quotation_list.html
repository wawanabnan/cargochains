{% extends "adminbase.html" %}
{% block title %}Freight Quotations{% endblock %}

{% block content %}

<div class="app-content-header">
  <div class="container-fluid">
    <div class="row">
      <div class="col-sm-6">
        <h3 class="mb-0">Quotations</h3>
      </div>
      <div class="col-sm-6">
        <ol class="breadcrumb float-sm-end">
          <li class="breadcrumb-item"><a href="#">Home</a></li>
          <li class="breadcrumb-item active" aria-current="page">New</li>
        </ol>
      </div>
    </div>
  </div>
</div>

   


<div class="app-content"> 

  <div class="container-fluid">
     {% include 'freight/filters/fq-filter-2.html' %}
  </div>
  <div class="container-fluid">
    {% include 'freight/tables/quotation-tbl.html' %}
  </div>
 </div> 

  {% endblock %}

{% block extra_css %}
<style>
  #odoo-like-table tbody tr.clickable-row { cursor: pointer; }
  #odoo-like-table tbody tr.clickable-row:hover { background: rgba(0,0,0,.03); }
 .pagination .page-link {
  border-radius: .375rem;
  padding: .4rem .75rem;
}

/* Samakan tinggi badge dengan btn-sm */
.badge.btn-sm-match {
  font-size: 0.875rem;       /* sama seperti btn-sm */
  padding: 0.4rem 0.5rem;   /* atas-bawah sama dengan tombol kecil */
  line-height: 1.3;
  border-radius: 0.375rem;   /* tombol kecil biasanya 0.375 */
  display: inline-flex;
  align-items: center;
}

.input-group.rounded-pill input.form-control {
  box-shadow: none !important;
  padding: 8px 15;
}
.input-group.rounded-pill input.form-control:focus {
  box-shadow: 0 0 0 .15rem rgba(13,110,253,.15);
  background-color: var(--bs-body-bg);
}
.input-group.rounded-pill .btn {
  color: var(--bs-secondary-color);
}
 
.app-content {
  padding:0px
}

</style>
{% endblock %}

{% block extra_js %}
<script>
(function(){
  // ---------- URLs (Django URL names) ----------
  
  const BULK_DELETE_URL = "#";
  const BULK_PRINT_URL  = "#";

  // ---------- Elements ----------
  const panel          = document.getElementById('filters-panel');
  const btnFilters     = document.getElementById('btn-toggle-filters');

  const toolbar        = document.getElementById('quotations-toolbar');
  const searchForm     = document.getElementById('search-form');
  const bulkActions    = document.getElementById('bulk-actions');
  const selCountEl     = document.getElementById('sel-count');
  const bulkIdsInput   = document.getElementById('bulk-ids');
  const bulkForm       = document.getElementById('bulk-form');

  const btnDel         = document.getElementById('btn-bulk-delete');
  const btnPrint       = document.getElementById('btn-bulk-print');

  const checkAll       = document.getElementById('check-all');
  const table          = document.getElementById('fq-list');

  // ---------- Helpers ----------
  const rowChecks = () => Array.from(document.querySelectorAll('.row-check'));
  const getSelectedIds = () => rowChecks().filter(c => c.checked).map(c => c.value);

  function updateToolbar(){
    const checks = rowChecks();
    const selIds = getSelectedIds();
    const hasSel = selIds.length > 0;

    // badge & hidden field
    if (selCountEl)  selCountEl.textContent = selIds.length;
    if (bulkIdsInput) bulkIdsInput.value = selIds.join(',');

    // toggle Search vs Bulk actions (center area)
    if (bulkActions) bulkActions.classList.toggle('d-none', !hasSel);
    if (searchForm)  searchForm.classList.toggle('d-none',  hasSel);

    // enable/disable delete button
    if (btnDel) btnDel.disabled = !hasSel;

    // header checkbox state
    if (checkAll) {
      checkAll.checked = hasSel && selIds.length === checks.length;
      checkAll.indeterminate = hasSel && selIds.length < checks.length;
    }
  }

  // ---------- 1) Toggle Filters Panel ----------
  if (btnFilters && panel){
    btnFilters.addEventListener('click', () => {
      panel.classList.toggle('d-none');
    });
  }

  // ---------- 2) Format Total (IDR) ----------
  try {
    const nf = new Intl.NumberFormat('id-ID', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    if (table) {
      table.querySelectorAll('tr').forEach(tr => {
        const raw  = tr.getAttribute('data-total') || '0';
        const cell = tr.querySelector('.total-id');
        if (cell) {
          const val = Number(String(raw).replace(',', '.'));
          cell.textContent = nf.format(isNaN(val) ? 0 : val);
        }
      });
    }
  } catch(e) { /* noop */ }

  // ---------- 3) Row click -> open detail (skip checkbox) ----------
  if (table) {
    table.querySelectorAll('tr.clickable-row').forEach(tr => {
      tr.addEventListener('click', (e) => {
        if (e.target.closest('input[type="checkbox"]')) return;
        const url = tr.getAttribute('data-href');
        if (url) window.location = url;
      });
    });
  }

  // Stop propagation on row checkboxes
  document.addEventListener('click', (e) => {
    if (e.target.classList && e.target.classList.contains('row-check')) {
      e.stopPropagation();
    }
  });

  // ---------- 4) Selection handling ----------
  if (checkAll) {
    checkAll.addEventListener('change', () => {
      rowChecks().forEach(c => { c.checked = checkAll.checked; });
      updateToolbar();
    });
  }
  document.addEventListener('change', (e) => {
    if (e.target.classList && e.target.classList.contains('row-check')) {
      updateToolbar();
    }
  });

  // ---------- 5) Bulk Delete (POST) + Guard Status ----------
  if (btnDel && bulkForm) {
    btnDel.addEventListener('click', () => {
      const ids = getSelectedIds();
      if (!ids.length) return;

      // status guard: only draft / canceled / cancelled
      const rows = rowChecks().filter(c => c.checked).map(c => c.closest('tr'));
      const blocked = rows.filter(tr => {
        const st = (tr.getAttribute('data-status') || 'draft').toLowerCase().trim();
        return !(st === 'draft' || st === 'canceled' || st === 'cancelled');
      });
      if (blocked.length) {
        const allowed = rows.length - blocked.length;
        const msg = `Only draft/canceled can be deleted.\nAllowed: ${allowed}\nBlocked: ${blocked.length}\nContinue?`;
        if (!confirm(msg)) return;
      } else {
        if (!confirm(`Delete ${ids.length} quotation(s)?`)) return;
      }

      bulkForm.action = BULK_DELETE_URL;
      bulkForm.method = 'post';
      bulkForm.submit();
    });
  }

  // ---------- 6) Bulk Print (GET -> new tab) ----------
  if (btnPrint) {
    btnPrint.addEventListener('click', () => {
      const ids = getSelectedIds();
      if (!ids.length) return;
      const url = new URL(BULK_PRINT_URL, window.location.origin);
      url.searchParams.set('ids', ids.join(','));
      window.open(url.toString(), '_blank');
    });
  }

  // ---------- 7) Initial state ----------
  updateToolbar();
})();
</script>
<script>
(function(){
  // Tombol reset filter
  const btnReset = document.getElementById('btn-reset-filters');
  if (btnReset) {
    btnReset.addEventListener('click', function() {
      const baseUrl = window.location.pathname; // hanya path, tanpa querystring
      window.location.href = baseUrl; // redirect ulang tanpa parameter
    });
  }
})();
</script>


{% endblock %}
