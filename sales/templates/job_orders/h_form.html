{% extends "adminbase.html" %}
{% load static %}

{% block content %}
<div class="app-content">
  <div class="container-fluid">

    <!-- HEADER -->
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h3 class="mb-0">
        {% if job %}Edit Job Order #{{ job.number }}{% else %}New Job Order{% endif %}
      </h3>

      <a href="{% url 'sales:job_order_list' %}" class="btn btn-outline-secondary btn-sm">
        <i class="fa fa-list me-1"></i> Back to List
      </a>
    </div>

    <!-- CARD -->
    <div class="card">
      <div class="card-body">

        {% if form.non_field_errors %}
          <div class="alert alert-danger">{{ form.non_field_errors }}</div>
        {% endif %}

        <form method="post" novalidate>
          {% csrf_token %}

          {% if job %}
            <input type="hidden" name="job_id" value="{{ job.pk }}">
          {% endif %}

          <!-- ======================= JOB INFO ======================= -->
          <h5 class="fw-semibold mt-2">Job Info</h5>
          <hr class="mt-1">

          <div class="row mb-3">
            <label class="col-sm-3 col-form-label">Date</label>
            <div class="col-sm-9">
              {{ form.job_date }} {{ form.job_date.errors }}
            </div>
          </div>

          <div class="row mb-3">
            <label class="col-sm-3 col-form-label">Customer</label>
            <div class="col-sm-9">
              {{ form.customer }} {{ form.customer.errors }}
            </div>
          </div>

          <div class="row mb-3">
            <label class="col-sm-3 col-form-label">Service</label>
            <div class="col-sm-9">
              {{ form.service }} {{ form.service.errors }}
            </div>
          </div>

          <!-- ======================= CARGO INFO ======================= -->
          <h5 class="fw-semibold mt-4">Cargo Information</h5>
          <hr class="mt-1">

          <div class="row mb-3">
            <label class="col-sm-3 col-form-label">Cargo Description</label>
            <div class="col-sm-9">
              {{ form.cargo_description }} {{ form.cargo_description.errors }}
            </div>
          </div>

          <div class="row mb-3">
            <label class="col-sm-3 col-form-label">Quantity</label>
            <div class="col-sm-9">
              {{ form.quantity }} {{ form.quantity.errors }}
            </div>
          </div>

          <div class="row mb-3">
            <label class="col-sm-3 col-form-label">Pick Up</label>
            <div class="col-sm-9">
              {{ form.pickup }} {{ form.pickup.errors }}
            </div>
          </div>

          <div class="row mb-3">
            <label class="col-sm-3 col-form-label">Delivery</label>
            <div class="col-sm-9">
              {{ form.delivery }} {{ form.delivery.errors }}
            </div>
          </div>

          <div class="row mb-3">
            <label class="col-sm-3 col-form-label">PIC</label>
            <div class="col-sm-9">
              {{ form.pic }} {{ form.pic.errors }}
            </div>
          </div>

          <!-- ======================= PAYMENT ======================= -->
          <h5 class="fw-semibold mt-4">Payment</h5>
          <hr class="mt-1">

          <div class="row mb-3">
            <label class="col-sm-3 col-form-label">Payment Term</label>
            <div class="col-sm-9">
              {{ form.payment_term }} {{ form.payment_term.errors }}
            </div>
          </div>

          <div class="row mb-3">
            <label class="col-sm-3 col-form-label">Currency</label>
            <div class="col-sm-9">
              {{ form.currency }} {{ form.currency.errors }}
            </div>
          </div>

          <!-- ======================= TAX ======================= -->
          <h5 class="fw-semibold mt-4">Tax (PPN)</h5>
          <hr class="mt-1">

          <div class="row mb-3">
            <label class="col-sm-3 col-form-label">Apply Tax (1,1%)</label>
            <div class="col-sm-9 d-flex align-items-center">
              <div class="form-check form-switch">
                {{ form.is_tax }} {{ form.is_tax.errors }}
              </div>
            </div>
          </div>

          <div class="row mb-3">
            <label class="col-sm-3 col-form-label">Total Amount</label>
            <div class="col-sm-9">
              {{ form.total_amount }} {{ form.total_amount.errors }}
            </div>
          </div>

          <div class="row mb-3">
            <label class="col-sm-3 col-form-label">Tax Amount</label>
            <div class="col-sm-9">
              {{ form.tax_amount }} {{ form.tax_amount.errors }}
            </div>
          </div>

          <div class="row mb-3">
            <label class="col-sm-3 col-form-label">Grand Total</label>
            <div class="col-sm-9">
              {{ form.grand_total }} {{ form.grand_total.errors }}
            </div>
          </div>

          <!-- ======================= REMARKS ======================= -->
          <h5 class="fw-semibold mt-4">Internal Remarks</h5>
          <hr class="mt-1">

          <div class="row mb-3">
            <label class="col-sm-3 col-form-label">Remarks</label>
            <div class="col-sm-9">
              {{ form.remarks_internal }} {{ form.remarks_internal.errors }}
            </div>
          </div>

          <!-- SUBMIT -->
          <div class="mt-4 d-flex justify-content-end">
            <button type="submit" class="btn btn-primary">
              <i class="fa fa-save me-1"></i>
              {% if job %}Update{% else %}Create{% endif %}
            </button>
          </div>

        </form>
      </div>
    </div>

  </div>
</div>
{% endblock %}

{% block extra_js %}
  {{ block.super }}
  <script>
    (function () {

      // --- helper: parse angka Indonesia "1.000.000,00" -> float ---
      function parseIdNumber(value) {
        if (!value) return 0;
        let s = String(value).trim();
        // hapus spasi
        s = s.replace(/\s+/g, "");
        // hilangkan titik ribuan, koma jadi titik desimal
        s = s.replace(/\./g, "").replace(",", ".");
        const n = parseFloat(s);
        return isNaN(n) ? 0 : n;
      }

      // --- helper: format float -> "1.000.000,00" (locale id-ID) ---
      function formatIdNumber(num) {
        if (isNaN(num)) num = 0;
        return num.toLocaleString("id-ID", {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2,
        });
      }

      // --- hitung tax & grand total ---
      function recalcTax() {
        const totalEl = document.getElementById("id_total_amount");
        const taxEl = document.getElementById("id_tax_amount");
        const grandEl = document.getElementById("id_grand_total");
        const isTaxEl = document.getElementById("id_is_tax");

        if (!totalEl || !taxEl || !grandEl || !isTaxEl) {
          return;
        }

        let total = parseIdNumber(totalEl.value);
        let tax = 0;

        if (isTaxEl.checked) {
          tax = total * 0.011; // 1.1%
        }

        const grand = total + tax;

        // set nilai dengan format Indonesia
        totalEl.value = formatIdNumber(total);
        taxEl.value = formatIdNumber(tax);
        grandEl.value = formatIdNumber(grand);
      }

      document.addEventListener("DOMContentLoaded", function () {
        const totalEl = document.getElementById("id_total_amount");
        const taxEl = document.getElementById("id_tax_amount");
        const grandEl = document.getElementById("id_grand_total");
        const isTaxEl = document.getElementById("id_is_tax");

        if (!totalEl || !taxEl || !grandEl || !isTaxEl) {
          return;
        }

        // lock tax_amount supaya tidak bisa diedit manual
        taxEl.readOnly = true;

        // === 1) FOKUS: angka otomatis ke-select ===
        [totalEl, grandEl].forEach(function (input) {
          if (!input) return;
          input.addEventListener("focus", function () {
            // pakai setTimeout supaya select jalan setelah fokus
            setTimeout(function () {
              input.select();
            }, 0);
          });
        });

        // === 2) RE-CALC saat total berubah ===
        function hookRecalcOnInput(el) {
          if (!el) return;
          el.addEventListener("blur", recalcTax);
          el.addEventListener("change", recalcTax);
          el.addEventListener("keyup", function (e) {
            if (e.key === "Enter") {
              recalcTax();
            }
          });
        }

        hookRecalcOnInput(totalEl);

        // === 3) RE-CALC saat apply tax dicentang / di-uncheck ===
        isTaxEl.addEventListener("change", recalcTax);

        // === 4) Hitung & format sekali di awal load ===
        recalcTax();
      });

    })();
  </script>
{% endblock %}
