{% extends "adminbase.html" %}
{% load static %}

{% block content %}

<div class="app-content-header">
  <div class="container-fluid">
    <div class="row">
      <div class="col-sm-6">
        <h3 class="mb-0">Job Orders</h3>
      </div>
      <div class="col-sm-6">
        <ol class="breadcrumb float-sm-end">
          <li class="breadcrumb-item active" aria-current="page">
            <a href="{% url 'sales:job_order_list' %}" class="btn btn-outline-secondary btn-sm">
              <i class="fa fa-list me-1"></i> Back to List
            </a>

          </li>
        </ol>
      </div>
    </div>
  </div>
</div>

<div class="app-content">
  <div class="container-fluid ">
    <div class="card">
      <div class="card-body">

        {% if form.non_field_errors %}
          <div class="alert alert-danger">{{ form.non_field_errors }}</div>
        {% endif %}

        {% if form.errors or form.non_field_errors %}
  <div class="alert alert-danger">
    <ul class="mb-0">
      {% for field, errors in form.errors.items %}
        {% for error in errors %}
          <li><strong>{{ field }}:</strong> {{ error }}</li>
        {% endfor %}
      {% endfor %}
      {% for error in form.non_field_errors %}
        <li>{{ error }}</li>
      {% endfor %}
    </ul>
  </div>
{% endif %}
        <form method="post" novalidate>
          {% csrf_token %}

          {% if job %}
            <input type="hidden" name="job_id" value="{{ job.pk }}">
          {% endif %}

          <!-- ======================= JOB INFO ======================= -->
        <div class="container-fluid py-3">
          <div class="row">
              <div class="col px-4">
                {% include 'job_orders/extension/col_1.html' %}

              </div>
              
              <div class="col px-4">
                {% include 'job_orders/extension/col_2.html' %}
              </div>

          </div>
          

        </div>
        
        

          <hr>
          <div class="mt-1"></div>
          <!-- SUBMIT -->
          <div class="mt-4 d-flex justify-content-end">
            <button type="submit" class="btn btn-primary">
              <i class="fa fa-save me-1"></i>
              {% if job %}Update{% else %}Create{% endif %}
            </button>
          </div>

        </form>
      </div>
    </div>

  </div>
</div>
{% endblock %}


{% block extra_js %}
<script>
(function(){

  function parseID(v) {
    if (!v) return 0;
      let s = String(v).trim();

      // Kalau ada koma → style Indonesia: 20.000.000,00
      if (s.indexOf(",") >= 0) {
        s = s.replace(/\./g, "").replace(",", ".");
        const n = parseFloat(s);
        return isNaN(n) ? 0 : n;
      }

      // Kalau TIDAK ada koma → anggap "." itu desimal biasa
      const n = parseFloat(s);
      return isNaN(n) ? 0 : n;
  }


  function fmtID(n){
    return n.toLocaleString("id-ID",
      {minimumFractionDigits:2, maximumFractionDigits:2});
  }

  function recalc(){
    const totalEl = document.getElementById("id_total_amount");
    const taxEl   = document.getElementById("id_tax_amount");
    const grandEl = document.getElementById("id_grand_total");
    const isTaxEl = document.getElementById("id_is_tax");

    let total = parseID(totalEl.value);
    let tax   = isTaxEl.checked ? total * 0.011 : 0;
    let grand = total + tax;

    totalEl.value = fmtID(total);
    taxEl.value   = fmtID(tax);
    grandEl.value = fmtID(grand);
  }

  document.addEventListener("DOMContentLoaded", function(){

    const totalEl = document.getElementById("id_total_amount");
    const taxEl   = document.getElementById("id_tax_amount");
    const grandEl = document.getElementById("id_grand_total");
    const isTaxEl = document.getElementById("id_is_tax");
    const form    = document.querySelector("form");

    if(!form || !totalEl) return;

    taxEl.readOnly = true;

    // --- auto-select saat focus ---
    [totalEl, grandEl].forEach(function(el){
      el.addEventListener("focus", ()=> setTimeout(()=>el.select(),0));
    });

    // --- perhitungan ---
    totalEl.addEventListener("blur", recalc);
    totalEl.addEventListener("change", recalc);
    isTaxEl.addEventListener("change", recalc);

    // --- format pertama kali ---
    recalc();

    // --- sebelum submit → convert ke format yg diterima Django ---
    form.addEventListener("submit", function(){
      totalEl.value = parseID(totalEl.value);
      taxEl.value   = parseID(taxEl.value);
      grandEl.value = parseID(grandEl.value);
    });

  });

})();
</script>
{% endblock %}
