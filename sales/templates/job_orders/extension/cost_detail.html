{% load indo_format %}

<form method="post" action="{% url 'sales:job_order_costs_update' job.pk %}" novalidate>
  {% csrf_token %}
  {{ cost_formset.management_form }}

  {% if cost_formset.non_form_errors %}
    <div class="alert alert-danger py-2 mb-2">{{ cost_formset.non_form_errors }}</div>
  {% endif %}

{# error umum formset #}
{% if cost_formset.non_form_errors %}
  <div class="alert alert-danger py-2 mb-2">
    {{ cost_formset.non_form_errors }}
  </div>
{% endif %}

{# error per form/row (biar ketahuan baris mana) #}
{% for f in cost_formset.forms %}
  {% if f.errors %}
    <div class="alert alert-danger py-2 mb-2">
      <strong>Row {{ forloop.counter }} error:</strong>
      {{ f.errors }}
    </div>
  {% endif %}
{% endfor %}


  <div class="card">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-sm mb-0 align-middle" id="jobcost-table" >
          <thead class="table-light">
            <tr>
             
              <th>Description</th>

              {# ✅ kolom baru #}
              <th style="width:140px;">Category</th>
              <th style="width:220px;">Vendor / Note</th>

              <th class="text-center" style="width:100px;">Qty</th>
              <th class="text-end" style="width:150px;">Price</th>
              <th class="text-end" style="width:150px;">Amount</th>

              <th class="text-center" style="width:60px;">Del</th>
            </tr>
          </thead>
            <tbody id="jobcost-body">
            {% for f in cost_formset %}
              <tr class="jobcost-row">
                {{f.id }}
                <td>{{ f.description }}</td>
                <td>{{ f.category }}</td>
                <td>
                  <div class="mb-1 js-vendor-wrap">{{ f.vendor }}</div>
                  <div class="js-internal-note-wrap  d-none">  {{ f.internal_note }}</div>
                </td>
                <td class="text-center">{{ f.qty }}</td>
                <td class="text-end">{{ f.price }}</td>
                <td class="text-end">{{ f.amount }}</td>
                <td class="text-center">
                  <div class="d-none">
                  {{ f.DELETE }}
                  </div>
                  <button type="button" class="btn btn-link btn-sm text-danger remove-row">x</button>
                </td>
              </tr>
            {% endfor %}
          </tbody>


          <tfoot>
            <tr class="fw-semibold">
              <td colspan="5" class="text-end">Total Job Cost</td>
              <td class="text-end">{{ total_cost|indo_number }}</td>
              <td></td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>


    <!-- BARIS KONTROL -->
<div class="d-flex justify-content-between align-items-center  p-2">
  <button type="button"
          class="btn btn-outline-primary btn-sm"
          id="btn-jobcost-add">
    <i class="bi bi-plus-lg"></i> Add Row
  </button>

  <button type="submit"
          class="btn btn-primary btn-sm">
    <i class="bi bi-save"></i> Save
  </button>
</div>



  </div>


  {# ✅ template row harus TR + TD (bukan TH) #}
 <template id="jobcost-empty-row">
  {% with f=cost_formset.empty_form %}
    <tr class="jobcost-row">
       {{f.id }}
      <td>{{ f.description }}</td>
      <td>{{ f.category }}</td>
      <td>
        <div class="mb-1 js-vendor-wrap">{{ f.vendor }}</div>
        <div  class="js-internal-note-wrap d-none">{{ f.internal_note }}</div>
      </td>
      <td class="text-center">{{ f.qty }}</td>
      <td class="text-end">{{ f.price }}</td>
      <td class="text-end">{{ f.amount }}</td>
      <td class="text-center ">
        <button type="button"
          class="btn btn-link btn-sm text-danger remove-row">
            x
          </button>

          <!-- checkbox DELETE (DISUNYIKAN) -->
          <div class="d-none">
            {{ f.DELETE }}
          </div>
      </td>
    </tr>
  {% endwith %}
</template>


</form>
