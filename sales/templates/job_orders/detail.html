{# templates/sales/job_order_detail.html #}
{% extends "adminbase.html" %}
{% load static %}
{% load indo_format %}  {# kalau filter indo_number ada di sini #}

{% block content %}

<div class="app-content">
  <div class="container-fluid">

    {# HEADER #}
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        <h1 class="h4 mb-0">Job Order Detail</h1>
        <div class="text-muted small">
          Job No: <strong>{{ job.number }}</strong><br>
          Date: {{ job.job_date|date:"d-m-Y" }}
        </div>
      </div>
      <div class="d-flex gap-2">
        <a href="{% url 'sales:job_order_list' %}"
           class="btn btn-outline-secondary btn-sm">
          <i class="fa fa-arrow-left me-1"></i> Back to List
        </a>
        <a href=""
           class="btn btn-primary btn-sm">
          <i class="fa fa-edit me-1"></i> Edit
        </a>
        <form method="post" action="{% url 'sales:invoice_generate_from_job' job.pk %}">
  {% csrf_token %}
  <button class="btn btn-sm btn-primary">To Invoice2</button>
</form>

        <a href="{% url 'sales:job_order_revenue_pdf' job.pk %}"
            class="btn btn-outline-primary btn-sm"
            target="_blank">
            <i class="fa fa-file-pdf me-1"></i> Revenue PDF
          </a>

      </div>
    </div>


<div class="card shadow-sm">
  <div class="card-header py-2">
    <div class="d-flex align-items-center justify-content-between">
      <div class="d-flex align-items-center gap-2">
        <div class="fw-semibold">
          Job Information
          <span class="text-muted ms-2">{{ job.job_no|default:job.pk }}</span>
        </div>

        {# contoh status badge, sesuaikan field status kamu #}
        {% if job.status %}
          <span class="badge text-bg-secondary">{{ job.status|title }}</span>
        {% endif %}
      </div>

      <div class="d-flex gap-2">
        {# contoh tombol: edit header / print / dll, sesuaikan url #}
        <a href="{% url 'sales:job_order_edit' job.pk %}" class="btn btn-outline-secondary btn-sm">
          <i class="bi bi-pencil"></i> Edit
        </a>
        <a href="{% url 'sales:job_order_revenue_pdf' job.pk %}" class="btn btn-outline-primary btn-sm">
          <i class="bi bi-printer"></i> Print
        </a>
        <a href="{% url 'sales:job_order_generate_invoice' job.pk %}" class="btn btn-outline-primary btn-sm">
          <i class="bi bi-printer"></i> To Invoice3
        </a>
      </div>
    </div>
  </div>

  <div class="card-body py-2">
    <div class="row g-2">

      {# LEFT: core info #}
      <div class="col-lg-8">
        <div class="row g-2">

          <div class="col-md-6">
            <div class="small text-muted">Customer</div>
            <div class="fw-semibold text-truncate">
              {{ job.customer.company_name|default:job.customer.name }}
            </div>
          </div>

          <div class="col-md-6">
            <div class="small text-muted">Service</div>
            <div class="text-truncate">
              {{ job.service.name }} <span class="text-muted">({{ job.service.service_group }})</span>
            </div>
          </div>

          <div class="col-md-6">
            <div class="small text-muted">Cargo</div>
            <div class="text-truncate">{{ job.cargo_description|default:"-" }}</div>
          </div>

          <div class="col-md-6">
            <div class="small text-muted">PIC</div>
            <div class="text-truncate">{{ job.pic|default:"-" }}</div>
          </div>

          <div class="col-md-6">
            <div class="small text-muted">Pickup</div>
            <div class="text-truncate">{{ job.pickup|default:"-" }}</div>
          </div>

          <div class="col-md-6">
            <div class="small text-muted">Delivery</div>
            <div class="text-truncate">{{ job.delivery|default:"-" }}</div>
          </div>

          <div class="col-md-6">
            <div class="small text-muted">Payment Term</div>
            <div class="text-truncate">{{ job.payment_term.name|default:"-" }}</div>
          </div>

          <div class="col-md-6">
            <div class="small text-muted">Sales</div>
            <div class="text-truncate">
              {% if job.sales_user %}
                {{ job.sales_user.get_full_name|default:job.sales_user.username }}
              {% else %}
                -
              {% endif %}
            </div>
          </div>

        </div>
      </div>

      {# RIGHT: money panel #}
      <div class="col-lg-4">
        <div class="border rounded-3 p-2 bg-body-tertiary">
          <div class="d-flex align-items-center justify-content-between mb-1">
            <div class="small text-muted">Currency</div>
            <div class="fw-semibold">{{ job.currency.code|default:"-" }}</div>
          </div>

          <div class="d-flex align-items-center justify-content-between">
            <div class="small text-muted">Total</div>
            <div class="text-end">{{ job.total_amount|indo_number }}</div>
          </div>

          <div class="d-flex align-items-center justify-content-between">
            <div class="small text-muted">Tax</div>
            <div class="text-end">{{ job.tax_amount|indo_number }}</div>
          </div>

          <hr class="my-2">

          <div class="d-flex align-items-center justify-content-between">
            <div class="small text-muted">Grand Total</div>
            <div class="text-end fw-semibold fs-6">{{ job.grand_total|indo_number }}</div>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>


    {#===========================================#}
    <ul class="nav nav-pills nav-fill  mynav mt-2" 
                id="myTab" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link active " 
                        id="home-tab" 
                        data-bs-toggle="tab" data-bs-target="#costTab" 
                        type="button" role="tab" 
                        aria-controls="home" aria-selected="true">Job Cost
                </button>
              </li>
               <li class="nav-item" role="presentation">
                <button class="nav-link" 
                        id="home-tab" 
                        data-bs-toggle="tab" data-bs-target="#noteTab" 
                        type="button" role="tab" 
                        aria-controls="home" aria-selected="true">Note
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link" 
                        id="profile-tab" 
                        data-bs-toggle="tab" data-bs-target="#attachmentTab" 
                        type="button" role="tab" 
                        aria-controls="profile" aria-selected="false">Attachment
                </button>
              </li>
              
            
            </ul>
            <div class="tab-content border border-0 mt-3" id="myCargoPriceTab">
                <div class="tab-pane fade show active" 
                    id="costTab" 
                    role="tabpanel" aria-labelledby="cargotab">
                     {% include 'job_orders/extension/cost_detail.html' %}


                </div>
                 <div class="tab-pane fade show active" 
                    id="noteTab" 
                    role="tabpanel" aria-labelledby="notetab">
                    

                </div>
                <div class="tab-pane fade" 
                      id="attachmentTab" 
                      role="tabpanel" aria-labelledby="price-tab">
                       {% include 'job_orders/extension/attachment.html' %}

                </div>
                 
            </div>





  </div>
  
</div>

{% endblock %}
{% block extra_css %}

<style>
#myTab {border:none}  
#myTab .nav-link {
    background-color: #cdcacd !important;  /* warna background active */
    border-radius: 0;
    color: #fff !important;                /* warna teks */
    text-transform: uppercase;

}

#myTab .nav-link.active {
    background-color: #ab1680 !important;  /* warna background active */
    border-radius: 0;
    color: #fff !important;            
    font-weight: bold;
}

.mynav > .nav-pills .mynav > .nav-link.active {
    background-color:blueviolet /* Replace with your desired color code */
    color: #F0F8FF; /* Optional: Change text color for contrast */
}


.tab-content {
  padding: 0px;
  min-height: 100px;
  background-color: #fff;
}

jobcost-table  .form-control  {
  border:none !important;
  box-shadow: none;

}

#jobcost-table tr td {
  padding: 0;
}


#jobcost-table tr th {
  background:#f4f4f4;
  padding:5px 15x !important
}

#jobcost-table tfoot tr td {
  padding: 10px;
}
  
#jobcost-table,
#jobcost-table th,
#jobcost-table td,
#jobcost-table thead th,
#jobcost-table tbody td,
#jobcost-table tfoot td {
  font-size: 0.8rem; /* sama dengan .table-sm Bootstrap */
}



</style>

<link rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/airbnb.css">

{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>


<script>
(function() {

  // =========================
  // HELPER FORMAT INDONESIA
  // =========================
  function parseID(v) {
    if (!v) return 0;
    let s = String(v).trim();

    // Indonesia: 20.000.000,00
    if (s.indexOf(",") >= 0) {
      s = s.replace(/\./g, "").replace(",", ".");
      const n = parseFloat(s);
      return isNaN(n) ? 0 : n;
    }

    // tanpa koma: anggap desimal biasa
    const n = parseFloat(s);
    return isNaN(n) ? 0 : n;
  }

  function fmtID(n) {
    return Number(n || 0).toLocaleString("id-ID", {
      minimumFractionDigits: 2,
      maximumFractionDigits: 2,
    });
  }

  // =========================
  // VENDOR vs INTERNAL NOTE (SINGLE SOURCE OF TRUTH)
  // =========================
  function isInternalCategory(selectEl) {
  const val = (selectEl.value || "").toLowerCase();
  const text = (selectEl.options && selectEl.selectedIndex >= 0)
    ? (selectEl.options[selectEl.selectedIndex].text || "").toLowerCase()
    : "";

  // ✅ RULE SIMPLE & KEBAL:
  // kalau mengandung kata "vendor" → vendor cost
  // selain itu → internal/non-vendor
  const isVendor = val.includes("vendor") || text.includes("vendor");
  return !isVendor;
}

  function applyVendorNoteState(row) {
    const cat = row.querySelector('select[name$="-category"]');
    const vw  = row.querySelector(".js-vendor-wrap");
    const nw  = row.querySelector(".js-internal-note-wrap");
    if (!cat || !vw || !nw) return;

    const internal = isInternalCategory(cat);

    if (internal) {
      // vendor hide
      vw.classList.add("d-none");
      vw.style.display = "none";

      // note show
      nw.classList.remove("d-none");
      nw.style.display = "";
      nw.style.visibility = "visible";
    } else {
      // vendor show
      vw.classList.remove("d-none");
      vw.style.display = "";
      vw.style.visibility = "visible";

      // note hide
      nw.classList.add("d-none");
      nw.style.display = "none";
    }
  }

  // =========================
  // DOM READY
  // =========================
  document.addEventListener("DOMContentLoaded", function () {

    // ==========================================
    // A. HEADER TOTAL / TAX / PPH / GRAND TOTAL
    // ==========================================
    const totalEl = document.getElementById("id_total_amount");
    const taxEl   = document.getElementById("id_tax_amount");
    const pphEl   = document.getElementById("id_pph_amount");
    const grandEl = document.getElementById("id_grand_total");

    const isTaxEl = document.getElementById("id_is_tax");
    const isPphEl = document.getElementById("id_is_pph");
    const form    = document.querySelector("form");

    if (totalEl && taxEl && grandEl && isTaxEl && form) {
      function recalcHeader() {
        let total = parseID(totalEl.value);
        let tax = isTaxEl.checked ? total * 0.011 : 0;

        let pph = 0;
        if (pphEl && isPphEl) {
          pph = isPphEl.checked ? total * 0.02 : 0;
          pphEl.value = fmtID(pph);
        }

        let grand = total + tax - pph;

        totalEl.value = fmtID(total);
        taxEl.value   = fmtID(tax);
        grandEl.value = fmtID(grand);
      }

      taxEl.readOnly = true;
      if (pphEl) pphEl.readOnly = true;

      [totalEl, grandEl].forEach(function(el){
        el.addEventListener("focus", () => setTimeout(() => el.select(), 0));
      });

      totalEl.addEventListener("blur", recalcHeader);
      totalEl.addEventListener("change", recalcHeader);
      isTaxEl.addEventListener("change", recalcHeader);
      if (isPphEl) isPphEl.addEventListener("change", recalcHeader);

      recalcHeader();

      form.addEventListener("submit", function(){
        totalEl.value = parseID(totalEl.value);
        taxEl.value   = parseID(taxEl.value);
        if (pphEl) pphEl.value = parseID(pphEl.value);
        grandEl.value = parseID(grandEl.value);
      });
    }

    // ==========================================
    // B. JOB COST INLINE FORMSET (qty/price/amount)
    // ==========================================
    const prefix = "{{ cost_formset.prefix|default:'' }}";
    const totalFormsInput = prefix
      ? document.querySelector(`input[name="${prefix}-TOTAL_FORMS"]`)
      : null;

    const tbody = document.getElementById("jobcost-body");
    const addBtnMain = document.getElementById("btn-jobcost-add");
    const tpl = document.getElementById("jobcost-empty-row");

    if (prefix && totalFormsInput && tbody && addBtnMain && tpl) {

      function attachCalcToRow(row) {
        const qty    = row.querySelector(`input[name^="${prefix}-"][name$="-qty"]`);
        const price  = row.querySelector(`input[name^="${prefix}-"][name$="-price"]`);
        const amount = row.querySelector(`input[name^="${prefix}-"][name$="-amount"]`);
        if (!qty || !price || !amount) return;

        function recalcAmount() {
          const q = parseID(qty.value);
          const p = parseID(price.value);
          amount.value = fmtID(q * p);
        }

        qty.addEventListener("input", recalcAmount);
        price.addEventListener("input", recalcAmount);

        qty.addEventListener("blur", function () {
          qty.value = fmtID(parseID(qty.value));
          recalcAmount();
        });

        price.addEventListener("blur", function () {
          price.value = fmtID(parseID(price.value));
          recalcAmount();
        });

        recalcAmount();
      }

      function attachRemoveHandler(row) {
        const btn = row.querySelector(".remove-row");
        const delInput = row.querySelector(`input[name^="${prefix}-"][name$="-DELETE"]`);
        if (!btn || !delInput) return;

        btn.addEventListener("click", function () {
          delInput.checked = true;
          row.style.display = "none";
        });
      }

      // init semua row existing
      tbody.querySelectorAll(".jobcost-row").forEach(function (row) {
        attachCalcToRow(row);
        attachRemoveHandler(row);
        applyVendorNoteState(row);
      });

      // event delegation: category change (single)
      document.addEventListener("change", function (e) {
        const el = e.target;
        if (!el || !el.matches(`select[name^="${prefix}-"][name$="-category"]`)) return;
        const row = el.closest(".jobcost-row");
        if (row) applyVendorNoteState(row);
      });

      // tombol ADD ROW
      addBtnMain.addEventListener("click", function () {
        const index = parseInt(totalFormsInput.value, 10);
        const html = tpl.innerHTML.replace(/__prefix__/g, index);
        totalFormsInput.value = index + 1;

        tbody.insertAdjacentHTML("beforeend", html);
        const newRow = tbody.querySelector("tr.jobcost-row:last-child");
        if (!newRow) return;

        // default nilai row baru
        const qtyInput    = newRow.querySelector(`input[name^="${prefix}-"][name$="-qty"]`);
        const priceInput  = newRow.querySelector(`input[name^="${prefix}-"][name$="-price"]`);
        const amountInput = newRow.querySelector(`input[name^="${prefix}-"][name$="-amount"]`);

        if (qtyInput) qtyInput.value = "1,00";
        if (priceInput) priceInput.value = "0,00";
        if (amountInput) amountInput.value = "0,00";

        attachCalcToRow(newRow);
        attachRemoveHandler(newRow);
        applyVendorNoteState(newRow);
      });
    }

    // ==========================================
    // C. FLATPICKR JOB DATE
    // ==========================================
    if (typeof flatpickr === "undefined") {
      console.warn("Flatpickr belum ter-load");
      return;
    }

    const inputs = document.querySelectorAll(".js-jobdate");
    if (!inputs.length) return;

    inputs.forEach(function (el) {
      const fp = flatpickr(el, {
        dateFormat: "d-m-Y",
        allowInput: true,
        clickOpens: true,
        altInput: false,
        defaultDate: el.value || null,
        locale: { firstDayOfWeek: 1 }
      });

      el.addEventListener("focus", function () {
        fp.open();
      });
    });

  });

})();
</script>

{% endblock %}
