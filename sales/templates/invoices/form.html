{% extends "adminbase.html" %}
{% load indo_format %}
{% block content %}



 <div class="app-content-header">
    <div class="container-fluid d-flex justify-content-between align-items-center">
      <h4 class="card-title mb-0">
        Invoices
    </h4>
    <a class="btn btn-primary btn-sm" href="{% url 'sales:invoice_list' %}">Back</a>

    </div>
</div>

<div class="app-content">
  <div class="container-fluid">
    <form method="post" class="card-body" novalidate>
    {% csrf_token %}

    {% if form.non_field_errors %}
      <div class="alert alert-danger">{{ form.non_field_errors }}</div>
    {% endif %}
    {% if form.errors %}
      <div class="alert alert-danger">
        <div class="fw-semibold mb-1">Header error:</div>
        {{ form.errors }}
      </div>
    {% endif %}
    {% if formset.non_form_errors %}
      <div class="alert alert-danger">
        <div class="fw-semibold mb-1">Line error:</div>
        {{ formset.non_form_errors }}
      </div>
    {% endif %}

    <div class="card card-body mb-3" style="display:none">
      <h6 class="mb-3">Header</h6>

      <div class="row g-2">
        <div class="col-lg-6 mb-2">
          {{ form.customer.label_tag }}
          {{ form.customer }}
          {% if form.customer.errors %}<div class="text-danger small mt-1">{{ form.customer.errors|striptags }}</div>{% endif %}
        </div>

        <div class="col-lg-3 col-md-6 mb-2">
          {{ form.invoice_date.label_tag }}
          {{ form.invoice_date }}
          {% if form.invoice_date.errors %}<div class="text-danger small mt-1">{{ form.invoice_date.errors|striptags }}</div>{% endif %}
        </div>

        <div class="col-lg-3 col-md-6 mb-2">
          {{ form.due_date.label_tag }}
          {{ form.due_date }}
          {% if form.due_date.errors %}<div class="text-danger small mt-1">{{ form.due_date.errors|striptags }}</div>{% endif %}
        </div>

        <div class="col-lg-3 col-md-6 mb-2">
          {{ form.currency.label_tag }}
          {{ form.currency }}
          {% if form.currency.errors %}<div class="text-danger small mt-1">{{ form.currency.errors|striptags }}</div>{% endif %}
        </div>

        <div class="col-lg-3 col-md-6 mb-2">
          {{ form.payment_term.label_tag }}
          {{ form.payment_term }}
          {% if form.payment_term.errors %}<div class="text-danger small mt-1">{{ form.payment_term.errors|striptags }}</div>{% endif %}
        </div>

        <div class="col-lg-6 mb-2">
          {{ form.notes_customer.label_tag }}
          {{ form.notes_customer }}
          {% if form.notes_customer.errors %}<div class="text-danger small mt-1">{{ form.notes_customer.errors|striptags }}</div>{% endif %}
        </div>

        <div class="col-lg-6 mb-2">
          {{ form.notes_internal.label_tag }}
          {{ form.notes_internal }}
          {% if form.notes_internal.errors %}<div class="text-danger small mt-1">{{ form.notes_internal.errors|striptags }}</div>{% endif %}
        </div>
      </div>
    </div>

    {#-----------------------------------HEADER-------------------------------#}
    <div class="card card-body mb-3">
      <div class="row g-3">

        <!-- LEFT COLUMN -->
        <div class="col-lg-6">

          <div class="mb-3">
            {{ form.customer.label_tag }}
            {{ form.customer }}
            {% if form.customer.errors %}<div class="text-danger small mt-1">{{ form.customer.errors|striptags }}</div>{% endif %}
          </div>

          <div class="mb-3">
            {{ form.payment_term.label_tag }}
            {{ form.payment_term }}
            {% if form.payment_term.errors %}<div class="text-danger small mt-1">{{ form.payment_term.errors|striptags }}</div>{% endif %}
          </div>

          <div class="mb-0">
            {{ form.notes_customer.label_tag }}
            {{ form.notes_customer }}
            {% if form.notes_customer.errors %}<div class="text-danger small mt-1">{{ form.notes_customer.errors|striptags }}</div>{% endif %}
          </div>

        </div>

        <!-- RIGHT COLUMN -->
        <div class="col-lg-6">

  <div class="row g-3">

    <!-- INVOICE DATE -->
    <div class="col-md-6">
      <label class="form-label">{{ form.invoice_date.label }}</label>
      <div class="input-group input-group-sm">
        <span class="input-group-text">
          <i class="bi bi-calendar-event"></i>
        </span>
        {{ form.invoice_date }}
      </div>
      {% if form.invoice_date.errors %}
        <div class="text-danger small mt-1">
          {{ form.invoice_date.errors|striptags }}
        </div>
      {% endif %}
    </div>

    <!-- DUE DATE -->
    <div class="col-md-6">
      <label class="form-label">{{ form.due_date.label }}</label>
      <div class="input-group input-group-sm">
        <span class="input-group-text">
          <i class="bi bi-calendar-check"></i>
        </span>
        {{ form.due_date }}
      </div>
      {% if form.due_date.errors %}
        <div class="text-danger small mt-1">
          {{ form.due_date.errors|striptags }}
        </div>
      {% endif %}
    </div>

    <!-- CURRENCY -->
    <div class="col-md-6">
      {{ form.currency.label_tag }}
      {{ form.currency }}
      {% if form.currency.errors %}
        <div class="text-danger small mt-1">
          {{ form.currency.errors|striptags }}
        </div>
      {% endif %}
    </div>

    <div class="col-md-6">
      {# slot cadangan #}
    </div>

  </div>

  <!-- NOTES INTERNAL -->
  <div class="mt-3">
    {{ form.notes_internal.label_tag }}
    {{ form.notes_internal }}
    {% if form.notes_internal.errors %}
      <div class="text-danger small mt-1">
        {{ form.notes_internal.errors|striptags }}
      </div>
    {% endif %}
  </div>

</div>

      </div>
    </div>

    
    {#------------------------------END OF HEADER-------------------------------#}
    <div class="card card-body mb-3">

      {{ formset.management_form }}

      <div class="table-responsive">
        <table class="table table-sm align-middle">
          <thead>
            <tr>
              <th>Product (Services)</th>
              <th class="text-end" style="width: 120px;">Qty</th>
              <th class="text-end" style="width: 140px;">Price</th>
              <th style="width: 300px;">Taxes</th>
              <th class="text-end" style="width: 170px;">Amount</th>
              <th class="text-center" style="width: 80px;">Del</th>
            </tr>
          </thead>
          <tbody id="linesBody">
  {% for lf in formset.forms %}
    {% if formset.is_bound or lf.instance.pk %}
    <tr class="line-row">
      <td>
        {{ lf.id }}
        {{ lf.description }}
        {% if lf.description.errors %}
          <div class="text-danger small mt-1">
            {{ lf.description.errors|striptags }}
          </div>
        {% endif %}
      </td>

      <td class="text-end">
        {{ lf.quantity }}
        {% if lf.quantity.errors %}
          <div class="text-danger small mt-1 text-start">
            {{ lf.quantity.errors|striptags }}
          </div>
        {% endif %}
      </td>

      <td class="text-end">
        {{ lf.price }}
        {% if lf.price.errors %}
          <div class="text-danger small mt-1 text-start">
            {{ lf.price.errors|striptags }}
          </div>
        {% endif %}
      </td>

      <td>
        <div class="small">
          {{ lf.taxes }}
        </div>
        {% if lf.taxes.errors %}
          <div class="text-danger small mt-1">
            {{ lf.taxes.errors|striptags }}
          </div>
        {% endif %}
      </td>

      <td class="text-end">
        <span class="js-row-amount">0,00</span>
      </td>

      <!-- DELETE COLUMN (FINAL) -->
      <td class="text-center">
        {% if lf.DELETE %}
          <span class="d-none">{{ lf.DELETE }}</span>
        {% endif %}
        <a href="javascript:void(0)"
           class="text-danger small btnRemoveLine"
           title="Remove">
          <i class="fa fa-trash"></i>
        </a>
      </td>
    </tr>
    {% endif %}
  {% endfor %}
</tbody>

        </table>
      </div>

      {# ===== empty_form template for Add Line (works even when no row exists) ===== #}
      <script type="text/template" id="lineEmptyTemplate">
  <tr class="line-row">
    <td>
      {{ formset.empty_form.id }}
      {{ formset.empty_form.description }}
    </td>

    <td class="text-end">
      {{ formset.empty_form.quantity }}
    </td>

    <td class="text-end">
      {{ formset.empty_form.price }}
    </td>

    <td>
      <div class="small">
        {{ formset.empty_form.taxes }}
      </div>
    </td>

    <td class="text-end">
      <span class="js-row-amount">0,00</span>
    </td>

    <!-- DELETE COLUMN -->
    <td class="text-center">
      <a href="javascript:void(0)"
         class="text-danger small btnRemoveLine"
         title="Remove">
        <i class="fa fa-trash"></i>
      </a>
    </td>
  </tr>
</script>

      <div class="d-flex justify-content-between align-items-start mt-2">
        <!-- LEFT: Add line -->
        <div>
          <a href="javascript:void(0)" id="btnAddLine" class="text-primary text-decoration-none small">
            <i class="fa fa-plus me-1"></i> Add line
          </a>
        </div>

        <!-- RIGHT: SUMMARY (SINGLE, ALIGNED) -->
        <div class="ux-summary">
          <div class="ux-sum-row">
            <div class="ux-sum-label small text-muted">Sub Total</div>
            <div class="ux-sum-val">
              <input type="text"
                     id="ux_subtotal"
                     class="form-control form-control-sm text-end"
                     value="0,00"
                     readonly>
            </div>
          </div>

          <div id="taxLinesWrap" style="display:none;">
            <div id="taxLinesList"></div>
          </div>

          <div class="ux-sum-row ux-sum-total">
            <div class="ux-sum-label small text-muted fw-semibold">Total</div>
            <div class="ux-sum-val">
              <input type="text"
                     id="ux_total"
                     class="form-control form-control-sm text-end fw-semibold"
                     value="0,00"
                     readonly>
            </div>
          </div>
        </div>
        <!-- END SUMMARY -->
      </div>

      <div class="text-muted small mt-2">
        * Amount otomatis = qty × price (JS). Server tetap recalc saat Save.
      </div>
    </div>

    <div class="d-flex gap-2">
      <a class="btn btn-outline-secondary btn-sm" href="{% url 'sales:invoice_list' %}">Back</a>
      <button class="btn btn-primary btn-sm" type="submit">Save</button>
    </div>

    </form>

  </div>
</div>

{% endblock %}

{% block extra_css %}
<style>
  table .form-control, table .form-select {
    border: none !important;
    box-shadow: none;
  }
  table tr td { padding: 0; }
  table tr th {
    background: #f4f4f4;
    padding: 5px 10px !important;
  }

  /* ===== SUMMARY ALIGNMENT (FINAL) ===== */
  .ux-summary{
    min-width: 320px;
    max-width: 420px;
    margin-left: auto;
  }
  /* label kiri (rata kanan) + kolom angka kanan (fixed 170px) */
  .ux-sum-row, .ux-tax-row{
    display: grid;
    grid-template-columns: 1fr 170px; /* harus sama dengan lebar kolom angka */
    align-items: center;
    column-gap: .5rem;
    margin-bottom: .25rem;
  }
  .ux-sum-label{
    text-align: right;
    padding-right: .25rem;
  }
  .ux-sum-val input{
    width: 100%;
  }
  .ux-sum-total{
    border-top: 1px solid #dee2e6;
    padding-top: .25rem;
    margin-top: .25rem;
  }
</style>
{% endblock %}

{% block extra_js %}

<script>
document.addEventListener("DOMContentLoaded", function () {
  const linesBody  = document.getElementById("linesBody");
  const btnAdd     = document.getElementById("btnAddLine");
  const tpl        = document.getElementById("lineEmptyTemplate");
  const totalForms = document.querySelector('input[name$="-TOTAL_FORMS"]');

  // display totals (UX only)
  const uxSubEl   = document.getElementById("ux_subtotal");
  const uxTotalEl = document.getElementById("ux_total");
  const formEl = document.querySelector("form");

  // hidden real fields (kalau masih ada di form) - tetap aman
  const subEl   = document.getElementById("id_subtotal_amount") || document.querySelector('[name="subtotal_amount"]');
  const taxEl   = document.getElementById("id_tax_amount")      || document.querySelector('[name="tax_amount"]');
  const totalEl = document.getElementById("id_total_amount")    || document.querySelector('[name="total_amount"]');

  // =========================
  // PARSER ANGKA (AMAN)
  // - "1.000,00" -> 1000.00
  // - "1,00"     -> 1.00
  // - "1.00"     -> 1.00   (PENTING: titik dianggap DESIMAL jika tidak ada koma)
  // =========================
  function toNum(val) {
    if (val === null || val === undefined) return 0;
    let s = String(val).trim();
    if (!s) return 0;

    // jika ada koma => format Indonesia: 1.234,56
    if (s.includes(",")) {
      s = s.replace(/\s+/g, "");
      s = s.replace(/\./g, "").replace(",", ".");
      const n = parseFloat(s);
      return isNaN(n) ? 0 : n;
    }

    // jika tidak ada koma => format standar/backend: 1234.56 (titik = desimal)
    const n = parseFloat(s);
    return isNaN(n) ? 0 : n;
  }

  function fmtID(n) {
    n = Number(n || 0);
    const fixed = n.toFixed(2);
    let [a, b] = fixed.split(".");
    a = a.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    return a + "," + b;
  }

  function setInputFormatted(el) {
    if (!el) return;
    el.value = fmtID(toNum(el.value));
  }

  // ✅ Paksa semua qty/price yang SUDAH ADA (row edit/row awal) jadi text + js-num
  if (linesBody) {
    linesBody.querySelectorAll('input[name$="-quantity"], input[name$="-price"]').forEach(function (el) {
      el.type = "text";
      el.classList.add("js-num");
      el.setAttribute("inputmode", "decimal");
      el.setAttribute("autocomplete", "off");

      if (!el.value) el.value = "0,00";
      setInputFormatted(el);
    });
  }

  function getRateFromLabel(text) {
    const m = String(text || "").match(/(\d+(?:[.,]\d+)?)\s*%/);
    if (!m) return 0;
    return parseFloat(m[1].replace(",", ".")) || 0;
  }

  function recalcRow(tr) {
    const qtyEl   = tr.querySelector('input[name$="-quantity"]');
    const priceEl = tr.querySelector('input[name$="-price"]');
    const amtSpan = tr.querySelector(".js-row-amount");

    const qty    = toNum(qtyEl ? qtyEl.value : 0);
    const price  = toNum(priceEl ? priceEl.value : 0);
    const amount = qty * price;

    if (amtSpan) amtSpan.textContent = fmtID(amount);
    return amount;
  }

  function recalcTotals() {
    let subtotal = 0;
    let taxTotal = 0;

    const taxMap = {};
    const rows = linesBody ? linesBody.querySelectorAll("tr.line-row") : [];

    rows.forEach(tr => {
      const del = tr.querySelector('input[type="checkbox"][name$="-DELETE"]');
      if (del && del.checked) return;

      const amount = recalcRow(tr);
      subtotal += amount;

      const checks = tr.querySelectorAll('input[type="checkbox"][name$="-taxes"]:checked');
      checks.forEach(cb => {
        const labelEl  = tr.querySelector('label[for="' + cb.id + '"]');
        const taxLabel = labelEl ? labelEl.textContent.trim() : "";
        const rate     = getRateFromLabel(taxLabel);
        const taxAmt   = (amount * rate / 100.0);

        if (taxLabel) taxMap[taxLabel] = (taxMap[taxLabel] || 0) + taxAmt;
        taxTotal += taxAmt;
      });
    });

    // DISPLAY totals (UX)
    if (uxSubEl)   uxSubEl.value   = fmtID(subtotal);
    if (uxTotalEl) uxTotalEl.value = fmtID(subtotal + taxTotal);

    // hidden real fields (backend safe number)
    if (subEl)   subEl.value   = (subtotal || 0).toFixed(2);
    if (taxEl)   taxEl.value   = (taxTotal || 0).toFixed(2);
    if (totalEl) totalEl.value = ((subtotal + taxTotal) || 0).toFixed(2);

    // render tax lines (aligned)
    const wrap = document.getElementById("taxLinesWrap");
    const list = document.getElementById("taxLinesList");
    if (!wrap || !list) return;

    const keys = Object.keys(taxMap);
    if (subtotal <= 0 || taxTotal <= 0 || keys.length === 0) {
      wrap.style.display = "none";
      list.innerHTML = "";
      return;
    }

    keys.sort((a, b) => getRateFromLabel(a) - getRateFromLabel(b));

    wrap.style.display = "";
    list.innerHTML = keys.map(k => {
      const label = (/^tax\b/i.test(k)) ? k : ("Tax " + k);
      return `
        <div class="ux-tax-row">
          <div class="ux-sum-label small text-muted">${label}</div>
          <div class="ux-sum-val">
            <input type="text"
                   class="form-control form-control-sm text-end"
                   readonly
                   value="${fmtID(taxMap[k])}">
          </div>
        </div>
      `;
    }).join("");
  }

  // ✅ blok input '.' supaya user tidak bikin "1.00" (yang sering bikin jadi 100)
  if (linesBody) {
    linesBody.addEventListener("keydown", function(e){
      const el = e.target;
      if (!el.classList || !el.classList.contains("js-num")) return;
      if (e.key === ".") e.preventDefault();
    });
  }

  // select all on focus
  document.addEventListener("focusin", function (e) {
    const el = e.target;
    if (el && el.classList && el.classList.contains("js-num")) {
      try { el.select(); } catch (_) {}
    }
  });

  // format on blur
  document.addEventListener("blur", function (e) {
    const el = e.target;
    if (el && el.classList && el.classList.contains("js-num")) {
      setInputFormatted(el);
      recalcTotals();
    }
  }, true);

  // live recalc
  if (linesBody) {
    linesBody.addEventListener("input", function (e) {
      const tr = e.target.closest("tr.line-row");
      if (!tr) return;
      if (e.target.name && (e.target.name.endsWith("-quantity") || e.target.name.endsWith("-price"))) {
        recalcTotals();
      }
    });

    linesBody.addEventListener("change", function (e) {
      const tr = e.target.closest("tr.line-row");
      if (!tr) return;
      if (e.target.matches('input[type="checkbox"][name$="-taxes"], input[type="checkbox"][name$="-DELETE"]')) {
        recalcTotals();
      }
    });

    // ✅ delete: existing row → check DELETE & hide; new row → remove
    linesBody.addEventListener("click", function (e) {
      const btn = e.target.closest(".btnRemoveLine");
      if (!btn) return;

      const row = btn.closest("tr.line-row");
      if (!row) return;

      const delInput = row.querySelector('input[type="checkbox"][name$="-DELETE"]');
      if (delInput) {
        delInput.checked = true;
        row.style.display = "none";
      } else {
        row.remove();
      }
      recalcTotals();
    });
  }

  // Add line
  if (btnAdd && tpl && totalForms) {
    btnAdd.addEventListener("click", function () {
      const idx  = parseInt(totalForms.value || "0", 10);
      const html = tpl.innerHTML.replace(/__prefix__/g, String(idx));

      const temp = document.createElement("tbody");
      temp.innerHTML = html.trim();
      const row = temp.firstElementChild;
      if (!row) return;

      const qtyEl   = row.querySelector('input[name$="-quantity"]');
      const priceEl = row.querySelector('input[name$="-price"]');

      if (qtyEl) {
        qtyEl.type = "text";
        qtyEl.classList.add("js-num");
        qtyEl.value = "0,00";
        qtyEl.setAttribute("inputmode", "decimal");
        qtyEl.setAttribute("autocomplete", "off");
      }
      if (priceEl) {
        priceEl.type = "text";
        priceEl.classList.add("js-num");
        priceEl.value = "0,00";
        priceEl.setAttribute("inputmode", "decimal");
        priceEl.setAttribute("autocomplete", "off");
      }

      linesBody.appendChild(row);
      totalForms.value = String(idx + 1);

      if (qtyEl)   setInputFormatted(qtyEl);
      if (priceEl) setInputFormatted(priceEl);

      recalcTotals();

      const descEl = row.querySelector('input[name$="-description"], textarea[name$="-description"]');
      if (descEl) descEl.focus();
    });
  }

  // ✅ Sebelum submit: kirim angka format backend "1000.00" (bukan "1.000,00")

  // ✅ SUPER-FINAL: intercept submit (capture), cegah script lain, convert, lalu submit native
if (formEl) {
  let submitting = false;

  formEl.addEventListener("submit", function (e) {
    if (submitting) return;

    // stop semua submit handler lain
    e.preventDefault();
    e.stopImmediatePropagation();

    // convert qty/price jadi backend number (1,00 -> 1.00)
    if (linesBody) {
      linesBody.querySelectorAll('input[name$="-quantity"], input[name$="-price"]').forEach(function (el) {
        el.value = (toNum(el.value) || 0).toFixed(2);
      });
    }
    console.log("SENT qty/price:", [...linesBody.querySelectorAll('input[name$="-quantity"], input[name$="-price"]')].map(i => [i.name, i.value]));

    // kirim TANPA memicu event submit lagi
    submitting = true;
    formEl.submit();
  }, true); // <-- CAPTURE PHASE (penting)
}


  // init
  document.querySelectorAll("input.js-num").forEach(el => setInputFormatted(el));
  recalcTotals();
});
</script>



{% endblock %}
