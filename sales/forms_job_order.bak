# sales/forms_job_order.py
from decimal import Decimal, InvalidOperation

from django import forms

from .job_order_model import JobOrder
from .models import Customer  # proxy Partner yg sudah difilter role=customer


class JobOrderForm(forms.ModelForm):
    """
    Form header Job Order:
    - total_amount, tax_amount, grand_total pakai input string (format Indonesia)
    - tax_amount dihitung otomatis saat is_tax=True
    """

    # override: biar bisa pakai "1.000.000,00" di input
    total_amount = forms.CharField(required=False)
    tax_amount = forms.CharField(required=False)
    grand_total = forms.CharField(required=False)

    class Meta:
        model = JobOrder
        fields = "__all__"
        # tidak tampil di form:
        # - created, modified dari TimeStampedModel
        # - sales_user diisi otomatis dari request.user
        # - is_pph, pph_amount untuk kebutuhan mendatang
        exclude = ["number","created", "modified", "sales_user", "is_pph", "pph_amount","curs_idr","total_in_idr"]

        widgets = {
            "job_date": forms.DateInput(
                attrs={"type": "date", "class": "form-control form-control-sm"}
            ),

            "order_number": forms.TextInput(
                attrs={"class": "form-control form-control-sm"}
            ),

            "service": forms.Select(attrs={"class": "form-select form-select-sm"}),
            "customer": forms.Select(attrs={"class": "form-select form-select-sm"}),

            "cargo_description": forms.TextInput(
                attrs={"class": "form-control form-control-sm"}
            ),
            "quantity": forms.NumberInput(
                attrs={"class": "form-control form-control-sm", "step": "0.01"}
            ),
            "pickup": forms.TextInput(attrs={"class": "form-control form-control-sm"}),
            "delivery": forms.TextInput(attrs={"class": "form-control form-control-sm"}),
            "pic": forms.TextInput(attrs={"class": "form-control form-control-sm"}),

            "payment_term": forms.Select(attrs={"class": "form-select form-select-sm"}),
            "currency": forms.Select(attrs={"class": "form-select form-select-sm"}),

            "remarks_internal": forms.Textarea(
                attrs={"class": "form-control form-control-sm", "rows": 3}
            ),

            "is_tax": forms.CheckboxInput(attrs={"class": "form-check-input"}),

            # angka: text + rata kanan
            "total_amount": forms.TextInput(
                attrs={"class": "form-control form-control-sm text-end"}
            ),
            "tax_amount": forms.TextInput(
                attrs={
                    "class": "form-control form-control-sm text-end",
                    "readonly": "readonly",
                    "tabindex": "-1",
                }
            ),
            "grand_total": forms.TextInput(
                attrs={"class": "form-control form-control-sm text-end"}
            ),
        }

    def __init__(self, *args, **kwargs):
        super().__init__(*args, **kwargs)

        # Limit customer → hanya yang role=customer (via proxy Customer)
        try:
            self.fields["customer"].queryset = Customer.objects.all().order_by("name")
        except Exception:
            # fallback kalau proxy belum ada / error
            pass

        # styling massal (kalau ada field tambahan di masa depan)
        for name, field in self.fields.items():
            widget = field.widget
            if isinstance(widget, forms.CheckboxInput):
                widget.attrs.setdefault("class", "form-check-input")
            elif isinstance(widget, forms.Select):
                widget.attrs.setdefault("class", "form-select form-select-sm")
            else:
                css = widget.attrs.get("class", "")
                if "form-control" not in css:
                    widget.attrs["class"] = (css + " form-control form-control-sm").strip()
                # angka rata kanan
                if name in ("total_amount", "tax_amount", "grand_total"):
                    if "text-end" not in widget.attrs["class"]:
                        widget.attrs["class"] += " text-end"

        # default angka 0,00 untuk form baru
        if not self.instance.pk and not self.is_bound:
            self.initial.setdefault("total_amount", "0,00")
            self.initial.setdefault("tax_amount", "0,00")
            self.initial.setdefault("grand_total", "0,00")

        # kalau edit & instance sudah punya nilai, bisa format di sini kalau mau
        # untuk sekarang biarkan apa adanya, formatting biasa pakai filter di template

    # ============== helper angka Indonesia ==============

    def _parse_id_decimal(self, value_str, field_label="angka"):
        """
        Ubah string format Indonesia '1.000.000,00' -> Decimal('1000000.00')
        """
        if value_str in (None, ""):
            return Decimal("0")

        s = str(value_str).strip()
        s = s.replace(" ", "")
        # hilangkan pemisah ribuan titik, koma → titik desimal
        s = s.replace(".", "").replace(",", ".")

        try:
            return Decimal(s)
        except InvalidOperation:
            raise forms.ValidationError(
                f"Format {field_label} tidak valid. Gunakan contoh: 1.000,00"
            )

    # ============== clean utama ==============

    def clean(self):
        cleaned = super().clean()

        total_raw = cleaned.get("total_amount") or ""
        is_tax = cleaned.get("is_tax") or False

        # parse total ke Decimal
        total = self._parse_id_decimal(total_raw, field_label="Total Amount")

        # hitung tax 1.1% kalau dicentang
        if is_tax:
            tax = (total * Decimal("0.011")).quantize(Decimal("0.01"))
        else:
            tax = Decimal("0.00")

        grand = (total + tax).quantize(Decimal("0.01"))

        # simpan ke cleaned_data sebagai Decimal → cocok dengan field Decimal di model
        cleaned["total_amount"] = total
        cleaned["tax_amount"] = tax
        cleaned["grand_total"] = grand

        return cleaned
